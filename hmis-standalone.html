<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Horizon Sanjeevani Clinic - HMIS</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
        }
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .table th {
            background: #f9fafb;
            font-weight: 600;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        .badge-green {
            background: #d1fae5;
            color: #065f46;
        }
        .badge-blue {
            background: #dbeafe;
            color: #1e40af;
        }
        .badge-yellow {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-red {
            background: #fee2e2;
            color: #991b1b;
        }
        .badge-pink {
            background: #fce7f3;
            color: #be185d;
        }
        .badge-purple {
            background: #ede9fe;
            color: #7c3aed;
        }
        .badge-orange {
            background: #fed7aa;
            color: #c2410c;
        }
        .badge-gray {
            background: #f3f4f6;
            color: #374151;
        }
        .btn-success {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        .btn-info {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-info:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API utilities with fallback to localStorage
        let serverAvailable = false;
        let syncInProgress = false;
        // Configurable backend base URL (change via window.BACKEND_BASE or localStorage BACKEND_BASE)
        const BACKEND_BASE = (
            (typeof window !== 'undefined' && window.BACKEND_BASE) ||
            localStorage.getItem('BACKEND_BASE') ||
            'http://localhost:5000'
        ).replace(/\/$/, '');

        // Throttled health check (reduces rapid repeated calls)
        let lastHealthCheckTime = 0;
        let lastHealthCheckResult = false;
        const HEALTH_CHECK_MIN_INTERVAL = 15000; // 15 seconds
        const checkServerHealth = async (force = false) => {
            const now = Date.now();
            if (!force && (now - lastHealthCheckTime) < HEALTH_CHECK_MIN_INTERVAL) {
                return lastHealthCheckResult; // return cached
            }
            lastHealthCheckTime = now;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                const response = await fetch(`${BACKEND_BASE}/api/health`, { method: 'GET', signal: controller.signal });
                clearTimeout(timeoutId);
                lastHealthCheckResult = response.ok;
                return lastHealthCheckResult;
            } catch (error) {
                console.warn('Health check failed:', error.message);
                lastHealthCheckResult = false;
                return false;
            }
        };

    const apiRequest = async (url, options = {}) => {
            try {
        const response = await fetch(`${BACKEND_BASE}${url}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.warn('API request failed, using localStorage:', error);
                throw error;
            }
        };

        // Enhanced sync mechanism
        const syncOfflineDataToServer = async () => {
            if (syncInProgress) return;
            syncInProgress = true;
            
            try {
                console.log('Starting offline data sync...');
                // First process any pending patient deletions queued while offline
                try {
                    const pendingDeletes = loadFromStorage('deleted_usns', []);
                    if (serverAvailable && Array.isArray(pendingDeletes) && pendingDeletes.length > 0) {
                        const remaining = [];
                        for (const usn of pendingDeletes) {
                            try {
                                await apiRequest(`/api/patients/${encodeURIComponent(usn)}`, { method: 'DELETE' });
                                console.log(`Deleted patient ${usn} on server`);
                            } catch (e) {
                                console.warn(`Failed to delete patient ${usn} on server; will retry later`, e);
                                remaining.push(usn);
                            }
                        }
                        saveToStorage('deleted_usns', remaining);
                    }
                } catch (e) { console.warn('Error processing pending deletions', e); }
                
                // Get all offline data and create backup
                const offlinePatients = loadFromStorage('patients', []);
                const offlineVitals = loadFromStorage('vitals', []);
                const offlinePrescriptions = loadFromStorage('prescriptions', []);
                const offlineCaseReports = loadFromStorage('caseReports', []);
                const offlineSickIntimations = loadFromStorage('sickIntimations', []);

                // Create backup before sync
                if (offlinePatients.length > 0 || offlineVitals.length > 0 || offlinePrescriptions.length > 0 || 
                    offlineCaseReports.length > 0 || offlineSickIntimations.length > 0) {
                    console.log('Creating backup of offline data...');
                    saveToStorage('backup_patients', offlinePatients);
                    saveToStorage('backup_vitals', offlineVitals);
                    saveToStorage('backup_prescriptions', offlinePrescriptions);
                    saveToStorage('backup_caseReports', offlineCaseReports);
                    saveToStorage('backup_sickIntimations', offlineSickIntimations);
                    saveToStorage('backup_timestamp', new Date().toISOString());
                }

                let syncResults = {
                    patients: { synced: 0, total: 0 },
                    vitals: { synced: 0, total: 0 },
                    prescriptions: { synced: 0, total: 0 },
                    caseReports: { synced: 0, total: 0 },
                    sickIntimations: { synced: 0, total: 0 }
                };

                // Bulk sync patients
                                if (offlinePatients.length > 0) {
                    try {
                                                // Normalize patients to avoid NULLs on NOT NULL DB columns
                                                const normalizedPatients = offlinePatients
                                                    .map(p => {
                                                        const usn = (p.usn ?? '').toString().trim();
                                                        const fullName = (p.fullName ?? p.full_name ?? '').toString().trim();
                                                        const ageNum = Number(p.age);
                                                        const age = Number.isFinite(ageNum) ? ageNum : 0;
                                                        const gender = (p.gender ?? 'Unknown').toString().trim() || 'Unknown';
                                                        const phone = ((p.contact ?? p.phone ?? '') + '').trim();
                                                        const address = ((p.address ?? '') + '').trim();
                                                        return { ...p, usn, fullName, age, gender, contact: phone, phone, address };
                                                    })
                                                    // Skip clearly invalid entries missing identifiers
                                                    .filter(p => p.usn && p.fullName);

                                                const result = await apiRequest('/api/sync/patients', {
                            method: 'POST',
                                                        body: JSON.stringify(normalizedPatients)
                        });
                        syncResults.patients = {
                            synced: result.synced_count,
                            total: result.total_received
                        };
                        console.log(`Bulk synced ${result.synced_count}/${result.total_received} patients`);
                    } catch (error) {
                        console.warn('Failed to bulk sync patients:', error);
                        // Fallback to individual sync
                                                for (const raw of offlinePatients) {
                                                        const patient = (() => {
                                                                const usn = (raw.usn ?? '').toString().trim();
                                                                const fullName = (raw.fullName ?? raw.full_name ?? '').toString().trim();
                                                                const ageNum = Number(raw.age);
                                                                const age = Number.isFinite(ageNum) ? ageNum : 0;
                                                                const gender = (raw.gender ?? 'Unknown').toString().trim() || 'Unknown';
                                                                const phone = ((raw.contact ?? raw.phone ?? '') + '').trim();
                                                                const address = ((raw.address ?? '') + '').trim();
                                                                return { ...raw, usn, fullName, age, gender, contact: phone, phone, address };
                                                        })();
                            try {
                                await apiRequest('/api/patients', {
                                    method: 'POST',
                                    body: JSON.stringify(patient)
                                });
                                syncResults.patients.synced++;
                            } catch (err) {
                                console.warn(`Failed to sync patient ${patient.fullName}:`, err);
                            }
                        }
                        syncResults.patients.total = offlinePatients.length;
                    }
                }

                // Bulk sync vitals
                if (offlineVitals.length > 0) {
                    try {
                        const result = await apiRequest('/api/sync/vitals', {
                            method: 'POST',
                            body: JSON.stringify(offlineVitals)
                        });
                        syncResults.vitals = {
                            synced: result.synced_count,
                            total: result.total_received
                        };
                        console.log(`Bulk synced ${result.synced_count}/${result.total_received} vitals`);
                    } catch (error) {
                        console.warn('Failed to bulk sync vitals:', error);
                        // Fallback to individual sync
                        for (const vital of offlineVitals) {
                            try {
                                await apiRequest('/api/vitals', {
                                    method: 'POST',
                                    body: JSON.stringify(vital)
                                });
                                syncResults.vitals.synced++;
                            } catch (err) {
                                console.warn(`Failed to sync vitals for USN ${vital.usn}:`, err);
                            }
                        }
                        syncResults.vitals.total = offlineVitals.length;
                    }
                }

                // Bulk sync prescriptions
                if (offlinePrescriptions.length > 0) {
                    try {
                        const result = await apiRequest('/api/sync/prescriptions', {
                            method: 'POST',
                            body: JSON.stringify(offlinePrescriptions)
                        });
                        syncResults.prescriptions = {
                            synced: result.synced_count,
                            total: result.total_received
                        };
                        console.log(`Bulk synced ${result.synced_count}/${result.total_received} prescriptions`);
                    } catch (error) {
                        console.warn('Failed to bulk sync prescriptions:', error);
                        // Fallback to individual sync
                        for (const prescription of offlinePrescriptions) {
                            try {
                                await apiRequest('/api/prescriptions', {
                                    method: 'POST',
                                    body: JSON.stringify(prescription)
                                });
                                syncResults.prescriptions.synced++;
                            } catch (err) {
                                console.warn(`Failed to sync prescription for USN ${prescription.usn}:`, err);
                            }
                        }
                        syncResults.prescriptions.total = offlinePrescriptions.length;
                    }
                }

                // Bulk sync case reports
                if (offlineCaseReports.length > 0) {
                    try {
                        const result = await apiRequest('/api/sync/case-reports', {
                            method: 'POST',
                            body: JSON.stringify(offlineCaseReports)
                        });
                        syncResults.caseReports = {
                            synced: result.synced_count,
                            total: result.total_received
                        };
                        console.log(`Bulk synced ${result.synced_count}/${result.total_received} case reports`);
                    } catch (error) {
                        console.warn('Failed to bulk sync case reports:', error);
                        // Fallback to individual sync
                        for (const caseReport of offlineCaseReports) {
                            try {
                                await apiRequest('/api/case-reports', {
                                    method: 'POST',
                                    body: JSON.stringify(caseReport)
                                });
                                syncResults.caseReports.synced++;
                            } catch (err) {
                                console.warn(`Failed to sync case report ${caseReport.reportNumber}:`, err);
                            }
                        }
                        syncResults.caseReports.total = offlineCaseReports.length;
                    }
                }

                // Bulk sync sick intimations
                if (offlineSickIntimations.length > 0) {
                    try {
                        const result = await apiRequest('/api/sync/sick-intimations', {
                            method: 'POST',
                            body: JSON.stringify(offlineSickIntimations)
                        });
                        syncResults.sickIntimations = {
                            synced: result.synced_count,
                            total: result.total_received
                        };
                        console.log(`Bulk synced ${result.synced_count}/${result.total_received} sick intimations`);
                    } catch (error) {
                        console.warn('Failed to bulk sync sick intimations:', error);
                        // Fallback to individual sync
                        for (const sickIntimation of offlineSickIntimations) {
                            try {
                                await apiRequest('/api/sick-intimations', {
                                    method: 'POST',
                                    body: JSON.stringify(sickIntimation)
                                });
                                syncResults.sickIntimations.synced++;
                            } catch (err) {
                                console.warn(`Failed to sync sick intimation ${sickIntimation.intimationNumber}:`, err);
                            }
                        }
                        syncResults.sickIntimations.total = offlineSickIntimations.length;
                    }
                }

                console.log('Offline data sync completed!', syncResults);
                
                // Only update sync timestamp if data was actually synced
                if (syncResults.patients.synced > 0 || syncResults.vitals.synced > 0 || syncResults.prescriptions.synced > 0 ||
                    syncResults.caseReports.synced > 0 || syncResults.sickIntimations.synced > 0) {
                    localStorage.setItem('lastSyncTime', new Date().toISOString());
                    localStorage.removeItem('needsSync');
                    console.log(`✅ Sync Complete: ${syncResults.patients.synced} patients, ${syncResults.vitals.synced} vitals, ${syncResults.prescriptions.synced} prescriptions, ${syncResults.caseReports.synced} case reports, ${syncResults.sickIntimations.synced} sick intimations synced to server`);
                } else {
                    console.log('No new data to sync');
                }
                
            } catch (error) {
                console.error('Error during offline data sync:', error);
            } finally {
                syncInProgress = false;
            }
        };

        const syncWithDatabase = async (endpoint, data, method = 'POST') => {
            try {
                console.log(`Syncing to database: ${endpoint}`, data);
                
                // Check if server is available first
                if (!serverAvailable) {
                    console.log('Server not available, skipping sync');
                    return false;
                }
                
                const response = await apiRequest(`/api/${endpoint}`, {
                    method,
                    body: JSON.stringify(data)
                });
                console.log(`Data synced successfully to database: ${endpoint}`, response);
                return true;
            } catch (error) {
                console.error(`Failed to sync to database: ${endpoint}`, error);
                console.error('Data that failed to sync:', data);
                console.error('Error details:', error.message);
                
                // Check if it's a server connection issue
                if (error.message.includes('Failed to fetch') || error.message.includes('Network request failed')) {
                    console.log('Network error detected, marking server as unavailable');
                    serverAvailable = false;
                }
                
                return false;
            }
        };

        // Monitor server connection and auto-sync
        const monitorServerConnection = async () => {
            const wasOffline = !serverAvailable;
            serverAvailable = await checkServerHealth();
            
            console.log(`Server health check: ${serverAvailable ? 'Online' : 'Offline'}`);
            
            // If server just came online, sync offline data
            if (wasOffline && serverAvailable) {
                console.log('Server is back online! Starting data sync...');
                await syncOfflineDataToServer();
            }
        };

        // Start monitoring server connection
        setInterval(monitorServerConnection, 10000); // Check every 10 seconds
        monitorServerConnection(); // Initial check

        // Storage utilities
        const saveToStorage = (key, data) => {
            localStorage.setItem(key, JSON.stringify(data));
        };

        const loadFromStorage = (key, defaultValue) => {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultValue;
            } catch {
                return defaultValue;
            }
        };

        // Merge arrays utility - prioritizes newer data based on timestamps and local modifications
        const mergeArrays = (localArray, serverArray, keyField) => {
            const merged = [];
            const processedKeys = new Set();
            
            // Create a map of server items for quick lookup
            const serverMap = new Map();
            serverArray.forEach(item => {
                serverMap.set(item[keyField], item);
            });
            
            // Get locally modified items that should not be overwritten
            const locallyModified = loadFromStorage('locallyModified_prescriptions', []);
            const recentlyModified = locallyModified.filter(id => {
                const modTime = loadFromStorage(`modTime_${id}`, 0);
                return (Date.now() - modTime) < 300000; // Extended to 5 minutes protection
            });
            
            console.log('Recently modified prescriptions (protected from server override):', recentlyModified);
            
            // Process local items first (they might have newer updates)
            localArray.forEach(localItem => {
                const key = localItem[keyField];
                const serverItem = serverMap.get(key);
                const isRecentlyModified = recentlyModified.includes(key);
                
                if (serverItem) {
                    // Both exist - check if locally modified recently
                    if (isRecentlyModified) {
                        merged.push(localItem);
                        console.log(`🛡️ PROTECTED: Local modification for ${keyField}: ${key} (recently modified locally)`);
                    } else {
                        // Additional check: if prescription status was manually changed, prioritize local
                        const isStatusChange = localItem.status !== serverItem.status && 
                                             (localItem.status === 'Completed' || localItem.status === 'Active');
                        
                        if (isStatusChange) {
                            merged.push(localItem);
                            console.log(`🔒 STATUS PROTECTION: Using local status for ${keyField}: ${key} (status: ${localItem.status})`);
                        } else {
                            // Compare timestamps to decide which is newer
                            const localTimestamp = localItem.updatedAt || localItem.prescribedAt || localItem.createdAt || 0;
                            const serverTimestamp = serverItem.updatedAt || serverItem.prescribedAt || serverItem.createdAt || 0;
                            
                            // Use local version if it's newer or if timestamps are equal (local takes precedence)
                            if (localTimestamp >= serverTimestamp) {
                                merged.push(localItem);
                                console.log(`Using local version of ${keyField}: ${key} (local: ${localTimestamp}, server: ${serverTimestamp})`);
                            } else {
                                merged.push(serverItem);
                                console.log(`Using server version of ${keyField}: ${key} (local: ${localTimestamp}, server: ${serverTimestamp})`);
                            }
                        }
                    }
                } else {
                    // Only exists locally
                    merged.push(localItem);
                }
                
                processedKeys.add(key);
            });
            
            // Add server items that don't exist locally
            serverArray.forEach(serverItem => {
                const key = serverItem[keyField];
                if (!processedKeys.has(key)) {
                    merged.push(serverItem);
                }
            });
            
            return merged;
        };

        // Cleanup old protection entries for locally modified prescriptions
        const cleanupLocalProtections = () => {
            try {
                const locallyModified = loadFromStorage('locallyModified_prescriptions', []);
                const filtered = locallyModified.filter(id => {
                    const modTime = loadFromStorage(`modTime_${id}`, 0);
                    const isRecent = (Date.now() - modTime) < 300000; // Keep for 5 minutes
                    
                    if (!isRecent) {
                        // Remove old modification time
                        localStorage.removeItem(`modTime_${id}`);
                        console.log(`Cleaned up old protection for prescription: ${id}`);
                    }
                    
                    return isRecent;
                });
                
                if (filtered.length !== locallyModified.length) {
                    saveToStorage('locallyModified_prescriptions', filtered);
                    console.log(`Cleaned up ${locallyModified.length - filtered.length} old protection entries`);
                }
            } catch (error) {
                console.error('Error cleaning up local protections:', error);
            }
        };

        // Run cleanup every minute
        setInterval(cleanupLocalProtections, 60000);

        // Recovery function to restore backup data
        const restoreBackupData = () => {
            try {
                const backupPatients = loadFromStorage('backup_patients', []);
                const backupVitals = loadFromStorage('backup_vitals', []);
                const backupPrescriptions = loadFromStorage('backup_prescriptions', []);
                const backupCaseReports = loadFromStorage('backup_caseReports', []);
                const backupSickIntimations = loadFromStorage('backup_sickIntimations', []);
                const backupTimestamp = localStorage.getItem('backup_timestamp');
                
                if (backupPatients.length > 0 || backupVitals.length > 0 || backupPrescriptions.length > 0 || 
                    backupCaseReports.length > 0 || backupSickIntimations.length > 0) {
                    console.log(`Restoring backup data from ${backupTimestamp}...`);
                    saveToStorage('patients', backupPatients);
                    saveToStorage('vitals', backupVitals);
                    saveToStorage('prescriptions', backupPrescriptions);
                    saveToStorage('caseReports', backupCaseReports);
                    saveToStorage('sickIntimations', backupSickIntimations);
                    
                    // Clear backup after restoration
                    localStorage.removeItem('backup_patients');
                    localStorage.removeItem('backup_vitals');
                    localStorage.removeItem('backup_prescriptions');
                    localStorage.removeItem('backup_caseReports');
                    localStorage.removeItem('backup_sickIntimations');
                    localStorage.removeItem('backup_timestamp');
                    
                    return { 
                        patients: backupPatients, 
                        vitals: backupVitals, 
                        prescriptions: backupPrescriptions,
                        caseReports: backupCaseReports,
                        sickIntimations: backupSickIntimations
                    };
                }
            } catch (error) {
                console.error('Failed to restore backup data:', error);
            }
            return null;
        };

        // Enhanced Dashboard Component with Medical Analytics
        const Dashboard = ({ patients, vitals, prescriptions, caseReports, sickIntimations, setActiveTab }) => {
            const [selectedTimeframe, setSelectedTimeframe] = useState('week');
            const [showAlerts, setShowAlerts] = useState(true);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [quickSearchTerm, setQuickSearchTerm] = useState('');
            const [showQuickSearch, setShowQuickSearch] = useState(false);
            
            // Update time every second
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);
            
            const safePatients = patients || [];
            const safeVitals = vitals || [];
            const safePrescriptions = prescriptions || [];
            const safeCaseReports = caseReports || [];
            const safeSickIntimations = sickIntimations || [];
            
            // Time calculations
            const now = new Date();
            const getTimeframeDate = (timeframe) => {
                const date = new Date();
                switch(timeframe) {
                    case 'today': date.setHours(0, 0, 0, 0); break;
                    case 'week': date.setDate(date.getDate() - 7); break;
                    case 'month': date.setMonth(date.getMonth() - 1); break;
                    case 'year': date.setFullYear(date.getFullYear() - 1); break;
                    default: date.setDate(date.getDate() - 7);
                }
                return date;
            };
            
            const timeframeDate = getTimeframeDate(selectedTimeframe);
            
            // Enhanced statistics
            const stats = {
                // Patient stats
                totalPatients: safePatients.length,
                malePatients: safePatients.filter(p => p.gender === 'Male').length,
                femalePatients: safePatients.filter(p => p.gender === 'Female').length,
                averageAge: safePatients.length > 0 ? Math.round(safePatients.reduce((sum, p) => sum + (parseInt(p.age) || 0), 0) / safePatients.length) : 0,
                
                // Prescription analytics
                totalPrescriptions: safePrescriptions.length,
                criticalPrescriptions: safePrescriptions.filter(p => (p.priority || 'Normal') === 'Critical').length,
                urgentPrescriptions: safePrescriptions.filter(p => (p.priority || 'Normal') === 'Urgent').length,
                normalPrescriptions: safePrescriptions.filter(p => (p.priority || 'Normal') === 'Normal').length,
                
                // Recent activity
                recentVitals: safeVitals.filter(v => new Date(v.recordedAt) > timeframeDate).length,
                recentPrescriptions: safePrescriptions.filter(p => new Date(p.prescribedAt) > timeframeDate).length,
                recentCaseReports: safeCaseReports.filter(c => new Date(c.reportDate) > timeframeDate).length,
                recentSickLeaves: safeSickIntimations.filter(s => new Date(s.intimationDate) > timeframeDate).length,
                
                // Health indicators
                highBPCount: safeVitals.filter(v => {
                    const systolic = parseInt(v.bloodPressure?.split('/')[0]) || 0;
                    return systolic > 140;
                }).length,
                
                // Age distribution
                ageGroups: {
                    '0-18': safePatients.filter(p => parseInt(p.age) <= 18).length,
                    '19-35': safePatients.filter(p => parseInt(p.age) > 18 && parseInt(p.age) <= 35).length,
                    '36-55': safePatients.filter(p => parseInt(p.age) > 35 && parseInt(p.age) <= 55).length,
                    '55+': safePatients.filter(p => parseInt(p.age) > 55).length,
                },
                
                // Common diagnoses
                commonDiagnoses: safePrescriptions.reduce((acc, p) => {
                    const diagnosis = p.diagnosis || 'Unknown';
                    acc[diagnosis] = (acc[diagnosis] || 0) + 1;
                    return acc;
                }, {}),
                
                // Upcoming follow-ups
                upcomingFollowUps: safePrescriptions.filter(p => {
                    if (!p.followUpDate) return false;
                    const followUp = new Date(p.followUpDate);
                    const nextWeek = new Date();
                    nextWeek.setDate(nextWeek.getDate() + 7);
                    return followUp <= nextWeek && followUp >= now;
                }).length
            };
            
            // Alerts and notifications
            const alerts = [
                ...(stats.criticalPrescriptions > 0 ? [{
                    type: 'critical',
                    message: `${stats.criticalPrescriptions} critical prescription${stats.criticalPrescriptions > 1 ? 's' : ''} requiring immediate attention`,
                    action: 'View Prescriptions'
                }] : []),
                ...(stats.urgentPrescriptions > 0 ? [{
                    type: 'warning',
                    message: `${stats.urgentPrescriptions} urgent prescription${stats.urgentPrescriptions > 1 ? 's' : ''} need attention`,
                    action: 'Review Urgent Cases'
                }] : []),
                ...(stats.upcomingFollowUps > 0 ? [{
                    type: 'info',
                    message: `${stats.upcomingFollowUps} follow-up${stats.upcomingFollowUps > 1 ? 's' : ''} scheduled this week`,
                    action: 'View Schedule'
                }] : []),
                ...(stats.highBPCount > 0 ? [{
                    type: 'warning',
                    message: `${stats.highBPCount} patient${stats.highBPCount > 1 ? 's have' : ' has'} elevated blood pressure readings`,
                    action: 'Review Vitals'
                }] : [])
            ];

            return (
                <div className="space-y-6">
                    {/* Header with timeframe selector */}
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">NHCE Clinic Dashboard</h2>
                            <div className="text-sm text-gray-600 mt-1">
                                📅 {currentTime.toLocaleDateString('en-US', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })} • 🕐 {currentTime.toLocaleTimeString()}
                            </div>
                        </div>
                        <div className="flex gap-4">
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="🔍 Quick patient search..."
                                    value={quickSearchTerm}
                                    onChange={(e) => setQuickSearchTerm(e.target.value)}
                                    onFocus={() => setShowQuickSearch(true)}
                                    onBlur={() => setTimeout(() => setShowQuickSearch(false), 200)}
                                    className="form-input w-64 text-sm"
                                />
                                {showQuickSearch && quickSearchTerm && (
                                    <div className="absolute top-full left-0 w-full bg-white border rounded shadow-lg z-10 max-h-40 overflow-y-auto">
                                        {safePatients
                                            .filter(p => 
                                                p.fullName?.toLowerCase().includes(quickSearchTerm.toLowerCase()) ||
                                                p.usn?.toLowerCase().includes(quickSearchTerm.toLowerCase())
                                            )
                                            .slice(0, 5)
                                            .map(patient => (
                                                <div key={patient.usn} className="p-2 hover:bg-gray-100 cursor-pointer text-sm">
                                                    <div className="font-medium">{patient.fullName}</div>
                                                    <div className="text-gray-500">{patient.usn} • {patient.age}y • {patient.gender}</div>
                                                </div>
                                            ))
                                        }
                                        {safePatients.filter(p => 
                                            p.fullName?.toLowerCase().includes(quickSearchTerm.toLowerCase()) ||
                                            p.usn?.toLowerCase().includes(quickSearchTerm.toLowerCase())
                                        ).length === 0 && (
                                            <div className="p-2 text-gray-500 text-sm">No patients found</div>
                                        )}
                                    </div>
                                )}
                            </div>
                            <select
                                value={selectedTimeframe}
                                onChange={(e) => setSelectedTimeframe(e.target.value)}
                                className="form-input w-32"
                            >
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                            <button
                                onClick={() => setShowAlerts(!showAlerts)}
                                className={`btn ${showAlerts ? 'btn-primary' : 'btn-secondary'}`}
                            >
                                {showAlerts ? '🔔' : '🔕'} Alerts
                            </button>
                        </div>
                    </div>

                    {/* Alerts Section */}
                    {showAlerts && alerts.length > 0 && (
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                            <h3 className="font-semibold text-yellow-800 mb-2">🚨 System Alerts</h3>
                            <div className="space-y-2">
                                {alerts.map((alert, index) => (
                                    <div key={index} className={`flex justify-between items-center p-2 rounded ${
                                        alert.type === 'critical' ? 'bg-red-100 text-red-800' :
                                        alert.type === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-blue-100 text-blue-800'
                                    }`}>
                                        <span>{alert.message}</span>
                                        <span className="text-sm font-medium cursor-pointer hover:underline">
                                            {alert.action}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Main Statistics Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className="stat-card" style={{background: '#3b82f6', color: 'white'}}>
                            <div className="stat-number" style={{color: 'white'}}>{stats.totalPatients}</div>
                            <div className="stat-label" style={{color: 'white'}}>Total Patients</div>
                            <div className="text-xs" style={{color: 'rgba(255,255,255,0.8)'}}>👥 Registered</div>
                        </div>
                        <div className="stat-card" style={{background: '#3b82f6', color: 'white'}}>
                            <div className="stat-number" style={{color: 'white'}}>{stats.totalPrescriptions}</div>
                            <div className="stat-label" style={{color: 'white'}}>Total Prescriptions</div>
                            <div className="text-xs" style={{color: 'rgba(255,255,255,0.8)'}}>💊 All time</div>
                        </div>
                        <div className="stat-card" style={{background: '#3b82f6', color: 'white'}}>
                            <div className="stat-number" style={{color: 'white'}}>{stats.recentVitals}</div>
                            <div className="stat-label" style={{color: 'white'}}>Recent Vitals</div>
                            <div className="text-xs" style={{color: 'rgba(255,255,255,0.8)'}}>📊 {selectedTimeframe}</div>
                        </div>
                        <div className="stat-card" style={{background: '#3b82f6', color: 'white'}}>
                            <div className="stat-number" style={{color: 'white'}}>{stats.averageAge}</div>
                            <div className="stat-label" style={{color: 'white'}}>Average Age</div>
                            <div className="text-xs" style={{color: 'rgba(255,255,255,0.8)'}}>🎂 Years</div>
                        </div>
                    </div>

                    {/* Prescription Priority Overview */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="card">
                            <h3 className="text-lg font-semibold mb-4">📋 Prescription Priorities</h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center p-3 bg-red-50 rounded">
                                    <span className="font-medium text-red-800">Critical</span>
                                    <span className="badge badge-red">{stats.criticalPrescriptions}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-yellow-50 rounded">
                                    <span className="font-medium text-yellow-800">Urgent</span>
                                    <span className="badge badge-yellow">{stats.urgentPrescriptions}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-green-50 rounded">
                                    <span className="font-medium text-green-800">Normal</span>
                                    <span className="badge badge-green">{stats.normalPrescriptions}</span>
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <h3 className="text-lg font-semibold mb-4">👥 Demographics</h3>
                            <div className="space-y-3">
                                <div className="flex justify-between">
                                    <span>Male</span>
                                    <span className="badge badge-blue">{stats.malePatients}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>Female</span>
                                    <span className="badge badge-pink">{stats.femalePatients}</span>
                                </div>
                                <div className="mt-4">
                                    <h4 className="font-medium mb-2">Age Groups</h4>
                                    <div className="text-sm space-y-1">
                                        <div className="flex justify-between">
                                            <span>0-18 years</span>
                                            <span>{stats.ageGroups['0-18']}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>19-35 years</span>
                                            <span>{stats.ageGroups['19-35']}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>36-55 years</span>
                                            <span>{stats.ageGroups['36-55']}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>55+ years</span>
                                            <span>{stats.ageGroups['55+']}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <h3 className="text-lg font-semibold mb-4">📈 Recent Activity</h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span>📊 Vitals Recorded</span>
                                    <span className="badge badge-blue">{stats.recentVitals}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span>💊 New Prescriptions</span>
                                    <span className="badge badge-green">{stats.recentPrescriptions}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span>📋 Case Reports</span>
                                    <span className="badge badge-purple">{stats.recentCaseReports}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span>🏥 Sick Leaves</span>
                                    <span className="badge badge-orange">{stats.recentSickLeaves}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span>📅 Follow-ups Due</span>
                                    <span className="badge badge-yellow">{stats.upcomingFollowUps}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Common Diagnoses */}
                    <div className="card">
                        <h3 className="text-lg font-semibold mb-4">🔍 Common Diagnoses</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {Object.entries(stats.commonDiagnoses)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 6)
                                .map(([diagnosis, count]) => (
                                    <div key={diagnosis} className="flex justify-between items-center p-3 bg-gray-50 rounded">
                                        <span className="font-medium truncate">{diagnosis}</span>
                                        <span className="badge badge-gray ml-2">{count}</span>
                                    </div>
                                ))}
                        </div>
                        {Object.keys(stats.commonDiagnoses).length === 0 && (
                            <p className="text-gray-500 text-center py-4">No diagnosis data available yet.</p>
                        )}
                    </div>

                    {/* Quick Actions */}
                    <div className="card">
                        <h3 className="text-lg font-semibold mb-4">⚡ Quick Actions</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button 
                                onClick={() => setActiveTab && setActiveTab('patients')}
                                className="btn btn-primary flex items-center justify-center gap-2 py-4"
                            >
                                👤 Add Patient
                            </button>
                            <button 
                                onClick={() => setActiveTab && setActiveTab('prescriptions')}
                                className="btn btn-secondary flex items-center justify-center gap-2 py-4"
                            >
                                💊 New Prescription
                            </button>
                            <button 
                                onClick={() => setActiveTab && setActiveTab('vitals')}
                                className="btn btn-success flex items-center justify-center gap-2 py-4"
                            >
                                📊 Record Vitals
                            </button>
                            <button 
                                onClick={() => setActiveTab && setActiveTab('case-reports')}
                                className="btn btn-info flex items-center justify-center gap-2 py-4"
                            >
                                📋 Case Report
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        

        // Patient Form Component
        const PatientForm = ({ patients, setPatients, selectedPatient, setSelectedPatient }) => {
            const [formData, setFormData] = useState({
                usn: '',
                fullName: '',
                age: '',
                gender: '',
                address: '',
                phone: '',
                email: ''
            });
            const [errors, setErrors] = useState({});
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                if (selectedPatient) {
                    setFormData({
                        usn: selectedPatient.usn || '',
                        fullName: selectedPatient.fullName || '',
                        age: selectedPatient.age || '',
                        gender: selectedPatient.gender || '',
                        address: selectedPatient.address || '',
                        phone: selectedPatient.phone || '',
                        email: selectedPatient.email || ''
                    });
                } else {
                    setFormData({
                        usn: '', fullName: '', age: '', gender: '', address: '', phone: '', email: ''
                    });
                }
            }, [selectedPatient]);

            const validateForm = () => {
                const newErrors = {};
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const phoneRegex = /^\+?[0-9\-\s]{7,15}$/;
                if (!formData.usn?.trim()) newErrors.usn = 'USN is required';
                if (!formData.fullName?.trim()) newErrors.fullName = 'Full name is required';
                if (!formData.age || Number(formData.age) <= 0) newErrors.age = 'Valid age is required';
                if (!formData.gender) newErrors.gender = 'Gender is required';
                if (formData.email && !emailRegex.test(formData.email)) newErrors.email = 'Invalid email';
                if (formData.phone && !phoneRegex.test(formData.phone)) newErrors.phone = 'Invalid phone';

                // Unique USN check when creating new
                if (!selectedPatient && formData.usn?.trim()) {
                    const exists = (patients || []).some(p => (p.usn || '').toLowerCase() === formData.usn.trim().toLowerCase());
                    if (exists) newErrors.usn = 'USN already exists';
                }

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (errors[name]) setErrors(prev => ({ ...prev, [name]: '' }));
            };

            const resetForm = () => {
                setSelectedPatient(null);
                setFormData({ usn: '', fullName: '', age: '', gender: '', address: '', phone: '', email: '' });
                setErrors({});
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!validateForm()) return;
                setSaving(true);

                try {
                    const nowMs = Date.now();
                    const payload = {
                        usn: formData.usn.trim(),
                        fullName: formData.fullName.trim(),
                        age: Number(formData.age),
                        gender: formData.gender,
                        address: formData.address?.trim() || '',
                        phone: formData.phone?.trim() || '',
                        email: formData.email?.trim() || '',
                        // Timestamps help prevent server refresh from overwriting local edits
                        createdAt: typeof selectedPatient?.createdAt === 'number' ? selectedPatient.createdAt : (selectedPatient?.createdAt ? Date.parse(selectedPatient.createdAt) || nowMs : nowMs),
                        updatedAt: nowMs
                    };

                    let updatedList = [];
                    if (selectedPatient) {
                        // Update existing
                        updatedList = (patients || []).map(p => {
                            if (p.usn === selectedPatient.usn) {
                                return {
                                    ...p,
                                    ...payload,
                                    createdAt: typeof p.createdAt === 'number' ? p.createdAt : (p.createdAt ? Date.parse(p.createdAt) || payload.createdAt : payload.createdAt), // preserve original creation time
                                    updatedAt: nowMs
                                };
                            }
                            return p;
                        });
                    } else {
                        // Add new
                        updatedList = [ ...(patients || []), payload ];
                    }

                    setPatients(updatedList);
                    saveToStorage('patients', updatedList);

                    // Try to sync with server and inform user where it's stored
                    const wasEdit = !!selectedPatient;
                    const actionText = wasEdit ? 'updated' : 'added';
                    let synced = false;
                    try {
                        // Backend accepts POST for both create and update (INSERT OR REPLACE)
                        synced = await syncWithDatabase('patients', payload, 'POST');
                    } catch (_) { synced = false; }

                    if (synced) {
                        alert(`✅ Patient ${actionText} and synced to database successfully!`);
                    } else if (serverAvailable) {
                        alert(`❌ Patient ${actionText} locally but failed to sync. Will retry when online.`);
                    } else {
                        alert(`💾 Patient ${actionText} locally. Will sync when server is available.`);
                    }

                    resetForm();
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div className="card">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-semibold">{selectedPatient ? 'Edit Patient' : 'Add New Patient'}</h2>
                        <div className="text-sm text-gray-500">Fields marked * are required</div>
                    </div>

                    <form onSubmit={handleSubmit}>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">USN *</label>
                                <input
                                    type="text"
                                    name="usn"
                                    value={formData.usn}
                                    onChange={handleChange}
                                    className="form-input"
                                    placeholder="e.g., 1NH21CS001"
                                    disabled={!!selectedPatient}
                                />
                                {errors.usn && <p className="text-red-500 text-sm">{errors.usn}</p>}
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Full Name *</label>
                                <input
                                    type="text"
                                    name="fullName"
                                    value={formData.fullName}
                                    onChange={handleChange}
                                    className="form-input"
                                    placeholder="Student/Staff name"
                                />
                                {errors.fullName && <p className="text-red-500 text-sm">{errors.fullName}</p>}
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Age *</label>
                                <input
                                    type="number"
                                    name="age"
                                    value={formData.age}
                                    onChange={handleChange}
                                    className="form-input"
                                    min="1"
                                />
                                {errors.age && <p className="text-red-500 text-sm">{errors.age}</p>}
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Gender *</label>
                                <select
                                    name="gender"
                                    value={formData.gender}
                                    onChange={handleChange}
                                    className="form-input"
                                >
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                                {errors.gender && <p className="text-red-500 text-sm">{errors.gender}</p>}
                            </div>

                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium mb-1">Address</label>
                                <input
                                    type="text"
                                    name="address"
                                    value={formData.address}
                                    onChange={handleChange}
                                    className="form-input"
                                    placeholder="Optional"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Phone</label>
                                <input
                                    type="tel"
                                    name="phone"
                                    value={formData.phone}
                                    onChange={handleChange}
                                    className="form-input"
                                    placeholder="Optional"
                                />
                                {errors.phone && <p className="text-red-500 text-sm">{errors.phone}</p>}
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Email</label>
                                <input
                                    type="email"
                                    name="email"
                                    value={formData.email}
                                    onChange={handleChange}
                                    className="form-input"
                                    placeholder="Optional"
                                />
                                {errors.email && <p className="text-red-500 text-sm">{errors.email}</p>}
                            </div>
                        </div>

                        <div className="flex flex-wrap gap-3 mt-6">
                            <button type="submit" className="btn btn-primary" disabled={saving}>
                                {saving ? 'Saving...' : selectedPatient ? 'Update Patient' : 'Add Patient'}
                            </button>
                            {selectedPatient && (
                                <button type="button" onClick={resetForm} className="btn btn-secondary">Cancel Edit</button>
                            )}
                            <button 
                                type="button" 
                                onClick={async () => {
                                    const isHealthy = await checkServerHealth();
                                    serverAvailable = isHealthy;
                                    if (isHealthy) {
                                        alert('✅ Database connection successful!');
                                    } else {
                                        alert('❌ Database connection failed. Please ensure the Python server is running on localhost:5000');
                                    }
                                }}
                                className="btn bg-blue-500 hover:bg-blue-600 text-white"
                            >
                                🔧 Test DB Connection
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        // Vitals Form Component
        const VitalsForm = ({ patients, vitals, setVitals }) => {
            const safePatients = patients || [];
            const safeVitals = vitals || [];
            
            const [formData, setFormData] = useState({
                usn: '',
                weight: '',
                height: '',
                bloodPressureSystolic: '',
                bloodPressureDiastolic: '',
                heartRate: '',
                temperature: '',
                respiratoryRate: '',
                oxygenSaturation: '',
                notes: ''
            });
            const [errors, setErrors] = useState({});
            const [selectedPatientDetails, setSelectedPatientDetails] = useState(null);
            const [patientSearchTerm, setPatientSearchTerm] = useState('');
            const [showPatientDropdown, setShowPatientDropdown] = useState(false);

            const validateForm = () => {
                const newErrors = {};
                if (!formData.usn) newErrors.usn = 'Please select a patient';
                if (!formData.weight || formData.weight <= 0) newErrors.weight = 'Valid weight is required';
                if (!formData.height || formData.height <= 0) newErrors.height = 'Valid height is required';
                if (!formData.bloodPressureSystolic || formData.bloodPressureSystolic <= 0) newErrors.bloodPressureSystolic = 'Valid systolic BP is required';
                if (!formData.bloodPressureDiastolic || formData.bloodPressureDiastolic <= 0) newErrors.bloodPressureDiastolic = 'Valid diastolic BP is required';
                if (!formData.heartRate || formData.heartRate <= 0) newErrors.heartRate = 'Valid heart rate is required';
                if (!formData.temperature || formData.temperature <= 0) newErrors.temperature = 'Valid temperature is required';
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const calculateBMI = (weight, height) => {
                const heightInMeters = height / 100;
                return (weight / (heightInMeters * heightInMeters)).toFixed(1);
            };

            const getBMICategory = (bmi) => {
                if (bmi < 18.5) return { category: 'Underweight', color: 'text-blue-600' };
                if (bmi < 25) return { category: 'Normal', color: 'text-green-600' };
                if (bmi < 30) return { category: 'Overweight', color: 'text-yellow-600' };
                return { category: 'Obese', color: 'text-red-600' };
            };

            const getBloodPressureCategory = (systolic, diastolic) => {
                if (systolic < 120 && diastolic < 80) return { category: 'Normal', color: 'text-green-600' };
                if (systolic < 130 && diastolic < 80) return { category: 'Elevated', color: 'text-yellow-600' };
                if (systolic < 140 || diastolic < 90) return { category: 'Stage 1 Hypertension', color: 'text-orange-600' };
                return { category: 'Stage 2 Hypertension', color: 'text-red-600' };
            };

            // Vital sign suggestion ranges (simplified) based on age bands
            const getVitalSuggestions = (patient) => {
                if (!patient) return null;
                const age = parseInt(patient.age, 10);
                const genderRaw = (patient.gender || '').toString().toLowerCase();
                let heartRate = '60-100';
                let respiratoryRate = '12-20';
                let temperature = '36.1-37.2';
                let oxygenSaturation = '95-100';
                let bpRange = '90-120 / 60-80';
                let idealHeightRange = { min: 150, max: 170 }; // fallback generic

                if (age < 1) {
                    heartRate = '100-160';
                    respiratoryRate = '30-60';
                    bpRange = '70-100 / 50-65';
                    idealHeightRange = { min: 50, max: 75 }; // cm
                } else if (age < 6) {
                    heartRate = '80-120';
                    respiratoryRate = '20-30';
                    bpRange = '80-110 / 50-70';
                    idealHeightRange = { min: 75, max: 110 };
                } else if (age < 13) {
                    heartRate = '70-110';
                    respiratoryRate = '18-25';
                    bpRange = '85-115 / 55-75';
                    idealHeightRange = { min: 110, max: 150 };
                } else if (age < 18) {
                    heartRate = '60-100';
                    respiratoryRate = '12-20';
                    bpRange = '90-120 / 60-80';
                    if (genderRaw.startsWith('m')) {
                        idealHeightRange = { min: 150, max: 180 };
                    } else if (genderRaw.startsWith('f')) {
                        idealHeightRange = { min: 145, max: 170 };
                    } else {
                        idealHeightRange = { min: 145, max: 178 };
                    }
                } else { // adults 18+
                    if (genderRaw.startsWith('m')) {
                        idealHeightRange = { min: 160, max: 185 };
                    } else if (genderRaw.startsWith('f')) {
                        idealHeightRange = { min: 150, max: 175 };
                    } else {
                        idealHeightRange = { min: 155, max: 180 };
                    }
                }

                // Ideal weight range from BMI 18.5 - 24.9
                let idealWeightRange = null;
                const h = parseFloat(formData.height);
                if (h && h > 0) {
                    const hM = h / 100;
                    idealWeightRange = {
                        min: (18.5 * hM * hM).toFixed(1),
                        max: (24.9 * hM * hM).toFixed(1)
                    };
                }

                return { heartRate, respiratoryRate, temperature, oxygenSaturation, bpRange, idealWeightRange, idealHeightRange };
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!validateForm()) return;

                const vitalRecord = {
                    id: Date.now().toString(),
                    usn: formData.usn,
                    patientName: selectedPatientDetails?.fullName || '',
                    weight: parseFloat(formData.weight),
                    height: parseFloat(formData.height),
                    bmi: calculateBMI(parseFloat(formData.weight), parseFloat(formData.height)),
                    bloodPressureSystolic: parseInt(formData.bloodPressureSystolic),
                    bloodPressureDiastolic: parseInt(formData.bloodPressureDiastolic),
                    heartRate: parseInt(formData.heartRate),
                    temperature: parseFloat(formData.temperature),
                    respiratoryRate: formData.respiratoryRate ? parseInt(formData.respiratoryRate) : null,
                    oxygenSaturation: formData.oxygenSaturation ? parseInt(formData.oxygenSaturation) : null,
                    notes: formData.notes,
                    recordedAt: new Date().toISOString(),
                    recordedBy: 'System User'
                };

                const newVitals = [...vitals, vitalRecord];
                setVitals(newVitals);
                saveToStorage('vitals', newVitals);

                // Sync with database
                const dbVitalData = {
                    usn: formData.usn,
                    weight: parseFloat(formData.weight),
                    height: parseFloat(formData.height),
                    bloodPressureSystolic: parseInt(formData.bloodPressureSystolic),
                    bloodPressureDiastolic: parseInt(formData.bloodPressureDiastolic),
                    heartRate: parseInt(formData.heartRate),
                    temperature: parseFloat(formData.temperature),
                    respiratoryRate: formData.respiratoryRate ? parseInt(formData.respiratoryRate) : null,
                    oxygenSaturation: formData.oxygenSaturation ? parseInt(formData.oxygenSaturation) : null,
                    notes: formData.notes
                };
                syncWithDatabase('vitals', dbVitalData);

                // Reset form
                setFormData({
                    usn: '',
                    weight: '',
                    height: '',
                    bloodPressureSystolic: '',
                    bloodPressureDiastolic: '',
                    heartRate: '',
                    temperature: '',
                    respiratoryRate: '',
                    oxygenSaturation: '',
                    notes: ''
                });
                setSelectedPatientDetails(null);
                setErrors({});
                alert('Vitals recorded successfully!');
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (errors[name]) {
                    setErrors(prev => ({ ...prev, [name]: '' }));
                }
            };

            const handlePatientSelect = (e) => {
                const usn = e.target.value;
                setFormData(prev => ({ ...prev, usn }));
                const patient = safePatients.find(p => p.usn === usn);
                setSelectedPatientDetails(patient);
                if (errors.usn) {
                    setErrors(prev => ({ ...prev, usn: '' }));
                }
            };

            // Handle search typing for merged input
            const handlePatientSearch = (e) => {
                const term = e.target.value;
                setPatientSearchTerm(term);
                setShowPatientDropdown(true);
                if (!term) {
                    // cleared
                    setFormData(prev => ({ ...prev, usn: '' }));
                    setSelectedPatientDetails(null);
                }
            };

            const selectPatientFromSearch = (patient) => {
                setFormData(prev => ({ ...prev, usn: patient.usn }));
                setSelectedPatientDetails(patient);
                setPatientSearchTerm(`${patient.usn} - ${patient.fullName}`);
                setShowPatientDropdown(false);
                if (errors.usn) setErrors(prev => ({ ...prev, usn: '' }));
            };

            useEffect(() => {
                const onClick = (e) => {
                    if (!e.target.closest('.vitals-patient-select')) {
                        setShowPatientDropdown(false);
                    }
                };
                document.addEventListener('click', onClick);
                return () => document.removeEventListener('click', onClick);
            }, []);

            const currentBMI = formData.weight && formData.height ? calculateBMI(parseFloat(formData.weight), parseFloat(formData.height)) : null;
            const bmiInfo = currentBMI ? getBMICategory(parseFloat(currentBMI)) : null;
            const bpInfo = formData.bloodPressureSystolic && formData.bloodPressureDiastolic ? 
                getBloodPressureCategory(parseInt(formData.bloodPressureSystolic), parseInt(formData.bloodPressureDiastolic)) : null;

            const patientVitals = selectedPatientDetails ? (vitals || []).filter(v => v.usn === selectedPatientDetails.usn).slice(-5) : [];
            const filteredPatients = patientSearchTerm
                ? safePatients.filter(p => {
                    const term = patientSearchTerm.toLowerCase();
                    return (p.usn && p.usn.toLowerCase().includes(term)) || (p.fullName && p.fullName.toLowerCase().includes(term));
                })
                : safePatients;
            const vitalSuggestions = selectedPatientDetails ? getVitalSuggestions(selectedPatientDetails) : null;

            return (
                <div className="space-y-6">
                    <div className="card">
                        <h2 className="text-xl font-semibold mb-4">Record Patient Vitals</h2>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium mb-1">Select Patient *</label>
                                    <div className="relative vitals-patient-select">
                                        <input
                                            type="text"
                                            value={patientSearchTerm}
                                            onChange={handlePatientSearch}
                                            onFocus={() => setShowPatientDropdown(true)}
                                            placeholder="Search patient by USN or name..."
                                            className="form-input pr-8"
                                        />
                                        <div className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 10-14 0 7 7 0 0014 0z" /></svg>
                                        </div>
                                        {showPatientDropdown && filteredPatients.length > 0 && (
                                            <div className="absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded shadow max-h-60 overflow-auto">
                                                {filteredPatients.slice(0,10).map(p => (
                                                    <div key={p.usn} onClick={() => selectPatientFromSearch(p)} className="px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0">
                                                        <div className="font-medium">{p.fullName}</div>
                                                        <div className="text-xs text-gray-600">{p.usn} • {p.age}y • {p.gender}</div>
                                                    </div>
                                                ))}
                                                {filteredPatients.length > 10 && (
                                                    <div className="px-3 py-2 text-xs text-gray-500 bg-gray-50">Showing first 10 results...</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    {errors.usn && <p className="text-red-500 text-sm">{errors.usn}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Weight (kg) *</label>
                                    <input
                                        type="number"
                                        name="weight"
                                        value={formData.weight}
                                        onChange={handleChange}
                                        step="0.1"
                                        className="form-input"
                                        placeholder={vitalSuggestions?.idealWeightRange ? `${vitalSuggestions.idealWeightRange.min}-${vitalSuggestions.idealWeightRange.max}` : 'kg'}
                                    />
                                    {errors.weight && <p className="text-red-500 text-sm">{errors.weight}</p>}
                                    {vitalSuggestions?.idealWeightRange && (
                                        <p className="text-xs text-gray-500">Ideal: {vitalSuggestions.idealWeightRange.min}-{vitalSuggestions.idealWeightRange.max} kg (BMI 18.5-24.9)</p>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Height (cm) *</label>
                                    <input
                                        type="number"
                                        name="height"
                                        value={formData.height}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder={vitalSuggestions?.idealHeightRange ? `${vitalSuggestions.idealHeightRange.min}-${vitalSuggestions.idealHeightRange.max}` : 'cm'}
                                    />
                                    {errors.height && <p className="text-red-500 text-sm">{errors.height}</p>}
                                    {vitalSuggestions?.idealHeightRange && (
                                        <p className="text-xs text-gray-500">Expected Height Range: {vitalSuggestions.idealHeightRange.min}-{vitalSuggestions.idealHeightRange.max} cm</p>
                                    )}
                                </div>

                                {currentBMI && (
                                    <div className="md:col-span-2 p-3 bg-gray-50 rounded">
                                        <div className="flex items-center justify-between">
                                            <span className="font-medium">BMI: {currentBMI}</span>
                                            <span className={`font-medium ${bmiInfo.color}`}>{bmiInfo.category}</span>
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium mb-1">Blood Pressure - Systolic (mmHg) *</label>
                                    <input
                                        type="number"
                                        name="bloodPressureSystolic"
                                        value={formData.bloodPressureSystolic}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="120"
                                    />
                                    {errors.bloodPressureSystolic && <p className="text-red-500 text-sm">{errors.bloodPressureSystolic}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Blood Pressure - Diastolic (mmHg) *</label>
                                    <input
                                        type="number"
                                        name="bloodPressureDiastolic"
                                        value={formData.bloodPressureDiastolic}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="80"
                                    />
                                    {errors.bloodPressureDiastolic && <p className="text-red-500 text-sm">{errors.bloodPressureDiastolic}</p>}
                                    {vitalSuggestions?.bpRange && (
                                        <p className="text-xs text-gray-500">Normal Range: {vitalSuggestions.bpRange} mmHg</p>
                                    )}
                                </div>

                                {bpInfo && (
                                    <div className="md:col-span-2 p-3 bg-gray-50 rounded">
                                        <div className="flex items-center justify-between">
                                            <span className="font-medium">Blood Pressure: {formData.bloodPressureSystolic}/{formData.bloodPressureDiastolic}</span>
                                            <span className={`font-medium ${bpInfo.color}`}>{bpInfo.category}</span>
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium mb-1">Heart Rate (bpm) *</label>
                                    <input
                                        type="number"
                                        name="heartRate"
                                        value={formData.heartRate}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="72"
                                    />
                                    {errors.heartRate && <p className="text-red-500 text-sm">{errors.heartRate}</p>}
                                    {vitalSuggestions?.heartRate && (
                                        <p className="text-xs text-gray-500">Expected: {vitalSuggestions.heartRate} bpm</p>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Temperature (°C) *</label>
                                    <input
                                        type="number"
                                        name="temperature"
                                        value={formData.temperature}
                                        onChange={handleChange}
                                        step="0.1"
                                        className="form-input"
                                        placeholder="37.0"
                                    />
                                    {errors.temperature && <p className="text-red-500 text-sm">{errors.temperature}</p>}
                                    {vitalSuggestions?.temperature && (
                                        <p className="text-xs text-gray-500">Normal: {vitalSuggestions.temperature} °C</p>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Respiratory Rate (breaths/min)</label>
                                    <input
                                        type="number"
                                        name="respiratoryRate"
                                        value={formData.respiratoryRate}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="16"
                                    />
                                    {vitalSuggestions?.respiratoryRate && (
                                        <p className="text-xs text-gray-500">Normal RR: {vitalSuggestions.respiratoryRate} breaths/min</p>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Oxygen Saturation (%)</label>
                                    <input
                                        type="number"
                                        name="oxygenSaturation"
                                        value={formData.oxygenSaturation}
                                        onChange={handleChange}
                                        min="70"
                                        max="100"
                                        className="form-input"
                                        placeholder="98"
                                    />
                                    {vitalSuggestions?.oxygenSaturation && (
                                        <p className="text-xs text-gray-500">Normal SpO₂: {vitalSuggestions.oxygenSaturation}%</p>
                                    )}
                                </div>

                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium mb-1">Clinical Notes</label>
                                    <textarea
                                        name="notes"
                                        value={formData.notes}
                                        onChange={handleChange}
                                        rows="3"
                                        className="form-input"
                                        placeholder="Additional observations or notes..."
                                    />
                                </div>
                            </div>

                            <div className="mt-6">
                                <button type="submit" className="btn btn-primary">
                                    Record Vitals
                                </button>
                            </div>
                        </form>
                    </div>

                    {selectedPatientDetails && patientVitals.length > 0 && (
                        <div className="card">
                            <h3 className="text-lg font-semibold mb-4">Recent Vitals History for {selectedPatientDetails.fullName}</h3>
                            <div className="overflow-x-auto">
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Weight</th>
                                            <th>BMI</th>
                                            <th>BP</th>
                                            <th>Heart Rate</th>
                                            <th>Temperature</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {patientVitals.map((vital) => (
                                            <tr key={vital.id}>
                                                <td>{new Date(vital.recordedAt).toLocaleDateString()}</td>
                                                <td>{vital.weight} kg</td>
                                                <td>{vital.bmi}</td>
                                                <td>{vital.bloodPressureSystolic}/{vital.bloodPressureDiastolic}</td>
                                                <td>{vital.heartRate} bpm</td>
                                                <td>{vital.temperature}°C</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Prescription Form Component
        // Prescription Form Component with Error Handling
        const PrescriptionForm = ({ patients, prescriptions, setPrescriptions }) => {
            try {
                const [formData, setFormData] = useState({
                    usn: '',
                    medications: [{ 
                        name: '', 
                        customName: '',
                        dosage: '', 
                        frequency: '', 
                        duration: '', 
                        instructions: '' 
                    }],
                    diagnosis: '',
                    notes: '',
                    followUpDate: '',
                    priority: 'Normal'
                });
                const [errors, setErrors] = useState({});
                const [selectedPatientDetails, setSelectedPatientDetails] = useState(null);
                const [patientSearchTerm, setPatientSearchTerm] = useState('');
                const [showPatientDropdown, setShowPatientDropdown] = useState(false);

                // Add safety checks for props
                const safePatients = patients || [];
                const safePrescriptions = prescriptions || [];
                
                // Get prescriptions for the selected patient
                const patientPrescriptions = selectedPatientDetails 
                    ? safePrescriptions.filter(p => p.usn === selectedPatientDetails.usn)
                    : [];

                // Close dropdown when clicking outside
                useEffect(() => {
                    const handleClickOutside = (event) => {
                        if (!event.target.closest('.relative')) {
                            setShowPatientDropdown(false);
                        }
                    };
                    
                    document.addEventListener('click', handleClickOutside);
                    return () => document.removeEventListener('click', handleClickOutside);
                }, []);

            const commonMedications = [
                'Paracetamol 500mg', 'Ibuprofen 400mg', 'Amoxicillin 500mg', 'Azithromycin 250mg',
                'Omeprazole 20mg', 'Metformin 500mg', 'Amlodipine 5mg', 'Atorvastatin 20mg',
                'Levothyroxine 50mcg', 'Aspirin 75mg', 'Ciprofloxacin 500mg', 'Prednisolone 5mg',
                'Salbutamol Inhaler', 'Insulin Glargine', 'Vitamin D3 1000IU', 'Iron Tablet',
                'Calcium Carbonate', 'Multivitamin', 'Cough Syrup', 'Antacid Tablet'
            ];

            const frequencies = ['Once daily', 'Twice daily', 'Three times daily', 'Four times daily', 'As needed', 'Before meals', 'After meals'];
            const durations = ['1 day', '2 days', '3 days', '5 days', '7 days', '10 days', '14 days', '1 month', '3 months', 'Ongoing'];

            const validateForm = () => {
                const newErrors = {};
                if (!formData.usn) newErrors.usn = 'Please select a patient';
                if (!formData.diagnosis.trim()) newErrors.diagnosis = 'Diagnosis is required';
                
                const hasValidMedication = formData.medications.some(med => {
                    const medicationName = med.name === 'custom' ? med.customName : med.name;
                    return medicationName && medicationName.trim() && med.dosage.trim() && med.frequency.trim();
                });
                if (!hasValidMedication) {
                    newErrors.medications = 'At least one complete medication is required';
                }

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!validateForm()) return;

                const nowIso = new Date().toISOString();
                const nowEpoch = Date.now();
                // Build an IST (Asia/Kolkata) timestamp string (YYYY-MM-DDTHH:mm:ss+05:30)
                const istParts = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'Asia/Kolkata',
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                }).formatToParts(new Date());
                const part = (t) => (istParts.find(p => p.type === t) || {}).value || '';
                const prescribedAtIST = `${part('year')}-${part('month')}-${part('day')}T${part('hour')}:${part('minute')}:${part('second')}+05:30`;
                const prescriptionRecord = {
                    id: Date.now().toString(),
                    usn: formData.usn,
                    patientName: selectedPatientDetails?.fullName || '',
                    patientAge: selectedPatientDetails?.age || '',
                    patientGender: selectedPatientDetails?.gender || '',
                    diagnosis: formData.diagnosis,
                    medications: formData.medications.filter(med => {
                        const medicationName = med.name === 'custom' ? med.customName : med.name;
                        return medicationName && medicationName.trim() && med.dosage.trim() && med.frequency.trim();
                    }).map(med => ({
                        ...med,
                        name: med.name === 'custom' ? med.customName : med.name
                    })),
                    notes: formData.notes,
                    followUpDate: formData.followUpDate,
                    prescribedAt: nowIso,
                    prescribedAtIST,
                    createdAt: nowEpoch,
                    prescribedBy: 'NHCE Clinic',
                    priority: formData.priority
                };

                const newPrescriptions = [...prescriptions, prescriptionRecord];
                setPrescriptions(newPrescriptions);
                saveToStorage('prescriptions', newPrescriptions);

                // Sync with database
                const dbPrescriptionData = {
                    usn: formData.usn,
                    diagnosis: formData.diagnosis,
                    medications: prescriptionRecord.medications,
                    notes: formData.notes,
                    followUpDate: formData.followUpDate,
                    prescribedAt: nowIso,
                    prescribedAtIST,
                    prescribedBy: 'NHCE Clinic',
                    status: 'Active',
                    patientName: selectedPatientDetails?.fullName || '',
                    patientAge: selectedPatientDetails?.age || null,
                    patientGender: selectedPatientDetails?.gender || ''
                };
                
                console.log('Attempting to sync prescription to database:', dbPrescriptionData);
                const syncResult = await syncWithDatabase('prescriptions', dbPrescriptionData);
                
                if (syncResult) {
                    console.log('Prescription synced to database successfully');
                    alert('✅ Prescription created and synced to database successfully!');
                } else {
                    console.warn('Prescription saved locally but failed to sync to database');
                    if (serverAvailable) {
                        alert('❌ Prescription created locally but failed to sync to database. Please check the server connection and try again.');
                    } else {
                        alert('💾 Prescription created locally. Will sync to database when server is available.');
                    }
                }

                // Reset form
                setFormData({
                    usn: '',
                    medications: [{ name: '', customName: '', dosage: '', frequency: '', duration: '', instructions: '' }],
                    diagnosis: '',
                    notes: '',
                    followUpDate: '',
                    priority: 'Normal'
                });
                setSelectedPatientDetails(null);
                setErrors({});
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (errors[name]) {
                    setErrors(prev => ({ ...prev, [name]: '' }));
                }
            };

            const handlePatientSelect = (e) => {
                const usn = e.target.value;
                setFormData(prev => ({ ...prev, usn }));
                const patient = safePatients.find(p => p.usn === usn);
                setSelectedPatientDetails(patient);
                if (errors.usn) {
                    setErrors(prev => ({ ...prev, usn: '' }));
                }
            };

            // Filter patients based on search term
            const filteredPatients = safePatients.filter(patient => {
                if (!patientSearchTerm) return true;
                const searchLower = patientSearchTerm.toLowerCase();
                return (
                    patient.fullName.toLowerCase().includes(searchLower) ||
                    patient.usn.toLowerCase().includes(searchLower) ||
                    (patient.phone && patient.phone.includes(searchLower))
                );
            });

            const handlePatientSearch = (e) => {
                const searchTerm = e.target.value;
                setPatientSearchTerm(searchTerm);
                setShowPatientDropdown(searchTerm.length > 0);
                
                // Auto-select if exact match
                if (searchTerm.length > 2) {
                    const exactMatch = filteredPatients.find(p => 
                        p.fullName.toLowerCase() === searchTerm.toLowerCase() ||
                        p.usn.toLowerCase() === searchTerm.toLowerCase()
                    );
                    if (exactMatch) {
                        setFormData(prev => ({ ...prev, usn: exactMatch.usn }));
                        setSelectedPatientDetails(exactMatch);
                        setShowPatientDropdown(false);
                    }
                }
            };

            const selectPatientFromSearch = (patient) => {
                setFormData(prev => ({ ...prev, usn: patient.usn }));
                setSelectedPatientDetails(patient);
                setPatientSearchTerm(`${patient.usn} - ${patient.fullName}`);
                setShowPatientDropdown(false);
                if (errors.usn) {
                    setErrors(prev => ({ ...prev, usn: '' }));
                }
            };

            const handleMedicationChange = (index, field, value) => {
                const newMedications = [...formData.medications];
                
                if (field === 'name' && value === 'custom') {
                    // Set to custom mode but keep the name as 'custom' to show the textbox
                    newMedications[index][field] = value;
                    newMedications[index]['customName'] = '';
                } else if (field === 'customName') {
                    // Update the custom name field
                    newMedications[index]['customName'] = value;
                } else {
                    newMedications[index][field] = value;
                }
                
                setFormData(prev => ({ ...prev, medications: newMedications }));
                if (errors.medications) {
                    setErrors(prev => ({ ...prev, medications: '' }));
                }
            };

            const addMedication = () => {
                setFormData(prev => ({
                    ...prev,
                    medications: [...prev.medications, { name: '', customName: '', dosage: '', frequency: '', duration: '', instructions: '' }]
                }));
            };

            const removeMedication = (index) => {
                setFormData(prev => ({
                    ...prev,
                    medications: prev.medications.filter((_, i) => i !== index)
                }));
            };

            return (
                <div className="space-y-6">
                    <div className="card">
                        <h2 className="text-xl font-semibold mb-4">Create Prescription</h2>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="md:col-span-2 relative">
                                    <label className="block text-sm font-medium mb-1">Select Patient *</label>
                                    <div className="relative">
                                        <input
                                            type="text"
                                            value={patientSearchTerm}
                                            onChange={handlePatientSearch}
                                            placeholder="Type to search patients by name, USN, or phone..."
                                            className="form-input pr-10"
                                            onFocus={() => setShowPatientDropdown(true)}
                                        />
                                        <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
                                            <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                            </svg>
                                        </div>
                                    </div>
                                    
                                    {/* Dropdown with search results */}
                                    {showPatientDropdown && filteredPatients.length > 0 && (
                                        <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                                            {filteredPatients.slice(0, 10).map(patient => (
                                                <div
                                                    key={patient.usn}
                                                    onClick={() => selectPatientFromSearch(patient)}
                                                    className="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                                >
                                                    <div className="font-medium text-gray-900">{patient.fullName}</div>
                                                    <div className="text-sm text-gray-600">
                                                        USN: {patient.usn} • {patient.age} years, {patient.gender}
                                                        {patient.phone && ` • ${patient.phone}`}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Dropdown fallback removed per unified search requirement */}
                                    {errors.usn && <p className="text-red-500 text-sm mt-1">{errors.usn}</p>}
                                </div>

                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium mb-1">Diagnosis *</label>
                                    <textarea
                                        name="diagnosis"
                                        value={formData.diagnosis}
                                        onChange={handleChange}
                                        rows="2"
                                        className="form-input"
                                        placeholder="Primary diagnosis or chief complaint..."
                                    />
                                    {errors.diagnosis && <p className="text-red-500 text-sm">{errors.diagnosis}</p>}
                                </div>
                            </div>

                            <div className="mt-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-medium">Medications</h3>
                                    <button
                                        type="button"
                                        onClick={addMedication}
                                        className="btn btn-secondary text-sm"
                                    >
                                        + Add Medication
                                    </button>
                                </div>
                                {errors.medications && <p className="text-red-500 text-sm mb-3">{errors.medications}</p>}

                                {formData.medications.map((medication, index) => (
                                    <div key={index} className="border rounded-lg p-4 mb-4 bg-gray-50">
                                        <div className="flex justify-between items-center mb-3">
                                            <h4 className="font-medium">Medication {index + 1}</h4>
                                            {formData.medications.length > 1 && (
                                                <button
                                                    type="button"
                                                    onClick={() => removeMedication(index)}
                                                    className="text-red-500 hover:text-red-700 text-sm"
                                                >
                                                    Remove
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Medication *</label>
                                                <select
                                                    value={medication.name}
                                                    onChange={(e) => handleMedicationChange(index, 'name', e.target.value)}
                                                    className="form-input"
                                                >
                                                    <option value="">Select medication...</option>
                                                    {commonMedications.map(med => (
                                                        <option key={med} value={med}>{med}</option>
                                                    ))}
                                                    <option value="custom">Custom (type below)</option>
                                                </select>
                                                {medication.name === 'custom' && (
                                                    <input
                                                        type="text"
                                                        value={medication.customName || ''}
                                                        placeholder="Enter custom medication..."
                                                        onChange={(e) => handleMedicationChange(index, 'customName', e.target.value)}
                                                        className="form-input mt-1"
                                                        autoFocus
                                                    />
                                                )}
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium mb-1">Dosage *</label>
                                                <input
                                                    type="text"
                                                    value={medication.dosage}
                                                    onChange={(e) => handleMedicationChange(index, 'dosage', e.target.value)}
                                                    className="form-input"
                                                    placeholder="e.g., 1 tablet, 5ml"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium mb-1">Frequency *</label>
                                                <select
                                                    value={medication.frequency}
                                                    onChange={(e) => handleMedicationChange(index, 'frequency', e.target.value)}
                                                    className="form-input"
                                                >
                                                    <option value="">Select frequency...</option>
                                                    {frequencies.map(freq => (
                                                        <option key={freq} value={freq}>{freq}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium mb-1">Duration</label>
                                                <select
                                                    value={medication.duration}
                                                    onChange={(e) => handleMedicationChange(index, 'duration', e.target.value)}
                                                    className="form-input"
                                                >
                                                    <option value="">Select duration...</option>
                                                    {durations.map(dur => (
                                                        <option key={dur} value={dur}>{dur}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium mb-1">Instructions</label>
                                                <input
                                                    type="text"
                                                    value={medication.instructions}
                                                    onChange={(e) => handleMedicationChange(index, 'instructions', e.target.value)}
                                                    className="form-input"
                                                    placeholder="e.g., Take with food, Avoid alcohol"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Follow-up Date</label>
                                    <input
                                        type="date"
                                        name="followUpDate"
                                        value={formData.followUpDate}
                                        onChange={handleChange}
                                        className="form-input"
                                        min={new Date().toISOString().split('T')[0]}
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Priority Level</label>
                                    <select
                                        name="priority"
                                        value={formData.priority}
                                        onChange={handleChange}
                                        className="form-input"
                                    >
                                        <option value="Normal">Normal</option>
                                        <option value="Urgent">Urgent</option>
                                        <option value="Critical">Critical</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Additional Notes</label>
                                    <textarea
                                        name="notes"
                                        value={formData.notes}
                                        onChange={handleChange}
                                        rows="2"
                                        className="form-input"
                                        placeholder="Additional instructions or notes..."
                                    />
                                </div>
                            </div>

                            <div className="mt-6 flex gap-4">
                                <button type="submit" className="btn btn-primary">
                                    Create Prescription
                                </button>
                                <button 
                                    type="button" 
                                    onClick={async () => {
                                        console.log('Testing database connection...');
                                        const isHealthy = await checkServerHealth();
                                        console.log('Server health check result:', isHealthy);
                                        serverAvailable = isHealthy;
                                        
                                        if (isHealthy) {
                                            alert('✅ Database connection successful!');
                                        } else {
                                            alert('❌ Database connection failed. Please ensure the Python server is running on localhost:5000');
                                        }
                                    }}
                                    className="btn bg-blue-500 hover:bg-blue-600 text-white"
                                >
                                    🔧 Test DB Connection
                                </button>
                            </div>
                        </form>
                    </div>

                    {selectedPatientDetails && patientPrescriptions.length > 0 && (
                        <div className="card">
                            <h3 className="text-lg font-semibold mb-4">Recent Prescriptions for {selectedPatientDetails.fullName}</h3>
                            <div className="space-y-4">
                                {patientPrescriptions.map((prescription) => (
                                    <div key={prescription.id} className="border rounded-lg p-4 bg-gray-50">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <div className="font-medium">{prescription.diagnosis}</div>
                                                <div className="text-sm text-gray-600">
                                                    {(() => {
                                                        const ts = prescription.prescribedAtIST || prescription.prescribedAt;
                                                        if (!ts) return 'N/A';
                                                        try {
                                                            const d = new Date(ts);
                                                            return `${d.toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' })}` + ' - ' + prescription.prescribedBy;
                                                        } catch { return 'N/A - ' + prescription.prescribedBy; }
                                                    })()}
                                                </div>
                                            </div>
                                            <span className={`badge ${prescription.status === 'Active' ? 'badge-green' : 'badge-blue'}`}>
                                                {prescription.status}
                                            </span>
                                        </div>
                                        <div className="text-sm">
                                            <strong>Medications:</strong> {(prescription.medications || []).map(m => m?.name || 'Unnamed medication').join(', ') || 'No medications listed'}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
            } catch (error) {
                console.error('PrescriptionForm Error:', error);
                return (
                    <div className="card p-6 text-center">
                        <h2 className="text-xl font-semibold mb-4 text-red-600">Prescription Form Error</h2>
                        <p className="text-gray-600 mb-4">There was an error loading the prescription form.</p>
                        <p className="text-sm text-gray-500">Error: {error.message}</p>
                        <button 
                            onClick={() => window.location.reload()} 
                            className="btn btn-primary mt-4"
                        >
                            Reload Page
                        </button>
                    </div>
                );
            }
        };

        // Prescription Management Component with Error Handling
        const PrescriptionManagement = ({ patients, prescriptions, setPrescriptions }) => {
            try {
                const [searchTerm, setSearchTerm] = useState('');
                const [selectedPrescription, setSelectedPrescription] = useState(null);

                // Add safety checks for prescriptions array
                const safePrescriptions = prescriptions || [];
                const safePatients = patients || [];

            const filteredPrescriptions = safePrescriptions.filter(prescription => {
                if (!prescription) return false;
                
                const patientName = String(prescription.patientName || '');
                const usn = String(prescription.usn || '');
                const diagnosis = String(prescription.diagnosis || '');
                const prescriptionId = String(prescription.id || '');
                
                // Get patient phone number from patients array
                const patient = safePatients.find(p => p.usn === prescription.usn);
                const phoneNumber = String(patient?.phoneNumber || patient?.phone || '');
                
                const searchTermLower = searchTerm.toLowerCase();
                const matchesSearch = patientName.toLowerCase().includes(searchTermLower) ||
                                    usn.toLowerCase().includes(searchTermLower) ||
                                    diagnosis.toLowerCase().includes(searchTermLower) ||
                                    prescriptionId.toLowerCase().includes(searchTermLower) ||
                                    phoneNumber.toLowerCase().includes(searchTermLower);
                return matchesSearch;
            });

            const printPrescription = (prescription) => {
                if (!prescription) return;
                
                const printWindow = window.open('', '_blank');
                const currentDate = new Date().toLocaleDateString();
                const currentTime = new Date().toLocaleTimeString();
                
                // Safe property access with defaults
                const patientName = prescription.patientName || 'Unknown Patient';
                const patientAge = prescription.patientAge || 'N/A';
                const patientGender = prescription.patientGender || 'N/A';
                const usn = prescription.usn || 'N/A';
                const diagnosis = prescription.diagnosis || 'No diagnosis provided';
                const prescribedBy = prescription.prescribedBy || 'NHCE Clinic';
                const prescribedAt = prescription.prescribedAtIST || prescription.prescribedAt || new Date().toISOString();
                const medications = prescription.medications || [];
                const notes = prescription.notes || '';
                const followUpDate = prescription.followUpDate || '';
                
                const logoUrl = new URL('./nhce_25-scaled-1-2048x683.png', window.location.href).href;
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Prescription - ${prescription.patientName}</title>
                        <style>
                            @media print {
                                @page {
                                    /* Reduce top/bottom margins to fit more content per page */
                                    margin: 0.25in 0.35in 0.25in 0.35in;
                                    size: A4;
                                }
                                /* Minimize inner padding/margins on print */
                                html, body { margin: 0; padding: 0.05in 0.1in; }
                                body { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.35; color: #000; }
                                .no-print { display: none; }
                                /* Keep signature and footer together */
                                .signature-and-footer, .footer, .signature-section {
                                    /* Try hard to keep these together */
                                    page-break-inside: avoid;
                                    break-inside: avoid;
                                    -webkit-column-break-inside: avoid;
                                    -webkit-region-break-inside: avoid;
                                    orphans: 100; widows: 100;
                                }
                                .signature-and-footer {
                                    /* Make the block atomic so it moves as a unit to next page if needed */
                                    display: inline-block;
                                    width: 100%;
                                    break-before: avoid-page;
                                    page-break-before: auto;
                                    page-break-after: avoid;
                                    margin-top: 14px;
                                }
                                img { max-width: 100%; height: auto; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                            }
                            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 10px; }
                            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 5px; margin-bottom: 15px; }
                            .clinic-name { font-size: 24px; font-weight: bold; color: #2563eb; margin-bottom: 3px; }
                            .clinic-subtitle { font-size: 14px; color: #666; margin-bottom: 2px; }
                            .clinic-contact { font-size: 12px; color: #555; }
                            .prescription-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
                            .patient-info, .prescription-info { flex: 1; }
                            .patient-info { margin-right: 20px; }
                            .info-row { margin-bottom: 8px; }
                            .label { font-weight: bold; display: inline-block; width: 100px; }
                            .diagnosis { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; }
                            .medications { margin: 20px 0; }
                            .medication-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
                            .medication-name { font-weight: bold; font-size: 14px; color: #1e40af; }
                            .medication-details { margin-top: 5px; color: #555; }
                            .notes { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107; }
                            .footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center; font-size: 10px; color: #666; }
                            .signature-section { margin-top: 40px; text-align: right; page-break-inside: avoid; }
                            .signature-line { border-bottom: 1px solid #333; width: 200px; display: inline-block; margin-bottom: 5px; }
                            .btn { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 10px 5px; }
                            .btn:hover { background: #0056b3; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                                <img src="${logoUrl}" alt="NHCE Logo" style="height: 60px; margin-right: 15px;" />
                                <div style="text-align: left;">
                                    <div class="clinic-name">New Horizon Sanjeevani Clinic</div>
                                    <div class="clinic-subtitle">New Horizon Knowledge Park, Outer Ring Rd, near Marathalli, Kaverappa Layout, Kadubeesanahalli, Bengaluru, Karnataka - 560103.</div>
                                    <div class="clinic-contact">Contact : Manoj VRC Swami  +91 81472 91675<br>Amrutha Varshi D +91 63625 88851</div>
                                </div>
                            </div>
                        </div>

                        <div class="prescription-header">
                            <div class="patient-info">
                                <h3 style="margin-top: 0; color: #333;">Patient Information</h3>
                                <div class="info-row"><span class="label">Name:</span> ${patientName}</div>
                                <div class="info-row"><span class="label">USN:</span> ${usn}</div>
                                <div class="info-row"><span class="label">Age:</span> ${patientAge} years</div>
                                <div class="info-row"><span class="label">Gender:</span> ${patientGender}</div>
                            </div>
                            <div class="prescription-info">
                                <h3 style="margin-top: 0; color: #333;">Prescription Details</h3>
                                <div class="info-row"><span class="label">Date:</span> ${new Date(prescribedAt).toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' })}</div>
                                <div class="info-row"><span class="label">Time:</span> ${new Date(prescribedAt).toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata' })}</div>
                                <div class="info-row"><span class="label">Doctor:</span> ${prescribedBy}</div>
                                <div class="info-row"><span class="label">Rx ID:</span> RX-${prescription.id}</div>
                            </div>
                        </div>

                        <div class="diagnosis">
                            <strong>Diagnosis:</strong> ${diagnosis}
                        </div>

                        <div class="medications">
                            <h3 style="color: #333; margin-bottom: 15px;">Prescribed Medications</h3>
                            ${medications.map((med, index) => `
                                <div class="medication-item">
                                    <div class="medication-name">${index + 1}. ${med.name || 'Unnamed medication'}</div>
                                    <div class="medication-details">
                                        <strong>Dosage:</strong> ${med.dosage || 'Not specified'} | 
                                        <strong>Frequency:</strong> ${med.frequency || 'Not specified'}
                                        ${med.duration ? ` | <strong>Duration:</strong> ${med.duration}` : ''}
                                    </div>
                                    ${med.instructions ? `<div style="margin-top: 5px; font-style: italic;">Instructions: ${med.instructions}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>

                        ${notes ? `
                            <div class="notes">
                                <strong>Additional Notes:</strong><br>
                                ${notes}
                            </div>
                        ` : ''}

                        ${followUpDate ? `
                            <div style="margin: 15px 0; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                                <strong>Follow-up Date:</strong> ${new Date(followUpDate).toLocaleDateString()}
                            </div>
                        ` : ''}

                        <div class="signature-and-footer">
                            <div class="signature-section">
                                <div class="signature-line"></div><br>
                                <strong>${prescribedBy}</strong><br>
                                <small>Authorized Prescriber</small>
                            </div>

                            <div class="footer">
                                <p><strong>New Horizon Sanjeevani Clinic</strong></p>
                                <p>This prescription is computer generated and valid for the medications listed above.</p>
                                <p>Printed on: ${currentDate} at ${currentTime}</p>
                                <p style="margin-top: 10px;">© ${new Date().getFullYear()} Hospital Management Information System - LeadOnyx Apex LLP</p>
                                <p>Contact : Raj Goyal +91 79922 47030 · rajgoyal@duck.com · USN: 1NH23CS329</p>
                            </div>
                        </div>

                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="window.print()">🖨️ Print Prescription</button>
                            <button class="btn" onclick="window.close()" style="background: #6c757d;">✕ Close</button>
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                // Auto-print after a short delay
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };

            const updatePrescriptionPriority = async (prescriptionId, newPriority) => {
                console.log('Updating prescription priority:', prescriptionId, newPriority);
                console.log('Current prescriptions:', prescriptions);
                
                const prescriptionFound = prescriptions.find(p => p.id === prescriptionId);
                if (!prescriptionFound) {
                    console.error('Prescription not found with ID:', prescriptionId);
                    throw new Error('Prescription not found');
                }
                
                const updatedPrescriptions = prescriptions.map(p => {
                    if (p.id === prescriptionId) {
                        console.log('Found matching prescription:', p);
                        return { ...p, priority: newPriority, updatedAt: Date.now() };
                    }
                    return p;
                });
                
                console.log('Updated prescriptions:', updatedPrescriptions);
                setPrescriptions([...updatedPrescriptions]);
                saveToStorage('prescriptions', updatedPrescriptions);
                
                console.log(`Prescription priority updated to ${newPriority}`);
            };

            return (
                <div className="card">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-semibold">Prescription Management</h2>
                        <div className="flex gap-4">
                            <input
                                type="text"
                                placeholder="Search by patient name, USN, phone, diagnosis, or Rx ID..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="form-input w-64"
                            />
                        </div>
                    </div>
                    
                    {searchTerm && (
                        <div className="mb-4 text-sm text-gray-600">
                            <span className="font-medium">Searching for:</span> "{searchTerm}" 
                            <span className="ml-2 text-gray-500">
                                (searches patient name, USN, phone number, diagnosis, and prescription ID)
                            </span>
                        </div>
                    )}

                    {filteredPrescriptions.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">
                            {searchTerm ? 'No prescriptions found matching your criteria.' : 'No prescriptions created yet.'}
                        </p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Patient</th>
                                        <th>USN</th>
                                        <th>Diagnosis</th>
                                        <th>Medications</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredPrescriptions.map((prescription) => (
                                        <tr key={prescription.id}>
                                            <td>{(() => {
                                                const ts = prescription.prescribedAtIST || prescription.prescribedAt;
                                                if (!ts) return 'N/A';
                                                try { return new Date(ts).toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' }); } catch { return 'N/A'; }
                                            })()}</td>
                                            <td>{prescription.patientName}</td>
                                            <td>{prescription.usn}</td>
                                            <td>{prescription.diagnosis}</td>
                                            <td>
                                                <div className="text-sm">
                                                    {(prescription.medications || []).slice(0, 2).map(med => med?.name || 'Unnamed medication').join(', ')}
                                                    {(prescription.medications || []).length > 2 && `... (+${(prescription.medications || []).length - 2} more)`}
                                                </div>
                                            </td>
                                            <td>
                                                <div className="flex gap-1">
                                                    <button
                                                        onClick={() => printPrescription(prescription)}
                                                        className="btn btn-primary text-xs"
                                                        title="Print Prescription"
                                                    >
                                                        🖨️ Print
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        } catch (error) {
            console.error('PrescriptionManagement Error:', error);
            return (
                <div className="card p-6 text-center">
                    <h2 className="text-xl font-semibold mb-4 text-red-600">Prescription Management Error</h2>
                    <p className="text-gray-600 mb-4">There was an error loading the prescription management page.</p>
                        <p className="text-sm text-gray-500">Error: {error.message}</p>
                        <button 
                            onClick={() => window.location.reload()} 
                            className="btn btn-primary mt-4"
                        >
                            Reload Page
                        </button>
                    </div>
                );
            }
        };

        // CSV Export Component
        const ExportData = ({ patients, vitals, prescriptions }) => {
            // --- Helpers ---
            const escapeCSV = (val) => {
                if (val === null || val === undefined) return '';
                let str = String(val);
                if (str.includes('"')) str = str.replace(/"/g, '""');
                if (/[",\n]/.test(str)) str = `"${str}"`;
                return str;
            };

            const downloadCSV = (rows, filename, columns, headers) => {
                if (!rows || rows.length === 0) {
                    alert('No data to export');
                    return;
                }
                const headerLine = (headers || columns).map(escapeCSV).join(',');
                const dataLines = rows.map(r => columns.map(col => escapeCSV(r[col])).join(','));
                const csvContent = [headerLine, ...dataLines].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            // Attempt server export then fallback to shaped local data
            const tryDatabaseExport = async (endpoint, shapedData, filename, columns, headers) => {
                let success = false;
                try {
                    console.log(`Attempting database export for ${endpoint}...`);
                    const response = await fetch(`${BACKEND_BASE}/api/export/${endpoint}`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        alert(`${endpoint} exported successfully from database!`);
                        success = true;
                    } else {
                        console.warn(`Database export failed for ${endpoint}, status: ${response.status}`);
                    }
                } catch (err) {
                    console.warn(`Database export failed for ${endpoint}:`, err);
                }
                if (!success) {
                    console.log(`Falling back to local shaped data for ${endpoint}`);
                    downloadCSV(shapedData, filename, columns, headers);
                    alert(`${endpoint} exported from local data (database not available)`);
                }
                return success;
            };

            // --- Shape Data ---
            const shapePatients = () => patients.map(p => ({
                usn: p.usn,
                fullName: p.fullName,
                age: p.age,
                gender: p.gender,
                phone: p.phone || '',
                email: p.email || '',
                address: p.address || '',
                createdAt: p.createdAt || ''
            }));
            const patientCols = ['usn','fullName','age','gender','phone','email','address','createdAt'];
            const patientHeaders = ['USN','Full Name','Age','Gender','Phone','Email','Address','Created At'];

            const shapeVitals = () => vitals.map(v => ({
                id: v.id,
                usn: v.usn,
                patientName: v.patientName || '',
                weight: v.weight ?? '',
                height: v.height ?? '',
                bmi: v.bmi ?? '',
                systolic: v.bloodPressureSystolic ?? '',
                diastolic: v.bloodPressureDiastolic ?? '',
                heartRate: v.heartRate ?? '',
                temperature: v.temperature ?? '',
                respiratoryRate: v.respiratoryRate ?? '',
                oxygenSaturation: v.oxygenSaturation ?? '',
                recordedAt: v.recordedAt || '',
                recordedBy: v.recordedBy || ''
            }));
            const vitalsCols = ['id','usn','patientName','weight','height','bmi','systolic','diastolic','heartRate','temperature','respiratoryRate','oxygenSaturation','recordedAt','recordedBy'];
            const vitalsHeaders = ['ID','USN','Patient Name','Weight(kg)','Height(cm)','BMI','Systolic','Diastolic','Heart Rate','Temp(°C)','Resp Rate','SpO2','Recorded At','Recorded By'];

            const flattenMedications = (medList) => (medList || []).map(m => `${m.name} (${m.dosage || ''}; ${m.frequency || ''}${m.duration ? '; ' + m.duration : ''})${m.instructions ? ' - ' + m.instructions : ''}`).join(' | ');

            const shapePrescriptions = () => prescriptions.map(p => ({
                id: p.id,
                usn: p.usn,
                patientName: p.patientName || '',
                age: p.patientAge || '',
                gender: p.patientGender || '',
                diagnosis: p.diagnosis || '',
                medications: flattenMedications(p.medications),
                followUpDate: p.followUpDate || '',
                prescribedAt: p.prescribedAt || '',
                prescribedAtIST: p.prescribedAtIST || '',
                prescribedBy: p.prescribedBy || '',
                priority: p.priority || '',
                notes: (p.notes || '').replace(/\n/g,' '),
                status: p.status || ''
            }));
            const prescriptionCols = ['id','usn','patientName','age','gender','diagnosis','medications','followUpDate','prescribedAt','prescribedAtIST','prescribedBy','priority','notes','status'];
            const prescriptionHeaders = ['ID','USN','Patient Name','Age','Gender','Diagnosis','Medications','Follow Up','Prescribed At','Prescribed At (IST)','Prescribed By','Priority','Notes','Status'];

            const getAllDataForExport = () => patients.map(p => {
                const vRecs = vitals.filter(v => v.usn === p.usn);
                const latest = vRecs.length ? vRecs[vRecs.length - 1] : {};
                const pres = prescriptions.filter(pr => pr.usn === p.usn);
                return {
                    usn: p.usn,
                    fullName: p.fullName,
                    age: p.age,
                    gender: p.gender,
                    phone: p.phone || '',
                    email: p.email || '',
                    latestWeight: latest.weight ?? '',
                    latestHeight: latest.height ?? '',
                    latestBMI: latest.bmi ?? '',
                    latestSystolic: latest.bloodPressureSystolic ?? '',
                    latestDiastolic: latest.bloodPressureDiastolic ?? '',
                    latestHeartRate: latest.heartRate ?? '',
                    latestTemperature: latest.temperature ?? '',
                    totalVitals: vRecs.length,
                    totalPrescriptions: pres.length
                };
            });
            const completeCols = ['usn','fullName','age','gender','phone','email','latestWeight','latestHeight','latestBMI','latestSystolic','latestDiastolic','latestHeartRate','latestTemperature','totalVitals','totalPrescriptions'];
            const completeHeaders = ['USN','Full Name','Age','Gender','Phone','Email','Latest Weight','Latest Height','Latest BMI','Latest Systolic','Latest Diastolic','Latest HR','Latest Temp','Total Vitals','Total Prescriptions'];

            // --- Export Triggers ---
            const exportPatients = () => tryDatabaseExport('patients', shapePatients(), 'patients.csv', patientCols, patientHeaders);
            const exportVitals = () => tryDatabaseExport('vitals', shapeVitals(), 'vitals.csv', vitalsCols, vitalsHeaders);
            const exportPrescriptions = () => tryDatabaseExport('prescriptions', shapePrescriptions(), 'prescriptions.csv', prescriptionCols, prescriptionHeaders);
            const exportAllData = () => tryDatabaseExport('complete', getAllDataForExport(), 'complete_patient_data.csv', completeCols, completeHeaders);

            return (
                <div className="card">
                    <h2 className="text-xl font-semibold mb-4">Export Data</h2>
                    
                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                        <div className="p-4 border rounded-lg">
                            <h3 className="font-medium mb-2">Patients</h3>
                            <p className="text-sm text-gray-600 mb-3">{patients.length} records</p>
                            <button 
                                onClick={exportPatients}
                                className="btn btn-primary w-full text-sm"
                                disabled={patients.length === 0}
                            >
                                Export Patients CSV
                            </button>
                        </div>

                        <div className="p-4 border rounded-lg">
                            <h3 className="font-medium mb-2">Vitals</h3>
                            <p className="text-sm text-gray-600 mb-3">{vitals.length} records</p>
                            <button 
                                onClick={exportVitals}
                                className="btn btn-primary w-full text-sm"
                                disabled={vitals.length === 0}
                            >
                                Export Vitals CSV
                            </button>
                        </div>

                        <div className="p-4 border rounded-lg">
                            <h3 className="font-medium mb-2">Prescriptions</h3>
                            <p className="text-sm text-gray-600 mb-3">{prescriptions.length} records</p>
                            <button 
                                onClick={exportPrescriptions}
                                className="btn btn-primary w-full text-sm"
                                disabled={prescriptions.length === 0}
                            >
                                Export Prescriptions CSV
                            </button>
                        </div>

                        <div className="p-4 border rounded-lg bg-blue-50">
                            <h3 className="font-medium mb-2">Complete Data</h3>
                            <p className="text-sm text-gray-600 mb-3">All patient info with latest vitals</p>
                            <button 
                                onClick={exportAllData}
                                className="btn btn-primary w-full text-sm"
                                disabled={patients.length === 0}
                            >
                                Export All Data CSV
                            </button>
                        </div>
                    </div>

                    <div className="mt-6 p-4 bg-gray-50 rounded">
                        <h4 className="font-medium mb-2">Export Information:</h4>
                        <ul className="text-sm text-gray-600 space-y-1">
                            <li>• <strong>Patients CSV:</strong> Basic patient information</li>
                            <li>• <strong>Vitals CSV:</strong> All recorded vital signs</li>
                            <li>• <strong>Prescriptions CSV:</strong> All prescription records</li>
                            <li>• <strong>Complete Data CSV:</strong> Comprehensive report with patient info + latest vitals + prescription counts</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // Patient List Component
        const PatientList = ({ patients, onEdit, onDelete }) => {
            const [searchTerm, setSearchTerm] = useState('');

            const printPatient = (patient) => {
                if (!patient) return;
                const printWindow = window.open('', '_blank');
                const currentDate = new Date().toLocaleDateString('en-IN');
                const currentTime = new Date().toLocaleTimeString('en-IN');
                const safe = {
                    usn: patient.usn || 'N/A',
                    fullName: patient.fullName || 'N/A',
                    age: patient.age ?? 'N/A',
                    gender: patient.gender || 'N/A',
                    phone: patient.phone || 'N/A',
                    email: patient.email || 'N/A',
                    address: patient.address || 'N/A',
                };
                const logoUrl = new URL('./nhce_25-scaled-1-2048x683.png', window.location.href).href;
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Patient Details - ${safe.fullName}</title>
                        <style>
                            @media print { @page { size: A4; margin: 0.25in 0.35in; } html,body{margin:0;padding:0.05in 0.1in;} .no-print{display:none} }
                            body{ font-family: Arial, sans-serif; max-width:800px; margin:0 auto; padding:10px; color:#000; }
                            .header{ text-align:center; border-bottom:2px solid #333; padding-bottom:6px; margin-bottom:12px; }
                            .clinic-name{ font-size:20px; font-weight:bold; color:#2563eb; }
                            .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
                            .label{ font-weight:bold; display:inline-block; min-width:110px; }
                            .section{ margin:14px 0; }
                            .footer{ margin-top:18px; padding-top:10px; border-top:1px solid #ddd; font-size:9px; color:#666; text-align:center; }
                            .footer p { margin: 2px 0; }
                            .btn{ background:#16a34a; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; }
                            .btn:hover{ background:#15803d; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div style="display:flex; align-items:center; justify-content:center; gap:12px;">
                                <img src="${logoUrl}" alt="NHCE Logo" style="height:50px;" />
                                <div style="text-align:left;">
                                    <div class="clinic-name">New Horizon Sanjeevani Clinic</div>
                                    <div style="font-size:12px;color:#555">New Horizon Knowledge Park, Outer Ring Rd, near Marathalli, Kaverappa Layout, Kadubeesanahalli, Bengaluru, Karnataka - 560103.</div>
                                </div>
                            </div>
                        </div>
                        <h2 style="margin:0 0 8px 0;">Patient Details</h2>
                        <div class="section">
                            <div><span class="label">Name:</span> ${safe.fullName}</div>
                            <div><span class="label">USN:</span> ${safe.usn}</div>
                            <div><span class="label">Age:</span> ${safe.age}</div>
                            <div><span class="label">Gender:</span> ${safe.gender}</div>
                            <div><span class="label">Phone:</span> ${safe.phone}</div>
                            <div><span class="label">Email:</span> ${safe.email}</div>
                            <div><span class="label">Address:</span> ${safe.address}</div>
                        </div>
                        <div class="footer">
                            <p><strong>New Horizon Sanjeevani Clinic</strong></p>
                            <p>This document is computer generated and issued by the clinic.</p>
                            <p>Contact : Raj Goyal +91 79922 47030 · rajgoyal@duck.com · USN: 1NH23CS329</p>
                            <p>Printed on: ${currentDate} at ${currentTime}</p>
                            <p style="margin-top: 6px;">© ${new Date().getFullYear()} Hospital Management Information System - LeadOnyx Apex LLP</p>
                        </div>
                        <div class="no-print" style="text-align:center; margin-top:12px;">
                            <button class="btn" onclick="window.print()">🖨️ Print</button>
                            <button class="btn" onclick="window.close()" style="background:#6c757d; margin-left:6px;">✕ Close</button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => printWindow.print(), 300);
            };

            const filteredPatients = patients.filter(patient =>
                patient.fullName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                patient.usn.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="card">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-semibold">Patient List</h2>
                        <input
                            type="text"
                            placeholder="Search patients..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="form-input w-64"
                        />
                    </div>

                    {filteredPatients.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">
                            {searchTerm ? 'No patients found matching your search.' : 'No patients added yet.'}
                        </p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>USN</th>
                                        <th>Full Name</th>
                                        <th>Age</th>
                                        <th>Gender</th>
                                        <th>Phone</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredPatients.map((patient) => (
                                        <tr key={patient.usn}>
                                            <td>{patient.usn}</td>
                                            <td>{patient.fullName}</td>
                                            <td>{patient.age}</td>
                                            <td>
                                                <span className={`badge ${
                                                    patient.gender === 'Male' ? 'badge-blue' : 
                                                    patient.gender === 'Female' ? 'badge-red' : 'badge-green'
                                                }`}>
                                                    {patient.gender}
                                                </span>
                                            </td>
                                            <td>{patient.phone || 'N/A'}</td>
                                            <td>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => onEdit(patient)}
                                                        className="btn btn-primary text-sm"
                                                        title="Edit patient"
                                                    >
                                                        Edit
                                                    </button>
                                                    <button
                                                        onClick={() => printPatient(patient)}
                                                        className="btn btn-success text-sm"
                                                        title="Print patient details"
                                                    >
                                                        🖨️ Print
                                                    </button>
                                                    <button
                                                        onClick={() => onDelete(patient.usn)}
                                                        className="btn btn-secondary text-sm"
                                                        title="Delete patient"
                                                    >
                                                        Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // Case Report Management Component
        const CaseReportManagement = ({ patients, caseReports, setCaseReports, sickIntimations, setSickIntimations }) => {
            const [subTab, setSubTab] = useState('case-report');
            const [formData, setFormData] = useState({
                usn: '',
                reportType: 'medical',
                chiefComplaint: '',
                historyOfPresentIllness: '',
                pastMedicalHistory: '',
                familyHistory: '',
                socialHistory: '',
                physicalExamination: '',
                investigations: '',
                diagnosis: '',
                treatment: '',
                prognosis: '',
                recommendations: '',
                followUp: '',
                doctorName: 'Mr. Manoj VRC Swami NH-1581',
                reportDate: new Date().toISOString().split('T')[0]
            });
            const [sickFormData, setSickFormData] = useState({
                usn: '',
                sickLeaveFrom: '',
                sickLeaveTo: '',
                totalDays: '',
                reason: '',
                symptoms: '',
                restRecommended: true,
                doctorName: 'Mr. Manoj VRC Swami NH-1581',
                issueDate: new Date().toISOString().split('T')[0],
                caseReportId: '' // Link to case report
            });
            const [errors, setErrors] = useState({});
            const [selectedPatientDetails, setSelectedPatientDetails] = useState(null);
            // Unified search states
            const [caseSearchTerm, setCaseSearchTerm] = useState('');
            const [sickSearchTerm, setSickSearchTerm] = useState('');
            const [showCasePatientDropdown, setShowCasePatientDropdown] = useState(false);
            const [showSickPatientDropdown, setShowSickPatientDropdown] = useState(false);

            const safePatients = patients || [];
            const safeCaseReports = caseReports || [];
            const safeSickIntimations = sickIntimations || [];

            // Generate unique IDs for reports
            const generateCaseReportNumber = () => {
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `CR-${new Date().getFullYear()}-${timestamp.toString().slice(-6)}-${random}`;
            };

            const generateSickIntimationNumber = (caseReportNumber) => {
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                const baseNumber = caseReportNumber ? caseReportNumber.split('-').slice(-2).join('') : timestamp.toString().slice(-6);
                return `SI-${new Date().getFullYear()}-${baseNumber}-${random}`;
            };

            const [currentCaseReportNumber, setCurrentCaseReportNumber] = useState('');
            const [currentSickIntimationNumber, setCurrentSickIntimationNumber] = useState('');

            const handlePatientSelect = (e, formType = 'case') => {
                const usn = e.target.value;
                const patient = safePatients.find(p => p.usn === usn);
                setSelectedPatientDetails(patient);
                
                if (formType === 'case') {
                    setFormData(prev => ({ ...prev, usn }));
                } else {
                    setSickFormData(prev => ({ ...prev, usn }));
                    
                    // Auto-populate case report ID from latest case report for this patient
                    const patientCaseReports = safeCaseReports.filter(cr => cr.usn === usn);
                    if (patientCaseReports.length > 0) {
                        const latestCaseReport = patientCaseReports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                        setSickFormData(prev => ({ ...prev, caseReportId: latestCaseReport.reportNumber }));
                    }
                }
            };

            // Filter helpers
            const filteredCasePatients = caseSearchTerm
                ? safePatients.filter(p => {
                    const t = caseSearchTerm.toLowerCase();
                    return p.usn.toLowerCase().includes(t) || p.fullName.toLowerCase().includes(t);
                })
                : safePatients;
            const filteredSickPatients = sickSearchTerm
                ? safePatients.filter(p => {
                    const t = sickSearchTerm.toLowerCase();
                    return p.usn.toLowerCase().includes(t) || p.fullName.toLowerCase().includes(t);
                })
                : safePatients;

            const selectCasePatient = (patient) => {
                setFormData(prev => ({ ...prev, usn: patient.usn }));
                setSelectedPatientDetails(patient);
                setCaseSearchTerm(`${patient.usn} - ${patient.fullName}`);
                setShowCasePatientDropdown(false);
            };
            const selectSickPatient = (patient) => {
                setSickFormData(prev => ({ ...prev, usn: patient.usn }));
                setSelectedPatientDetails(patient);
                setSickSearchTerm(`${patient.usn} - ${patient.fullName}`);
                // Auto-populate case report id
                const patientCaseReports = safeCaseReports.filter(cr => cr.usn === patient.usn);
                if (patientCaseReports.length > 0) {
                    const latestCaseReport = patientCaseReports.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt))[0];
                    setSickFormData(prev => ({ ...prev, caseReportId: latestCaseReport.reportNumber }));
                }
                setShowSickPatientDropdown(false);
            };

            useEffect(() => {
                const onDocClick = (e) => {
                    if (!e.target.closest('.case-patient-search')) setShowCasePatientDropdown(false);
                    if (!e.target.closest('.sick-patient-search')) setShowSickPatientDropdown(false);
                };
                document.addEventListener('click', onDocClick);
                return () => document.removeEventListener('click', onDocClick);
            }, []);

            const calculateDays = (fromDate, toDate) => {
                if (fromDate && toDate) {
                    const from = new Date(fromDate);
                    const to = new Date(toDate);
                    const diffTime = Math.abs(to - from);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    return diffDays;
                }
                return '';
            };

            const handleSickDateChange = (field, value) => {
                setSickFormData(prev => {
                    const updated = { ...prev, [field]: value };
                    if (field === 'sickLeaveFrom' || field === 'sickLeaveTo') {
                        updated.totalDays = calculateDays(
                            field === 'sickLeaveFrom' ? value : prev.sickLeaveFrom,
                            field === 'sickLeaveTo' ? value : prev.sickLeaveTo
                        );
                    }
                    return updated;
                });
            };

            // Handle Case Report Submission
            const handleCaseReportSubmit = async () => {
                if (!formData.usn || !formData.diagnosis) {
                    alert('Please select a patient and provide a diagnosis');
                    return;
                }

                const reportNumber = generateCaseReportNumber();
                setCurrentCaseReportNumber(reportNumber);

                const caseReportRecord = {
                    id: Date.now().toString(),
                    reportNumber: reportNumber,
                    usn: formData.usn,
                    patientName: selectedPatientDetails?.fullName || '',
                    patientAge: selectedPatientDetails?.age || '',
                    patientGender: selectedPatientDetails?.gender || '',
                    reportType: formData.reportType,
                    chiefComplaint: formData.chiefComplaint,
                    historyOfPresentIllness: formData.historyOfPresentIllness,
                    pastMedicalHistory: formData.pastMedicalHistory,
                    familyHistory: formData.familyHistory,
                    socialHistory: formData.socialHistory,
                    physicalExamination: formData.physicalExamination,
                    investigations: formData.investigations,
                    diagnosis: formData.diagnosis,
                    treatment: formData.treatment,
                    prognosis: formData.prognosis,
                    recommendations: formData.recommendations,
                    followUp: formData.followUp,
                    doctorName: formData.doctorName,
                    reportDate: formData.reportDate,
                    createdAt: new Date().toISOString(),
                    status: 'Active'
                };

                const newCaseReports = [...safeCaseReports, caseReportRecord];
                setCaseReports(newCaseReports);
                saveToStorage('caseReports', newCaseReports);

                // Sync with database
                const dbCaseReportData = {
                    reportNumber: reportNumber,
                    usn: formData.usn,
                    patientName: selectedPatientDetails?.fullName || '',
                    reportType: formData.reportType,
                    chiefComplaint: formData.chiefComplaint,
                    historyOfPresentIllness: formData.historyOfPresentIllness,
                    pastMedicalHistory: formData.pastMedicalHistory,
                    familyHistory: formData.familyHistory,
                    physicalExamination: formData.physicalExamination,
                    investigations: formData.investigations,
                    diagnosis: formData.diagnosis,
                    treatment: formData.treatment,
                    recommendations: formData.recommendations,
                    doctorName: formData.doctorName,
                    reportDate: formData.reportDate
                };

                const syncResult = await syncWithDatabase('case-reports', dbCaseReportData);
                
                if (syncResult) {
                    alert(`Case Report ${reportNumber} created and synced to database successfully!`);
                } else {
                    alert(`Case Report ${reportNumber} created locally. Will sync to database when server is available.`);
                }

                // Reset form
                setFormData({
                    usn: '',
                    reportType: 'medical',
                    chiefComplaint: '',
                    historyOfPresentIllness: '',
                    pastMedicalHistory: '',
                    familyHistory: '',
                    socialHistory: '',
                    physicalExamination: '',
                    investigations: '',
                    diagnosis: '',
                    treatment: '',
                    prognosis: '',
                    recommendations: '',
                    followUp: '',
                    doctorName: 'Mr. Manoj VRC Swami NH-1581',
                    reportDate: new Date().toISOString().split('T')[0]
                });
                setSelectedPatientDetails(null);
            };

            // Handle Sick Intimation Submission
            const handleSickIntimationSubmit = async () => {
                if (!sickFormData.usn || !sickFormData.reason || !sickFormData.sickLeaveFrom || !sickFormData.sickLeaveTo) {
                    alert('Please fill all required fields');
                    return;
                }

                // Check if there's a valid case report for this patient
                const patientCaseReports = safeCaseReports.filter(cr => cr.usn === sickFormData.usn);
                if (patientCaseReports.length === 0) {
                    alert('Sick intimation can only be created if there is a valid case report for this patient. Please create a case report first.');
                    return;
                }

                const intimationNumber = generateSickIntimationNumber(sickFormData.caseReportId || patientCaseReports[0].reportNumber);
                setCurrentSickIntimationNumber(intimationNumber);

                const sickIntimationRecord = {
                    id: Date.now().toString(),
                    intimationNumber: intimationNumber,
                    usn: sickFormData.usn,
                    patientName: selectedPatientDetails?.fullName || '',
                    patientAge: selectedPatientDetails?.age || '',
                    patientGender: selectedPatientDetails?.gender || '',
                    caseReportId: sickFormData.caseReportId || patientCaseReports[0].reportNumber,
                    sickLeaveFrom: sickFormData.sickLeaveFrom,
                    sickLeaveTo: sickFormData.sickLeaveTo,
                    totalDays: sickFormData.totalDays,
                    reason: sickFormData.reason,
                    symptoms: sickFormData.symptoms,
                    restRecommended: sickFormData.restRecommended,
                    doctorName: sickFormData.doctorName,
                    issueDate: sickFormData.issueDate,
                    createdAt: new Date().toISOString(),
                    status: 'Active'
                };

                const newSickIntimations = [...safeSickIntimations, sickIntimationRecord];
                setSickIntimations(newSickIntimations);
                saveToStorage('sickIntimations', newSickIntimations);

                // Sync with database
                const dbSickIntimationData = {
                    intimationNumber: intimationNumber,
                    usn: sickFormData.usn,
                    patientName: selectedPatientDetails?.fullName || '',
                    caseReportId: sickFormData.caseReportId || patientCaseReports[0].reportNumber,
                    sickLeaveFrom: sickFormData.sickLeaveFrom,
                    sickLeaveTo: sickFormData.sickLeaveTo,
                    totalDays: sickFormData.totalDays,
                    reason: sickFormData.reason,
                    symptoms: sickFormData.symptoms,
                    restRecommended: sickFormData.restRecommended,
                    doctorName: sickFormData.doctorName,
                    issueDate: sickFormData.issueDate
                };

                const syncResult = await syncWithDatabase('sick-intimations', dbSickIntimationData);
                
                if (syncResult) {
                    alert(`Sick Intimation ${intimationNumber} created and synced to database successfully!`);
                } else {
                    alert(`Sick Intimation ${intimationNumber} created locally. Will sync to database when server is available.`);
                }

                // Reset form
                setSickFormData({
                    usn: '',
                    sickLeaveFrom: '',
                    sickLeaveTo: '',
                    totalDays: '',
                    reason: '',
                    symptoms: '',
                    restRecommended: true,
                    doctorName: 'Mr. Manoj VRC Swami NH-1581',
                    issueDate: new Date().toISOString().split('T')[0],
                    caseReportId: ''
                });
                setSelectedPatientDetails(null);
            };

            // --- Print Helpers (safe and consistent) ---
            const escapeHtml = (value) => {
                if (value === null || value === undefined) return '';
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };

            const openPrintWindow = (html) => {
                const w = window.open('', '_blank');
                if (!w) { alert('Popup blocked. Please allow popups for printing.'); return; }
                w.document.open('text/html', 'replace');
                w.document.write(html);
                w.document.close();
                w.focus();
                setTimeout(() => { try { w.print(); } catch (e) {} }, 300);
            };

            const buildCaseReportHtml = (payload) => {
                const logoUrl = new URL('./nhce_25-scaled-1-2048x683.png', window.location.href).href;
                const currentDate = new Date().toLocaleDateString();
                const currentTime = new Date().toLocaleTimeString();
                const clinicHeader = `
                    <div class="header">
                        <div style="display:flex;align-items:center;justify-content:center;margin-bottom:10px;">
                            <img src="${logoUrl}" alt="NHCE Logo" style="height:60px;margin-right:15px;" />
                            <div style="text-align:left;">
                                <div class="clinic-name">New Horizon Sanjeevani Clinic</div>
                                <div class="clinic-subtitle">New Horizon Knowledge Park, Outer Ring Rd, near Marathalli, Kaverappa Layout, Kadubeesanahalli, Bengaluru, Karnataka - 560103.</div>
                                <div class="clinic-contact">Contact : Manoj VRC Swami  +91 81472 91675<br>Amrutha Varshi D +91 63625 88851</div>
                            </div>
                        </div>
                        <h2 style="text-align:center;color:#333;margin:15px 0;">MEDICAL CASE REPORT</h2>
                    </div>`;

                const patientInfo = `
                    <div class="report-header">
                        <div class="patient-info">
                            <h3 style="margin-top:0;color:#333;">Patient Information</h3>
                            <div class="info-row"><span class="label">Name:</span> ${escapeHtml(payload.patientName)}</div>
                            <div class="info-row"><span class="label">USN:</span> ${escapeHtml(payload.usn)}</div>
                            <div class="info-row"><span class="label">Age:</span> ${escapeHtml(payload.age)} years</div>
                            <div class="info-row"><span class="label">Gender:</span> ${escapeHtml(payload.gender)}</div>
                        </div>
                        <div class="report-info">
                            <h3 style="margin-top:0;color:#333;">Report Details</h3>
                            <div class="info-row"><span class="label">Report Date:</span> ${escapeHtml(payload.reportDate)}</div>
                            <div class="info-row"><span class="label">Report Type:</span> ${escapeHtml(payload.reportType)}</div>
                            <div class="info-row"><span class="label">Doctor:</span> ${escapeHtml(payload.doctorName)}</div>
                            <div class="info-row"><span class="label">Report ID:</span> ${escapeHtml(payload.reportNumber)}</div>
                        </div>
                    </div>`;

                const section = (title, content) => `
                    <div class="section">
                        <div class="section-title">${title}</div>
                        <div class="content">${escapeHtml(content || 'Not specified')}</div>
                    </div>`;

                const footer = `
                    <div class="footer">
                        <p><strong>New Horizon Sanjeevani Clinic</strong></p>
                        <p>This case report is computer generated and contains confidential medical information.</p>
                        <p>Report Number: ${escapeHtml(payload.reportNumber)} | Generated on: ${currentDate} at ${currentTime}</p>
                        <p style="margin-top:10px;">© ${new Date().getFullYear()} Hospital Management Information System - LeadOnyx Apex LLP</p>
                        <p>Contact : Raj Goyal +91 79922 47030 · rajgoyal@duck.com · USN: 1NH23CS329</p>
                    </div>`;

                const html = `<!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8" />
                    <meta name="viewport" content="width=device-width, initial-scale=1" />
                    <title>Case Report - ${escapeHtml(payload.patientName)}</title>
                    <style>
                        /* Screen defaults */
                        body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:10px;color:#000}
                        .header{text-align:center;border-bottom:2px solid #333;padding-bottom:5px;margin-bottom:15px}
                        .clinic-name{font-size:24px;font-weight:bold;color:#2563eb;margin-bottom:3px}
                        .clinic-subtitle{font-size:14px;color:#666;margin-bottom:2px}
                        .clinic-contact{font-size:12px;color:#555}
                        .report-header{display:flex;justify-content:space-between;margin-bottom:20px}
                        .patient-info,.report-info{flex:1}
                        .patient-info{margin-right:20px}
                        .info-row{margin-bottom:8px}
                        .label{font-weight:bold;display:inline-block;width:120px}
                        .section{margin:20px 0}
                        .section-title{font-weight:bold;font-size:16px;color:#333;margin-bottom:10px;border-bottom:1px solid #ddd;padding-bottom:5px}
                        .content{background:#f9f9f9;padding:10px;border-radius:5px;min-height:40px}
                        .footer{margin-top:20px;padding-top:15px;border-top:1px solid #ddd;text-align:center;font-size:10px;color:#666}
                        .signature-section{margin-top:40px;text-align:right}
                        .signature-line{border-bottom:1px solid #333;width:200px;display:inline-block;margin-bottom:5px}
                        .btn{background:#007bff;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin:10px 5px}
                        .btn:hover{background:#0056b3}

                        /* Keep signature and footer together */
                        .signature-and-footer{page-break-inside:avoid;break-inside:avoid}

                        /* Page number footer (print only) */
                        .page-number{display:none}
                        @media print{
                            @page{ size: A4; margin: 0.25in 0.35in 0.35in 0.35in; }
                            html, body{ margin:0; padding:0.05in 0.1in; }
                            .no-print{display:none}
                            .footer,.signature-section,.signature-and-footer{page-break-inside:avoid;break-inside:avoid}
                            img{max-width:100%;height:auto;print-color-adjust:exact;-webkit-print-color-adjust:exact}
                            body{padding-bottom:0.35in}
                            .page-number{display:block;position:fixed;bottom:0;left:0;right:0;text-align:center;font-size:10px;color:#666}
                            .page-number::after{content: "Page " counter(page) " / " counter(pages)}
                        }
                    </style>
                </head>
                <body>
                    ${clinicHeader}
                    ${patientInfo}
                    ${section('Chief Complaint', payload.chiefComplaint)}
                    ${section('History of Present Illness', payload.historyOfPresentIllness)}
                    ${section('Past Medical History', payload.pastMedicalHistory)}
                    ${section('Family History', payload.familyHistory)}
                    ${section('Physical Examination', payload.physicalExamination)}
                    ${section('Investigations', payload.investigations)}
                    ${section('Diagnosis', payload.diagnosis)}
                    ${section('Treatment', payload.treatment)}
                    ${section('Recommendations', payload.recommendations)}
                    <div class="signature-and-footer">
                        <div class="signature-section">
                            <div class="signature-line"></div><br>
                            <strong>${escapeHtml(payload.doctorName)}</strong><br>
                            <small>clinic staff</small><br>
                            <small>New Horizon Sanjeevani Clinic</small>
                        </div>
                        ${footer}
                    </div>
                    <div class="page-number" aria-hidden="true"></div>
                    <div class="no-print" style="text-align:center;margin-top:20px;">
                        <button class="btn" onclick="window.print()">🖨️ Print Case Report</button>
                        <button class="btn" onclick="window.close()" style="background:#6c757d;">✕ Close</button>
                    </div>
                </body>
                </html>`;
                return html;
            };

            // --- Case Report: Print from current form ---
            const printCaseReport = async () => {
                if (!selectedPatientDetails || !formData.usn) {
                    alert('Please select a patient and fill the required fields');
                    return;
                }

                // Get the case report number from the latest saved report or generate new one
                let reportNumber = currentCaseReportNumber;
                if (!reportNumber) {
                    const patientReports = safeCaseReports.filter(cr => cr.usn === formData.usn);
                    if (patientReports.length > 0) {
                        const latestReport = patientReports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                        reportNumber = latestReport.reportNumber;
                    } else {
                        reportNumber = generateCaseReportNumber();
                        setCurrentCaseReportNumber(reportNumber);
                    }
                }
                // Ensure persisted record
                let record = safeCaseReports.find(r => r.reportNumber === reportNumber);
                if (!record) {
                    record = {
                        id: Date.now().toString(),
                        reportNumber,
                        usn: formData.usn,
                        patientName: selectedPatientDetails.fullName,
                        patientAge: selectedPatientDetails.age,
                        patientGender: selectedPatientDetails.gender,
                        reportType: formData.reportType,
                        chiefComplaint: formData.chiefComplaint,
                        historyOfPresentIllness: formData.historyOfPresentIllness,
                        pastMedicalHistory: formData.pastMedicalHistory,
                        familyHistory: formData.familyHistory,
                        socialHistory: formData.socialHistory,
                        physicalExamination: formData.physicalExamination,
                        investigations: formData.investigations,
                        diagnosis: formData.diagnosis,
                        treatment: formData.treatment,
                        prognosis: formData.prognosis,
                        recommendations: formData.recommendations,
                        followUp: formData.followUp,
                        doctorName: formData.doctorName,
                        reportDate: formData.reportDate,
                        createdAt: new Date().toISOString(),
                        status: 'Active'
                    };
                    const updated = [...safeCaseReports, record];
                    setCaseReports(updated);
                    saveToStorage('caseReports', updated);
                    await syncWithDatabase('case-reports', {
                        reportNumber,
                        usn: record.usn,
                        patientName: record.patientName,
                        reportType: record.reportType,
                        chiefComplaint: record.chiefComplaint,
                        historyOfPresentIllness: record.historyOfPresentIllness,
                        pastMedicalHistory: record.pastMedicalHistory,
                        familyHistory: record.familyHistory,
                        physicalExamination: record.physicalExamination,
                        investigations: record.investigations,
                        diagnosis: record.diagnosis,
                        treatment: record.treatment,
                        recommendations: record.recommendations,
                        doctorName: record.doctorName,
                        reportDate: record.reportDate
                    });
                }

                const payload = {
                    patientName: record.patientName,
                    usn: record.usn,
                    age: record.patientAge,
                    gender: record.patientGender,
                    reportDate: new Date(record.reportDate).toLocaleDateString(),
                    reportType: record.reportType.charAt(0).toUpperCase() + record.reportType.slice(1),
                    doctorName: record.doctorName,
                    reportNumber,
                    chiefComplaint: record.chiefComplaint,
                    historyOfPresentIllness: record.historyOfPresentIllness,
                    pastMedicalHistory: record.pastMedicalHistory,
                    familyHistory: record.familyHistory,
                    physicalExamination: record.physicalExamination,
                    investigations: record.investigations,
                    diagnosis: record.diagnosis,
                    treatment: record.treatment,
                    recommendations: record.recommendations
                };

                openPrintWindow(buildCaseReportHtml(payload));
            };

            const printSickIntimation = async () => {
                if (!selectedPatientDetails || !sickFormData.usn) {
                    alert('Please select a patient and fill the required fields');
                    return;
                }

                // Check if there's a valid case report
                const patientCaseReports = safeCaseReports.filter(cr => cr.usn === sickFormData.usn);
                if (patientCaseReports.length === 0) {
                    alert('Sick intimation can only be created if there is a valid case report for this patient. Please create a case report first.');
                    return;
                }

                // Get the linked case report number
                const linkedCaseReportNumber = sickFormData.caseReportId || patientCaseReports[0].reportNumber;

                // Get the sick intimation number from the latest saved intimation or generate new one
                let intimationNumber = currentSickIntimationNumber;
                if (!intimationNumber) {
                    const patientIntimations = safeSickIntimations.filter(si => si.usn === sickFormData.usn);
                    if (patientIntimations.length > 0) {
                        const latestIntimation = patientIntimations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                        intimationNumber = latestIntimation.intimationNumber;
                    } else {
                        intimationNumber = generateSickIntimationNumber(linkedCaseReportNumber);
                        setCurrentSickIntimationNumber(intimationNumber);
                    }
                }

                // Ensure the sick intimation exists locally and is synced
                let intimation = safeSickIntimations.find(si => si.intimationNumber === intimationNumber);
                if (!intimation) {
                    intimation = {
                        id: Date.now().toString(),
                        intimationNumber,
                        usn: sickFormData.usn,
                        patientName: selectedPatientDetails.fullName,
                        patientAge: selectedPatientDetails.age,
                        patientGender: selectedPatientDetails.gender,
                        caseReportId: linkedCaseReportNumber,
                        sickLeaveFrom: sickFormData.sickLeaveFrom,
                        sickLeaveTo: sickFormData.sickLeaveTo,
                        totalDays: sickFormData.totalDays,
                        reason: sickFormData.reason,
                        symptoms: sickFormData.symptoms,
                        restRecommended: sickFormData.restRecommended,
                        doctorName: sickFormData.doctorName,
                        issueDate: sickFormData.issueDate,
                        createdAt: new Date().toISOString(),
                        status: 'Active'
                    };
                    const updated = [...safeSickIntimations, intimation];
                    setSickIntimations(updated);
                    saveToStorage('sickIntimations', updated);

                    await syncWithDatabase('sick-intimations', {
                        intimationNumber,
                        usn: intimation.usn,
                        patientName: intimation.patientName,
                        caseReportId: intimation.caseReportId,
                        sickLeaveFrom: intimation.sickLeaveFrom,
                        sickLeaveTo: intimation.sickLeaveTo,
                        totalDays: intimation.totalDays,
                        reason: intimation.reason,
                        symptoms: intimation.symptoms,
                        restRecommended: intimation.restRecommended,
                        doctorName: intimation.doctorName,
                        issueDate: intimation.issueDate
                    });
                }

                const printWindow = window.open('', '_blank');
                const currentDate = new Date().toLocaleDateString();
                const currentTime = new Date().toLocaleTimeString();

                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Sick Leave Certificate - ${selectedPatientDetails.fullName}</title>
                        <style>
                            @media print {
                                @page {
                                    margin: 0.25in 0.35in;
                                    size: A4;
                                }
                                html, body { margin:0; padding:0.05in 0.1in; }
                                body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.25; color: #000; }
                                .no-print { display: none; } .footer, .signature-section { page-break-inside: avoid; } img { max-width: 100%; height: auto; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                            }
                            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 6px; line-height: 1.3; }
                            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 3px; margin-bottom: 10px; }
                            .clinic-name { font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 2px; }
                            .clinic-subtitle { font-size: 13px; color: #666; margin-bottom: 1px; }
                            .clinic-contact { font-size: 11px; color: #555; }
                            .document-title { text-align: center; font-size: 16px; font-weight: bold; color: #333; margin: 10px 0; text-transform: uppercase; }
                            .certificate-number { text-align: right; margin-bottom: 15px; font-size: 12px; }
                            .patient-info { margin: 15px 0; }
                            .patient-info h3 { margin-top: 0; margin-bottom: 8px; font-size: 14px; color: #333; }
                            .info-row { margin-bottom: 5px; }
                            .label { font-weight: bold; display: inline-block; width: 120px; }
                            .content { background: #f9f9f9; padding: 10px; border-radius: 3px; margin: 10px 0; }
                            .content p { margin: 5px 0; }
                            .duration-section { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 3px; text-align: center; }
                            .duration-section h3 { margin: 0 0 10px 0; font-size: 14px; color: #333; }
                            .duration-section p { margin: 3px 0; }
                            .footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; text-align: center; font-size: 9px; color: #666; page-break-inside: avoid; }
                            .footer p { margin: 2px 0; }
                            .signature-section { margin-top: 25px; text-align: right; page-break-inside: avoid; }
                            .signature-line { border-bottom: 1px solid #333; width: 180px; display: inline-block; margin-bottom: 3px; }
                            .signature-section small { display: block; line-height: 1.1; }
                            .btn { background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; margin: 8px 3px; }
                            .btn:hover { background: #0056b3; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                                <img src="${logoUrl}" alt="NHCE Logo" style="height: 60px; margin-right: 15px;" />
                                <div style="text-align: left;">
                                    <div class="clinic-name">New Horizon Sanjeevani Clinic</div>
                                    <div class="clinic-subtitle">New Horizon Knowledge Park, Outer Ring Rd, near Marathalli, Kaverappa Layout, Kadubeesanahalli, Bengaluru, Karnataka - 560103.</div>
                                    <div class="clinic-contact">Contact : Manoj VRC Swami  +91 81472 91675<br>Amrutha Varshi D +91 63625 88851</div>
                                </div>
                            </div>
                            <div class="document-title">Medical Certificate - Sick Leave</div>
                        </div>

                        <div class="certificate-number">
                            <strong>Certificate No:</strong> ${intimation.intimationNumber}<br>
                            ${intimation.caseReportId ? `<strong>Linked Case Report:</strong> ${intimation.caseReportId}<br>` : ''}
                            <strong>Date:</strong> ${new Date(intimation.issueDate).toLocaleDateString()}
                        </div>

                        <div class="patient-info">
                            <h3 style="margin-top: 0; color: #333;">Patient Information</h3>
                            <div class="info-row"><span class="label">Student Name:</span> ${intimation.patientName}</div>
                            <div class="info-row"><span class="label">USN:</span> ${intimation.usn}</div>
                            <div class="info-row"><span class="label">Age:</span> ${intimation.patientAge} years</div>
                            <div class="info-row"><span class="label">Gender:</span> ${intimation.patientGender}</div>
                        </div>

                        <div class="content">
                            <p><strong>TO WHOM IT MAY CONCERN</strong></p>
                            
                            <p>This is to certify that <strong>${intimation.patientName}</strong> (USN: <strong>${intimation.usn}</strong>), 
                            ${intimation.patientAge} years old ${intimation.patientGender}, has been examined and found to be suffering from 
                            <strong>${intimation.reason}</strong>.</p>

                            <p><strong>Symptoms:</strong> ${intimation.symptoms || 'As examined'}</p>
                        </div>

                        <div class="duration-section">
                            <h3 style="margin: 0 0 10px 0; color: #333;">Recommended Rest Period</h3>
                            <p style="margin: 0; font-size: 16px; font-weight: bold;">
                                From: ${new Date(intimation.sickLeaveFrom).toLocaleDateString()} 
                                To: ${new Date(intimation.sickLeaveTo).toLocaleDateString()}
                            </p>
                            <p style="margin: 5px 0 0 0; font-size: 14px;">
                                Total Duration: ${intimation.totalDays} day(s)
                            </p>
                            ${intimation.restRecommended ? '<p style="margin-top: 10px;"><strong>Complete rest is recommended during this period.</strong></p>' : ''}
                        </div>

                        <div class="content">
                            <p><strong>This certificate is issued upon examination and is valid for the period mentioned above.</strong></p>
                        </div>
                        <p> <br />
                        <br />
                        <br />
                        <br />
                        <br />
                        <br /> </p>
                        <div class="signature-section">
                            <div class="signature-line"></div><br>
                            <strong>${intimation.doctorName}</strong><br>
                            <small>clinic staff</small><br>
                            <small>New Horizon Sanjeevani Clinic</small><br>
                            <small>New Horizon Knowledge Park, Outer Ring Rd, near Marathalli, Kaverappa Layout, Kadubeesanahalli, Bengaluru, Karnataka - 560103.</small>
                        </div>

                        <div class="footer">
                            <p><strong>New Horizon Sanjeevani Clinic</strong></p>
                            <p>This medical certificate is computer generated and issued after proper medical examination.</p>
                            <p>Contact : Raj Goyal +91 79922 47030 · rajgoyal@duck.com · USN: 1NH23CS329</p>
                            <p>Certificate No: ${intimation.intimationNumber} | Issued on: ${currentDate} at ${currentTime}</p>
                            <p style="margin-top: 10px;">© ${new Date().getFullYear()} Hospital Management Information System - LeadOnyx Apex LLP</p>
                        </div>

                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="window.print()">🖨️ Print Certificate</button>
                            <button class="btn" onclick="window.close()" style="background: #6c757d;">✕ Close</button>
                        </div>
                    </body>
                    </html>
                `);

                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); }, 500);
            };

            // Print functions for management components
            const printCaseReportFromRecord = (report) => {
                const payload = {
                    patientName: report.patientName,
                    usn: report.usn,
                    age: report.patientAge,
                    gender: report.patientGender,
                    reportDate: new Date(report.reportDate).toLocaleDateString(),
                    reportType: report.reportType.charAt(0).toUpperCase() + report.reportType.slice(1),
                    doctorName: report.doctorName,
                    reportNumber: report.reportNumber,
                    chiefComplaint: report.chiefComplaint,
                    historyOfPresentIllness: report.historyOfPresentIllness,
                    pastMedicalHistory: report.pastMedicalHistory,
                    familyHistory: report.familyHistory,
                    physicalExamination: report.physicalExamination,
                    investigations: report.investigations,
                    diagnosis: report.diagnosis,
                    treatment: report.treatment,
                    recommendations: report.recommendations
                };
                openPrintWindow(buildCaseReportHtml(payload));
            };

            const printSickIntimationFromRecord = (intimation) => {
                const printWindow = window.open('', '_blank');
                const currentDate = new Date().toLocaleDateString();
                const currentTime = new Date().toLocaleTimeString();
                const logoUrl = new URL('./nhce_25-scaled-1-2048x683.png', window.location.href).href;

                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Sick Leave Certificate - ${intimation.patientName}</title>
                        <style>
                            @media print {
                                @page {
                                    margin: 0.25in 0.35in;
                                    size: A4;
                                }
                                html, body { margin:0; padding:0.05in 0.1in; }
                                body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.25; color: #000; }
                                .no-print { display: none; } .footer, .signature-section { page-break-inside: avoid; } img { max-width: 100%; height: auto; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                            }
                            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 6px; line-height: 1.3; }
                            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 3px; margin-bottom: 10px; }
                            .clinic-name { font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 2px; }
                            .clinic-subtitle { font-size: 13px; color: #666; margin-bottom: 1px; }
                            .clinic-contact { font-size: 11px; color: #555; }
                            .document-title { text-align: center; font-size: 16px; font-weight: bold; color: #333; margin: 10px 0; text-transform: uppercase; }
                            .certificate-number { text-align: right; margin-bottom: 15px; font-size: 12px; }
                            .patient-info { margin: 15px 0; }
                            .patient-info h3 { margin-top: 0; margin-bottom: 8px; font-size: 14px; color: #333; }
                            .info-row { margin-bottom: 5px; }
                            .label { font-weight: bold; display: inline-block; width: 120px; }
                            .content { background: #f9f9f9; padding: 10px; border-radius: 3px; margin: 10px 0; }
                            .content p { margin: 5px 0; }
                            .duration-section { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 3px; text-align: center; }
                            .duration-section h3 { margin: 0 0 8px 0; font-size: 14px; color: #333; }
                            .duration-section p { margin: 3px 0; }
                            .footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; text-align: center; font-size: 9px; color: #666; page-break-inside: avoid; }
                            .footer p { margin: 2px 0; }
                            .signature-section { margin-top: 25px; text-align: right; page-break-inside: avoid; }
                            .signature-line { border-bottom: 1px solid #333; width: 180px; display: inline-block; margin-bottom: 3px; }
                            .signature-section small { display: block; line-height: 1.1; }
                            .btn { background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; margin: 8px 3px; }
                            .btn:hover { background: #0056b3; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                                <img src="${logoUrl}" alt="NHCE Logo" style="height: 60px; margin-right: 15px;" />
                                <div style="text-align: left;">
                                    <div class="clinic-name">New Horizon Sanjeevani Clinic</div>
                                    <div class="clinic-subtitle">New Horizon Knowledge Park, Outer Ring Rd, near Marathalli, Kaverappa Layout, Kadubeesanahalli, Bengaluru, Karnataka - 560103.</div>
                                    <div class="clinic-contact">Contact : Manoj VRC Swami  +91 81472 91675<br>Amrutha Varshi D +91 63625 88851</div>
                                </div>
                            </div>
                            <div class="document-title">Medical Certificate - Sick Leave</div>
                        </div>

                        <div class="certificate-number">
                            <strong>Certificate No:</strong> ${intimation.intimationNumber}<br>
                            ${intimation.caseReportId ? `<strong>Linked Case Report:</strong> ${intimation.caseReportId}<br>` : ''}
                            <strong>Date:</strong> ${new Date(intimation.issueDate).toLocaleDateString()}
                        </div>

                        <div class="patient-info">
                            <h3 style="margin-top: 0; color: #333;">Patient Information</h3>
                            <div class="info-row"><span class="label">Student Name:</span> ${intimation.patientName}</div>
                            <div class="info-row"><span class="label">USN:</span> ${intimation.usn}</div>
                            <div class="info-row"><span class="label">Age:</span> ${intimation.patientAge} years</div>
                            <div class="info-row"><span class="label">Gender:</span> ${intimation.patientGender}</div>
                        </div>

                        <div class="content">
                            <p><strong>TO WHOM IT MAY CONCERN</strong></p>
                            
                            <p>This is to certify that <strong>${intimation.patientName}</strong> (USN: <strong>${intimation.usn}</strong>), 
                            ${intimation.patientAge} years old ${intimation.patientGender}, has been examined and found to be suffering from 
                            <strong>${intimation.reason}</strong>.</p>

                            <p><strong>Symptoms:</strong> ${intimation.symptoms || 'As examined'}</p>
                        </div>

                        <div class="duration-section">
                            <h3 style="margin: 0 0 10px 0; color: #333;">Recommended Rest Period</h3>
                            <p style="margin: 0; font-size: 16px; font-weight: bold;">
                                From: ${new Date(intimation.sickLeaveFrom).toLocaleDateString()} 
                                To: ${new Date(intimation.sickLeaveTo).toLocaleDateString()}
                            </p>
                            <p style="margin: 5px 0 0 0; font-size: 14px;">
                                Total Duration: ${intimation.totalDays} day(s)
                            </p>
                            ${intimation.restRecommended ? '<p style="margin-top: 10px;"><strong>Complete rest is recommended during this period.</strong></p>' : ''}
                        </div>

                        <div class="content">
                            <p><strong>This certificate is issued upon examination and is valid for the period mentioned above.</strong></p>
                        </div>

                        <div class="signature-section">
                            <div class="signature-line"></div><br>
                            <strong>${intimation.doctorName}</strong><br>
                            <small>clinic staff</small><br>
                            <small>New Horizon Sanjeevani Clinic</small><br>
                            <small>New Horizon Knowledge Park, Outer Ring Rd, near Marathalli, Kaverappa Layout, Kadubeesanahalli, Bengaluru, Karnataka - 560103.</small>
                        </div>

                        <div class="footer">
                            <p><strong>New Horizon Sanjeevani Clinic</strong></p>
                            <p>This medical certificate is computer generated and issued after proper medical examination.</p>
                            <p>Contact : Raj Goyal +91 79922 47030 · rajgoyal@duck.com · USN: 1NH23CS329</p>
                            <p>Certificate No: ${intimation.intimationNumber} | Issued on: ${currentDate} at ${currentTime}</p>
                            <p style="margin-top: 10px;">© ${new Date().getFullYear()} Hospital Management Information System - LeadOnyx Apex LLP</p>
                        </div>

                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="window.print()">🖨️ Print Certificate</button>
                            <button class="btn" onclick="window.close()" style="background: #6c757d;">✕ Close</button>
                        </div>
                    </body>
                    </html>
                `);

                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); }, 500);
            };

            return (
                <div className="space-y-6">
                    {/* Sub-navigation */}
                    <div className="card">
                        <div className="flex border-b">
                            <button
                                className={`px-4 py-2 font-medium ${subTab === 'case-report' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                                onClick={() => setSubTab('case-report')}
                            >
                                📋 Case Report
                            </button>
                            <button
                                className={`px-4 py-2 font-medium ${subTab === 'sick-intimation' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                                onClick={() => setSubTab('sick-intimation')}
                            >
                                🏥 Sick Intimation
                            </button>
                            <button
                                className={`px-4 py-2 font-medium ${subTab === 'case-mgmt' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                                onClick={() => setSubTab('case-mgmt')}
                            >
                                📊 Case Management
                            </button>
                            <button
                                className={`px-4 py-2 font-medium ${subTab === 'sick-mgmt' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                                onClick={() => setSubTab('sick-mgmt')}
                            >
                                📋 Sick Management
                            </button>
                        </div>
                    </div>

                    {/* Case Report Form */}
                    {subTab === 'case-report' && (
                        <div className="card">
                            <h2 className="text-xl font-semibold mb-4">Medical Case Report</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Select Patient *</label>
                                    <div className="relative case-patient-search">
                                        <input
                                            type="text"
                                            value={caseSearchTerm}
                                            onChange={(e)=>{ setCaseSearchTerm(e.target.value); setShowCasePatientDropdown(true); if(!e.target.value){ setFormData(prev=>({...prev,usn:''})); setSelectedPatientDetails(null);} }}
                                            onFocus={()=> setShowCasePatientDropdown(true)}
                                            placeholder="Search patient by USN or name..."
                                            className="form-input pr-8"
                                        />
                                        <div className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 10-14 0 7 7 0 0014 0z" /></svg>
                                        </div>
                                        {showCasePatientDropdown && filteredCasePatients.length > 0 && (
                                            <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded shadow max-h-60 overflow-auto">
                                                {filteredCasePatients.slice(0,10).map(p => (
                                                    <div key={p.usn} onClick={()=>selectCasePatient(p)} className="px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0">
                                                        <div className="font-medium">{p.fullName}</div>
                                                        <div className="text-xs text-gray-600">{p.usn} • {p.age}y • {p.gender}</div>
                                                    </div>
                                                ))}
                                                {filteredCasePatients.length === 0 && (
                                                    <div className="px-3 py-2 text-xs text-gray-500">No matches</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Report Type</label>
                                    <select
                                        value={formData.reportType}
                                        onChange={(e) => setFormData(prev => ({ ...prev, reportType: e.target.value }))}
                                        className="form-input"
                                    >
                                        <option value="medical">Medical Report</option>
                                        <option value="surgical">Surgical Report</option>
                                        <option value="emergency">Emergency Report</option>
                                        <option value="consultation">Consultation Report</option>
                                    </select>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Doctor Name</label>
                                    <select
                                        value={formData.doctorName}
                                        onChange={(e) => setFormData(prev => ({ ...prev, doctorName: e.target.value }))}
                                        className="form-input"
                                    >
                                        <option value="Mr. Manoj VRC Swami NH-1581">Mr. Manoj VRC Swami NH-1581</option>
                                        <option value="Ms. Amrutha Varshi D NH - 1215">Ms. Amrutha Varshi D NH - 1215</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Report Date</label>
                                    <input
                                        type="date"
                                        value={formData.reportDate}
                                        onChange={(e) => setFormData(prev => ({ ...prev, reportDate: e.target.value }))}
                                        className="form-input"
                                    />
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Chief Complaint</label>
                                    <textarea
                                        value={formData.chiefComplaint}
                                        onChange={(e) => setFormData(prev => ({ ...prev, chiefComplaint: e.target.value }))}
                                        rows="2"
                                        className="form-input"
                                        placeholder="Primary reason for visit..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">History of Present Illness</label>
                                    <textarea
                                        value={formData.historyOfPresentIllness}
                                        onChange={(e) => setFormData(prev => ({ ...prev, historyOfPresentIllness: e.target.value }))}
                                        rows="3"
                                        className="form-input"
                                        placeholder="Detailed history of current illness..."
                                    />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Past Medical History</label>
                                        <textarea
                                            value={formData.pastMedicalHistory}
                                            onChange={(e) => setFormData(prev => ({ ...prev, pastMedicalHistory: e.target.value }))}
                                            rows="3"
                                            className="form-input"
                                            placeholder="Previous illnesses, surgeries, medications..."
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Family History</label>
                                        <textarea
                                            value={formData.familyHistory}
                                            onChange={(e) => setFormData(prev => ({ ...prev, familyHistory: e.target.value }))}
                                            rows="3"
                                            className="form-input"
                                            placeholder="Family medical history..."
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Physical Examination</label>
                                    <textarea
                                        value={formData.physicalExamination}
                                        onChange={(e) => setFormData(prev => ({ ...prev, physicalExamination: e.target.value }))}
                                        rows="3"
                                        className="form-input"
                                        placeholder="Physical examination findings..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Investigations</label>
                                    <textarea
                                        value={formData.investigations}
                                        onChange={(e) => setFormData(prev => ({ ...prev, investigations: e.target.value }))}
                                        rows="3"
                                        className="form-input"
                                        placeholder="Lab tests, imaging, other investigations..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Diagnosis</label>
                                    <textarea
                                        value={formData.diagnosis}
                                        onChange={(e) => setFormData(prev => ({ ...prev, diagnosis: e.target.value }))}
                                        rows="2"
                                        className="form-input"
                                        placeholder="Primary and secondary diagnosis..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Treatment</label>
                                    <textarea
                                        value={formData.treatment}
                                        onChange={(e) => setFormData(prev => ({ ...prev, treatment: e.target.value }))}
                                        rows="3"
                                        className="form-input"
                                        placeholder="Treatment provided, medications, procedures..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Recommendations</label>
                                    <textarea
                                        value={formData.recommendations}
                                        onChange={(e) => setFormData(prev => ({ ...prev, recommendations: e.target.value }))}
                                        rows="3"
                                        className="form-input"
                                        placeholder="Follow-up care, lifestyle modifications..."
                                    />
                                </div>
                            </div>

                            <div className="mt-6 flex gap-4">
                                <button
                                    onClick={handleCaseReportSubmit}
                                    className="btn btn-secondary"
                                    disabled={!formData.usn || !formData.diagnosis}
                                >
                                    💾 Save Case Report
                                </button>
                                <button 
                                    type="button" 
                                    onClick={async () => {
                                        console.log('Testing database connection...');
                                        const isHealthy = await checkServerHealth();
                                        console.log('Server health check result:', isHealthy);
                                        serverAvailable = isHealthy;
                                        
                                        if (isHealthy) {
                                            alert('✅ Database connection successful!');
                                        } else {
                                            alert('❌ Database connection failed. Please ensure the Python server is running on localhost:5000');
                                        }
                                    }}
                                    className="btn bg-blue-500 hover:bg-blue-600 text-white"
                                >
                                    🔧 Test DB Connection
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Sick Intimation Form */}
                    {subTab === 'sick-intimation' && (
                        <div className="card">
                            <h2 className="text-xl font-semibold mb-4">Sick Leave Certificate</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Select Patient *</label>
                                    <div className="relative sick-patient-search">
                                        <input
                                            type="text"
                                            value={sickSearchTerm}
                                            onChange={(e)=>{ setSickSearchTerm(e.target.value); setShowSickPatientDropdown(true); if(!e.target.value){ setSickFormData(prev=>({...prev,usn:'',caseReportId:''})); setSelectedPatientDetails(null);} }}
                                            onFocus={()=> setShowSickPatientDropdown(true)}
                                            placeholder="Search patient by USN or name..."
                                            className="form-input pr-8"
                                        />
                                        <div className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 10-14 0 7 7 0 0014 0z" /></svg>
                                        </div>
                                        {showSickPatientDropdown && filteredSickPatients.length > 0 && (
                                            <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded shadow max-h-60 overflow-auto">
                                                {filteredSickPatients.slice(0,10).map(p => (
                                                    <div key={p.usn} onClick={()=>selectSickPatient(p)} className="px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0">
                                                        <div className="font-medium">{p.fullName}</div>
                                                        <div className="text-xs text-gray-600">{p.usn} • {p.age}y • {p.gender}</div>
                                                    </div>
                                                ))}
                                                {filteredSickPatients.length === 0 && (
                                                    <div className="px-3 py-2 text-xs text-gray-500">No matches</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Doctor Name</label>
                                    <select
                                        value={sickFormData.doctorName}
                                        onChange={(e) => setSickFormData(prev => ({ ...prev, doctorName: e.target.value }))}
                                        className="form-input"
                                    >
                                        <option value="Mr. Manoj VRC Swami NH-1581">Mr. Manoj VRC Swami NH-1581</option>
                                        <option value="Ms. Amrutha Varshi D NH - 1215">Ms. Amrutha Varshi D NH - 1215</option>
                                    </select>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Sick Leave From *</label>
                                    <input
                                        type="date"
                                        value={sickFormData.sickLeaveFrom}
                                        onChange={(e) => handleSickDateChange('sickLeaveFrom', e.target.value)}
                                        className="form-input"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Sick Leave To *</label>
                                    <input
                                        type="date"
                                        value={sickFormData.sickLeaveTo}
                                        onChange={(e) => handleSickDateChange('sickLeaveTo', e.target.value)}
                                        className="form-input"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Total Days</label>
                                    <input
                                        type="text"
                                        value={sickFormData.totalDays}
                                        readOnly
                                        className="form-input bg-gray-100"
                                        placeholder="Auto calculated"
                                    />
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Reason for Sick Leave *</label>
                                    <input
                                        type="text"
                                        value={sickFormData.reason}
                                        onChange={(e) => setSickFormData(prev => ({ ...prev, reason: e.target.value }))}
                                        className="form-input"
                                        placeholder="e.g., Fever, Viral infection, etc."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Symptoms</label>
                                    <textarea
                                        value={sickFormData.symptoms}
                                        onChange={(e) => setSickFormData(prev => ({ ...prev, symptoms: e.target.value }))}
                                        rows="3"
                                        className="form-input"
                                        placeholder="Detailed symptoms observed..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Issue Date</label>
                                    <input
                                        type="date"
                                        value={sickFormData.issueDate}
                                        onChange={(e) => setSickFormData(prev => ({ ...prev, issueDate: e.target.value }))}
                                        className="form-input"
                                    />
                                </div>

                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        id="restRecommended"
                                        checked={sickFormData.restRecommended}
                                        onChange={(e) => setSickFormData(prev => ({ ...prev, restRecommended: e.target.checked }))}
                                        className="mr-2"
                                    />
                                    <label htmlFor="restRecommended" className="text-sm font-medium">Complete rest recommended</label>
                                </div>
                            </div>

                            {/* Case Report Selection for Sick Intimation */}
                            <div className="mb-6">
                                <label className="block text-sm font-medium mb-1">Linked Case Report</label>
                                <select
                                    value={sickFormData.caseReportId}
                                    onChange={(e) => setSickFormData(prev => ({ ...prev, caseReportId: e.target.value }))}
                                    className="form-input"
                                >
                                    <option value="">Auto-select latest case report</option>
                                    {selectedPatientDetails && safeCaseReports
                                        .filter(cr => cr.usn === selectedPatientDetails.usn)
                                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                                        .map(report => (
                                            <option key={report.id} value={report.reportNumber}>
                                                {report.reportNumber} - {new Date(report.reportDate).toLocaleDateString()} ({report.diagnosis})
                                            </option>
                                        ))
                                    }
                                </select>
                                {selectedPatientDetails && safeCaseReports.filter(cr => cr.usn === selectedPatientDetails.usn).length === 0 && (
                                    <p className="text-red-500 text-sm mt-1">
                                        ⚠️ No case reports found for this patient. Please create a case report first.
                                    </p>
                                )}
                            </div>

                            <div className="mt-6 flex gap-4">
                                <button
                                    onClick={handleSickIntimationSubmit}
                                    className="btn btn-secondary"
                                    disabled={!sickFormData.usn || !sickFormData.reason || !sickFormData.sickLeaveFrom || !sickFormData.sickLeaveTo || 
                                             (selectedPatientDetails && safeCaseReports.filter(cr => cr.usn === selectedPatientDetails.usn).length === 0)}
                                >
                                    💾 Save Sick Intimation
                                </button>
                                <button 
                                    type="button" 
                                    onClick={async () => {
                                        console.log('Testing database connection...');
                                        const isHealthy = await checkServerHealth();
                                        console.log('Server health check result:', isHealthy);
                                        serverAvailable = isHealthy;
                                        
                                        if (isHealthy) {
                                            alert('✅ Database connection successful!');
                                        } else {
                                            alert('❌ Database connection failed. Please ensure the Python server is running on localhost:5000');
                                        }
                                    }}
                                    className="btn bg-blue-500 hover:bg-blue-600 text-white"
                                >
                                    🔧 Test DB Connection
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Case Report Management */}
                    {subTab === 'case-mgmt' && (
                        <div className="space-y-6">
                            <div className="card">
                                <h2 className="text-xl font-semibold mb-4">Case Report Management</h2>
                                <p className="text-gray-600 mb-4">Manage all case reports with printing functionality</p>
                                
                                <div className="mb-6">
                                    <input
                                        type="text"
                                        placeholder="Search by patient name, USN, or report number..."
                                        className="form-input w-full max-w-md"
                                        value={formData.searchTerm || ''}
                                        onChange={(e) => setFormData(prev => ({ ...prev, searchTerm: e.target.value }))}
                                    />
                                </div>

                                <div className="overflow-x-auto">
                                    <table className="min-w-full table-auto border-collapse border border-gray-300">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border border-gray-300 px-4 py-2">Report No.</th>
                                                <th className="border border-gray-300 px-4 py-2">Patient Name</th>
                                                <th className="border border-gray-300 px-4 py-2">USN</th>
                                                <th className="border border-gray-300 px-4 py-2">Date</th>
                                                <th className="border border-gray-300 px-4 py-2">Type</th>
                                                <th className="border border-gray-300 px-4 py-2">Doctor</th>
                                                <th className="border border-gray-300 px-4 py-2">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {safeCaseReports
                                                .filter(report => 
                                                    !formData.searchTerm || 
                                                    report.reportNumber.toLowerCase().includes(formData.searchTerm.toLowerCase()) ||
                                                    report.patientName.toLowerCase().includes(formData.searchTerm.toLowerCase()) ||
                                                    report.usn.toLowerCase().includes(formData.searchTerm.toLowerCase())
                                                )
                                                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                                                .map(report => (
                                                    <tr key={report.reportNumber}>
                                                        <td className="border border-gray-300 px-4 py-2 font-mono text-sm">{report.reportNumber}</td>
                                                        <td className="border border-gray-300 px-4 py-2">{report.patientName}</td>
                                                        <td className="border border-gray-300 px-4 py-2">{report.usn}</td>
                                                        <td className="border border-gray-300 px-4 py-2">{new Date(report.reportDate).toLocaleDateString()}</td>
                                                        <td className="border border-gray-300 px-4 py-2 capitalize">{report.reportType}</td>
                                                        <td className="border border-gray-300 px-4 py-2">{report.doctorName}</td>
                                                        <td className="border border-gray-300 px-4 py-2">
                                                            <button
                                                                onClick={() => printCaseReportFromRecord(report)}
                                                                className="btn btn-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs"
                                                            >
                                                                🖨️ Print
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))
                                            }
                                        </tbody>
                                    </table>
                                    {safeCaseReports.length === 0 && (
                                        <div className="text-center py-8 text-gray-500">
                                            No case reports found. Create a case report to see it here.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Sick Intimation Management */}
                    {subTab === 'sick-mgmt' && (
                        <div className="space-y-6">
                            <div className="card">
                                <h2 className="text-xl font-semibold mb-4">Sick Intimation Management</h2>
                                <p className="text-gray-600 mb-4">Manage all sick leave certificates with printing functionality</p>
                                
                                <div className="mb-6">
                                    <input
                                        type="text"
                                        placeholder="Search by patient name, USN, or certificate number..."
                                        className="form-input w-full max-w-md"
                                        value={sickFormData.searchTerm || ''}
                                        onChange={(e) => setSickFormData(prev => ({ ...prev, searchTerm: e.target.value }))}
                                    />
                                </div>

                                <div className="overflow-x-auto">
                                    <table className="min-w-full table-auto border-collapse border border-gray-300">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border border-gray-300 px-4 py-2">Certificate No.</th>
                                                <th className="border border-gray-300 px-4 py-2">Patient Name</th>
                                                <th className="border border-gray-300 px-4 py-2">USN</th>
                                                <th className="border border-gray-300 px-4 py-2">From</th>
                                                <th className="border border-gray-300 px-4 py-2">To</th>
                                                <th className="border border-gray-300 px-4 py-2">Days</th>
                                                <th className="border border-gray-300 px-4 py-2">Doctor</th>
                                                <th className="border border-gray-300 px-4 py-2">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {safeSickIntimations
                                                .filter(intimation => 
                                                    !sickFormData.searchTerm || 
                                                    intimation.intimationNumber.toLowerCase().includes(sickFormData.searchTerm.toLowerCase()) ||
                                                    intimation.patientName.toLowerCase().includes(sickFormData.searchTerm.toLowerCase()) ||
                                                    intimation.usn.toLowerCase().includes(sickFormData.searchTerm.toLowerCase())
                                                )
                                                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                                                .map(intimation => (
                                                    <tr key={intimation.intimationNumber}>
                                                        <td className="border border-gray-300 px-4 py-2 font-mono text-sm">{intimation.intimationNumber}</td>
                                                        <td className="border border-gray-300 px-4 py-2">{intimation.patientName}</td>
                                                        <td className="border border-gray-300 px-4 py-2">{intimation.usn}</td>
                                                        <td className="border border-gray-300 px-4 py-2">{new Date(intimation.sickLeaveFrom).toLocaleDateString()}</td>
                                                        <td className="border border-gray-300 px-4 py-2">{new Date(intimation.sickLeaveTo).toLocaleDateString()}</td>
                                                        <td className="border border-gray-300 px-4 py-2 text-center">{intimation.totalDays}</td>
                                                        <td className="border border-gray-300 px-4 py-2">{intimation.doctorName}</td>
                                                        <td className="border border-gray-300 px-4 py-2">
                                                            <button
                                                                onClick={() => printSickIntimationFromRecord(intimation)}
                                                                className="btn btn-sm bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs"
                                                            >
                                                                🖨️ Print
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))
                                            }
                                        </tbody>
                                    </table>
                                    {safeSickIntimations.length === 0 && (
                                        <div className="text-center py-8 text-gray-500">
                                            No sick intimations found. Create a sick leave certificate to see it here.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Main App Component with Enhanced Debugging
        const App = () => {
            const [patients, setPatients] = useState(() => loadFromStorage('patients', []));
            const [vitals, setVitals] = useState(() => loadFromStorage('vitals', []));
            const [prescriptions, setPrescriptions] = useState(() => loadFromStorage('prescriptions', []));
            const [caseReports, setCaseReports] = useState(() => loadFromStorage('caseReports', []));
            const [sickIntimations, setSickIntimations] = useState(() => loadFromStorage('sickIntimations', []));
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            // Scroll to top whenever active tab changes for better UX after quick actions
            useEffect(() => {
                try {
                    const target = document.querySelector('header') || document.body;
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (e) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }, [activeTab]);
            const [searchTerm, setSearchTerm] = useState('');
            const [dbConnected, setDbConnected] = useState(false);
            const [syncStatus, setSyncStatus] = useState('checking');
            const [hasBackup, setHasBackup] = useState(() => {
                return localStorage.getItem('backup_timestamp') !== null;
            });

            // Debug logging
            console.log('App State:', {
                patients: patients?.length || 0,
                vitals: vitals?.length || 0,
                prescriptions: prescriptions?.length || 0,
                caseReports: caseReports?.length || 0,
                sickIntimations: sickIntimations?.length || 0,
                prescriptions: prescriptions?.length || 0,
                activeTab,
                dbConnected
            });

            // Function to restore backup data
            const handleRestoreBackup = () => {
                if (confirm('This will restore your backup data and overwrite current data. Continue?')) {
                    const restored = restoreBackupData();
                    if (restored) {
                        setPatients(restored.patients);
                        setVitals(restored.vitals);
                        setPrescriptions(restored.prescriptions);
                        setHasBackup(false);
                        alert('Backup data restored successfully!');
                    }
                }
            };

            // Enhanced database connection and sync check
            useEffect(() => {
                const checkDatabaseAndSync = async () => {
                    try {
                        console.log('Checking database connection...');
                        const isOnline = await checkServerHealth();
                        console.log(`Database connection status: ${isOnline ? 'Connected' : 'Disconnected'}`);
                        
                        const wasOffline = !dbConnected && isOnline; // Detect transition from offline to online
                        setDbConnected(isOnline);
                        serverAvailable = isOnline;
                        
                        if (isOnline) {
                            setSyncStatus('connected');
                            
                            // If transitioning from offline to online, sync offline data first
                            if (wasOffline) {
                                const offlinePatients = loadFromStorage('patients', []);
                                const offlineVitals = loadFromStorage('vitals', []);
                                const offlinePrescriptions = loadFromStorage('prescriptions', []);
                                const hasOfflineData = offlinePatients.length > 0 || offlineVitals.length > 0 || offlinePrescriptions.length > 0;
                                
                                if (hasOfflineData) {
                                    console.log('Syncing offline data to server before refresh...');
                                    setSyncStatus('syncing');
                                    await syncOfflineDataToServer();
                                }
                            }
                            
                            // Now refresh data from server (this will merge server data with synced offline data)
                            try {
                                console.log('Refreshing data from server...');
                                let serverPatients = await apiRequest('/api/patients');
                                const serverVitals = await apiRequest('/api/vitals');
                                const serverPrescriptions = await apiRequest('/api/prescriptions');
                                // Respect locally queued deletions to avoid reappearing entries
                                const deletedUSNs = loadFromStorage('deleted_usns', []);
                                if (Array.isArray(deletedUSNs) && deletedUSNs.length > 0) {
                                    serverPatients = (serverPatients || []).filter(p => !deletedUSNs.includes(p.usn));
                                }
                                
                                // Merge server data with any remaining local data instead of replacing
                                const mergedPatients = mergeArrays(patients, serverPatients || [], 'usn');
                                const mergedVitals = mergeArrays(vitals, serverVitals || [], 'id');
                                const mergedPrescriptions = mergeArrays(prescriptions, serverPrescriptions || [], 'id');
                                
                                setPatients(mergedPatients);
                                setVitals(mergedVitals);
                                setPrescriptions(mergedPrescriptions);
                                
                                saveToStorage('patients', mergedPatients);
                                saveToStorage('vitals', mergedVitals);
                                saveToStorage('prescriptions', mergedPrescriptions);
                                
                                setSyncStatus('synced');
                                console.log('Data refresh and merge completed');
                            } catch (error) {
                                console.warn('Failed to refresh data from server:', error);
                                setSyncStatus('connected');
                            }
                        }
                    } catch (error) {
                        console.error('Database connection check failed:', error);
                        setDbConnected(false);
                        setSyncStatus('offline');
                    }
                };
                checkDatabaseAndSync();
                const interval = setInterval(checkDatabaseAndSync, 15000); // Check every 15 seconds
                return () => clearInterval(interval);
            }, [dbConnected, patients, vitals, prescriptions]);

            // Save to localStorage whenever data changes and attempt sync
            useEffect(() => {
                saveToStorage('patients', patients);
                if (dbConnected && patients.length > 0) {
                    localStorage.setItem('needsSync', 'true');
                }
            }, [patients, dbConnected]);

            useEffect(() => {
                saveToStorage('vitals', vitals);
                if (dbConnected && vitals.length > 0) {
                    localStorage.setItem('needsSync', 'true');
                }
            }, [vitals, dbConnected]);

            useEffect(() => {
                saveToStorage('prescriptions', prescriptions);
                if (dbConnected && prescriptions.length > 0) {
                    localStorage.setItem('needsSync', 'true');
                }
            }, [prescriptions, dbConnected]);

            const handleDeletePatient = async (usn) => {
                if (!usn) return;
                if (!confirm('Are you sure you want to delete this patient? This will also remove all associated vitals and prescriptions.')) return;
                
                // Optimistically update UI and local storage
                setPatients(prev => prev.filter(p => p.usn !== usn));
                setVitals(prev => prev.filter(v => v.usn !== usn));
                setPrescriptions(prev => prev.filter(r => r.usn !== usn));
                if (selectedPatient?.usn === usn) {
                    setSelectedPatient(null);
                }

                // Try to delete on server; if offline, queue for later
                let deletedOnServer = false;
                try {
                    if (serverAvailable) {
                        await apiRequest(`/api/patients/${encodeURIComponent(usn)}`, { method: 'DELETE' });
                        deletedOnServer = true;
                    }
                } catch (e) {
                    deletedOnServer = false;
                }
                const queued = loadFromStorage('deleted_usns', []);
                if (!deletedOnServer) {
                    const set = new Set(Array.isArray(queued) ? queued : []);
                    set.add(usn);
                    saveToStorage('deleted_usns', Array.from(set));
                } else {
                    // Ensure it's not in queue anymore
                    if (Array.isArray(queued) && queued.length > 0) {
                        saveToStorage('deleted_usns', queued.filter(x => x !== usn));
                    }
                }
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="gradient-bg text-white py-8 px-4">
                        <div className="container mx-auto max-w-6xl">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center">
                                    <img src="./nhce_25-scaled-1-2048x683.png" alt="NHCE Logo" className="h-16 mr-4" style={{maxWidth: '120px'}} />
                                    <div>
                                        <h1 className="text-3xl md:text-4xl font-bold mb-2">
                                            New Horizon Sanjeevani Clinic
                                        </h1>
                                        <p className="text-xl opacity-90">
                                            New Horizon Knowledge Park, Outer Ring Rd, near Marathalli, Kaverappa Layout, Kadubeesanahalli, Bengaluru, Karnataka - 560103.
                                        </p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                                        syncStatus === 'connected' || syncStatus === 'synced' ? 'bg-green-500 text-white' :
                                        syncStatus === 'syncing' ? 'bg-yellow-500 text-white' :
                                        syncStatus === 'offline' ? 'bg-red-500 text-white' :
                                        'bg-gray-500 text-white'
                                    }`}>
                                        <div className={`w-2 h-2 rounded-full mr-2 ${
                                            syncStatus === 'connected' || syncStatus === 'synced' ? 'bg-green-300' :
                                            syncStatus === 'syncing' ? 'bg-yellow-300 animate-pulse' :
                                            syncStatus === 'offline' ? 'bg-red-300' :
                                            'bg-gray-300'
                                        }`}></div>
                                        {syncStatus === 'connected' ? 'Online' :
                                         syncStatus === 'synced' ? 'Synced' :
                                         syncStatus === 'syncing' ? 'Syncing...' :
                                         syncStatus === 'offline' ? 'Offline Mode' :
                                         'Checking...'}
                                    </div>
                                    {syncStatus === 'offline' && (
                                        <div className="mt-1">
                                            <p className="text-xs opacity-75">Data will sync when server is available</p>
                                            <button 
                                                onClick={async () => {
                                                    console.log('Manual connection test...');
                                                    const isOnline = await checkServerHealth();
                                                    console.log('Manual test result:', isOnline);
                                                    if (isOnline) {
                                                        setSyncStatus('connected');
                                                        setDbConnected(true);
                                                        serverAvailable = true;
                                                    }
                                                }}
                                                className="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded mt-1"
                                            >
                                                Test Connection
                                            </button>
                                        </div>
                                    )}
                                    {hasBackup && (
                                        <div className="mt-1">
                                            <button 
                                                onClick={handleRestoreBackup}
                                                className="text-xs bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded"
                                            >
                                                🔄 Restore Backup
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Navigation */}
                    <nav className="bg-white border-b px-4">
                        <div className="container mx-auto max-w-6xl">
                            <div className="flex space-x-0 overflow-x-auto">
                                <button
                                    className={`tab ${activeTab === 'dashboard' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('dashboard')}
                                >
                                    Dashboard
                                </button>
                                <button
                                    className={`tab ${activeTab === 'patients' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('patients')}
                                >
                                    Patients
                                </button>
                                <button
                                    className={`tab ${activeTab === 'vitals' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('vitals')}
                                >
                                    Vitals
                                </button>
                                <button
                                    className={`tab ${activeTab === 'prescriptions' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('prescriptions')}
                                >
                                    Prescriptions
                                </button>
                                <button
                                    className={`tab ${activeTab === 'prescription-mgmt' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('prescription-mgmt')}
                                >
                                    Rx Management
                                </button>
                                <button
                                    className={`tab ${activeTab === 'list' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('list')}
                                >
                                    Patient List
                                </button>
                                <button
                                    className={`tab ${activeTab === 'export' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('export')}
                                >
                                    Export Data
                                </button>
                                <button
                                    className={`tab ${activeTab === 'case-report' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('case-report')}
                                    id="case-report-tab"
                                >
                                    Case Report
                                </button>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="container mx-auto max-w-6xl px-4 py-6">
                        <div className={`alert ${dbConnected ? 'alert-info' : 'alert-info'}`}>
                            <strong>{dbConnected ? 'Database Connected:' : 'Offline Mode:'}</strong> 
                            {dbConnected ? 
                                ' Data is being saved to the Flask database backend and locally.' :
                                ' Working with local data only. Start the Flask server for database integration.'
                            }
                        </div>

                        {activeTab === 'dashboard' && (
                            <Dashboard 
                                patients={patients} 
                                vitals={vitals} 
                                prescriptions={prescriptions}
                                caseReports={caseReports}
                                sickIntimations={sickIntimations}
                                setActiveTab={setActiveTab}
                            />
                        )}

                        {activeTab === 'patients' && (
                            <PatientForm
                                patients={patients}
                                setPatients={setPatients}
                                selectedPatient={selectedPatient}
                                setSelectedPatient={setSelectedPatient}
                            />
                        )}

                        {activeTab === 'vitals' && (
                            <VitalsForm
                                patients={patients}
                                vitals={vitals}
                                setVitals={setVitals}
                            />
                        )}

                        {activeTab === 'prescriptions' && (
                            <PrescriptionForm
                                patients={patients}
                                prescriptions={prescriptions}
                                setPrescriptions={setPrescriptions}
                            />
                        )}

                        {activeTab === 'prescription-mgmt' && (
                            <PrescriptionManagement
                                patients={patients}
                                prescriptions={prescriptions}
                                setPrescriptions={setPrescriptions}
                            />
                        )}

                        {activeTab === 'list' && (
                            <PatientList
                                patients={patients}
                                onEdit={(p) => { setSelectedPatient(p); setActiveTab('patients'); }}
                                onDelete={handleDeletePatient}
                            />
                        )}

                        {activeTab === 'export' && (
                            <ExportData
                                patients={patients}
                                vitals={vitals}
                                prescriptions={prescriptions}
                            />
                        )}

                        {activeTab === 'case-report' && (
                            <CaseReportManagement 
                                patients={patients} 
                                caseReports={caseReports}
                                setCaseReports={setCaseReports}
                                sickIntimations={sickIntimations}
                                setSickIntimations={setSickIntimations}
                            />
                        )}
                    </main>

                    {/* Footer */}
                    <footer className="bg-gray-800 text-white py-6 px-4 mt-12">
                        <div className="container mx-auto max-w-6xl">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">New Horizon Sanjeevani Clinic</h3>
                                    <p className="text-gray-300 text-sm">
                                        Comprehensive Healthcare Services<br />
                                        Advanced Medical Management System
                                    </p>
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">System Features</h3>
                                    <ul className="text-gray-300 text-sm space-y-1">
                                        <li>• Patient Management</li>
                                        <li>• Vitals Monitoring</li>
                                        <li>• Prescription Management</li>
                                        <li>• Data Export & Analytics</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">Contact Information</h3>
                                    <p className="text-gray-300 text-sm">
                                        For technical support or<br />
                                        system customization requests,<br />
                                        please contact the administrator.<br />
                                        Contact : Raj Goyal +91 79922 47030<br/>
                                        rajgoyal@duck.com · USN: 1NH23CS329
                                    </p>
                                </div>
                            </div>
                            <div className="border-t border-gray-700 mt-6 pt-6 text-center">
                                <p className="text-gray-400 text-sm">
                                    © {new Date().getFullYear()} <strong>Hospital Management Information System (HMIS)</strong> - LeadOnyx Apex LLP
                                </p>
                                <p className="text-gray-500 text-xs mt-1"> Contact : Raj Goyal +91 79922 47030 · rajgoyal@duck.com · USN: 1NH23CS329</p>
                                <p className="text-gray-500 text-xs mt-1">
                                    All rights reserved. This system is designed for medical practice management.
                                </p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
