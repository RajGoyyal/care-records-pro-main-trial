<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Horizon Sanjeevani Clinic - HMIS</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
        }
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .table th {
            background: #f9fafb;
            font-weight: 600;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        .badge-green {
            background: #d1fae5;
            color: #065f46;
        }
        .badge-blue {
            background: #dbeafe;
            color: #1e40af;
        }
        .badge-red {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API utilities with fallback to localStorage
        const apiRequest = async (url, options = {}) => {
            try {
                const response = await fetch(`http://localhost:5000${url}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.warn('API request failed, using localStorage:', error);
                throw error;
            }
        };

        const syncWithDatabase = async (endpoint, data, method = 'POST') => {
            try {
                await apiRequest(`/api/${endpoint}`, {
                    method,
                    body: JSON.stringify(data)
                });
                console.log(`Data synced to database: ${endpoint}`);
            } catch (error) {
                console.warn(`Failed to sync to database: ${endpoint}`, error);
            }
        };

        // Storage utilities
        const saveToStorage = (key, data) => {
            localStorage.setItem(key, JSON.stringify(data));
        };

        const loadFromStorage = (key, defaultValue) => {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultValue;
            } catch {
                return defaultValue;
            }
        };

        // Dashboard Component
        const Dashboard = ({ patients, vitals, prescriptions }) => {
            const stats = {
                totalPatients: patients.length,
                malePatients: patients.filter(p => p.gender === 'Male').length,
                femalePatients: patients.filter(p => p.gender === 'Female').length,
                averageAge: patients.length > 0 ? Math.round(patients.reduce((sum, p) => sum + p.age, 0) / patients.length) : 0,
                recentVitals: vitals.filter(v => {
                    const recordDate = new Date(v.recordedAt);
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return recordDate > weekAgo;
                }).length,
                activePrescriptions: prescriptions.filter(p => p.status !== 'Completed').length,
            };

            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-number">{stats.totalPatients}</div>
                            <div className="stat-label">Total Patients</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{stats.averageAge}</div>
                            <div className="stat-label">Average Age</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{stats.recentVitals}</div>
                            <div className="stat-label">Recent Vitals (7 days)</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{stats.activePrescriptions}</div>
                            <div className="stat-label">Active Prescriptions</div>
                        </div>
                    </div>

                    <div className="card">
                        <h3 className="text-lg font-semibold mb-4">Patient Demographics</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 className="font-medium mb-3">Gender Distribution</h4>
                                <div className="space-y-2">
                                    <div className="flex justify-between">
                                        <span>Male</span>
                                        <span className="font-medium">{stats.malePatients}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Female</span>
                                        <span className="font-medium">{stats.femalePatients}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Other</span>
                                        <span className="font-medium">{stats.totalPatients - stats.malePatients - stats.femalePatients}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Patient Form Component
        const PatientForm = ({ patients, setPatients, selectedPatient, setSelectedPatient }) => {
            const [formData, setFormData] = useState({
                usn: '',
                fullName: '',
                age: '',
                gender: '',
                address: '',
                phone: '',
                email: ''
            });
            const [errors, setErrors] = useState({});

            useEffect(() => {
                if (selectedPatient) {
                    setFormData(selectedPatient);
                }
            }, [selectedPatient]);

            const validateForm = () => {
                const newErrors = {};
                if (!formData.usn) newErrors.usn = 'USN is required';
                if (!formData.fullName) newErrors.fullName = 'Full name is required';
                if (!formData.age || formData.age < 1) newErrors.age = 'Valid age is required';
                if (!formData.gender) newErrors.gender = 'Gender is required';
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!validateForm()) return;

                if (selectedPatient) {
                    // Update existing patient
                    const updatedPatients = patients.map(p => 
                        p.usn === selectedPatient.usn ? formData : p
                    );
                    setPatients(updatedPatients);
                    saveToStorage('patients', updatedPatients);
                } else {
                    // Add new patient
                    const existingPatient = patients.find(p => p.usn === formData.usn);
                    if (existingPatient) {
                        setErrors({ usn: 'USN already exists' });
                        return;
                    }
                    const newPatientData = { ...formData, age: parseInt(formData.age) };
                    const newPatients = [...patients, newPatientData];
                    setPatients(newPatients);
                    saveToStorage('patients', newPatients);
                    
                    // Sync with database
                    syncWithDatabase('patients', newPatientData);
                }

                // Reset form
                setFormData({
                    usn: '',
                    fullName: '',
                    age: '',
                    gender: '',
                    address: '',
                    phone: '',
                    email: ''
                });
                setSelectedPatient(null);
                setErrors({});
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (errors[name]) {
                    setErrors(prev => ({ ...prev, [name]: '' }));
                }
            };

            return (
                <div className="card">
                    <h2 className="text-xl font-semibold mb-4">
                        {selectedPatient ? 'Edit Patient' : 'Add New Patient'}
                    </h2>
                    
                    <form onSubmit={handleSubmit}>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">USN *</label>
                                <input
                                    type="text"
                                    name="usn"
                                    value={formData.usn}
                                    onChange={handleChange}
                                    className="form-input"
                                    disabled={selectedPatient}
                                />
                                {errors.usn && <p className="text-red-500 text-sm">{errors.usn}</p>}
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Full Name *</label>
                                <input
                                    type="text"
                                    name="fullName"
                                    value={formData.fullName}
                                    onChange={handleChange}
                                    className="form-input"
                                />
                                {errors.fullName && <p className="text-red-500 text-sm">{errors.fullName}</p>}
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Age *</label>
                                <input
                                    type="number"
                                    name="age"
                                    value={formData.age}
                                    onChange={handleChange}
                                    className="form-input"
                                />
                                {errors.age && <p className="text-red-500 text-sm">{errors.age}</p>}
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Gender *</label>
                                <select
                                    name="gender"
                                    value={formData.gender}
                                    onChange={handleChange}
                                    className="form-input"
                                >
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                                {errors.gender && <p className="text-red-500 text-sm">{errors.gender}</p>}
                            </div>

                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium mb-1">Address</label>
                                <input
                                    type="text"
                                    name="address"
                                    value={formData.address}
                                    onChange={handleChange}
                                    className="form-input"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Phone</label>
                                <input
                                    type="tel"
                                    name="phone"
                                    value={formData.phone}
                                    onChange={handleChange}
                                    className="form-input"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Email</label>
                                <input
                                    type="email"
                                    name="email"
                                    value={formData.email}
                                    onChange={handleChange}
                                    className="form-input"
                                />
                            </div>
                        </div>

                        <div className="flex gap-4 mt-6">
                            <button type="submit" className="btn btn-primary">
                                {selectedPatient ? 'Update Patient' : 'Add Patient'}
                            </button>
                            {selectedPatient && (
                                <button
                                    type="button"
                                    onClick={() => {
                                        setSelectedPatient(null);
                                        setFormData({
                                            usn: '',
                                            fullName: '',
                                            age: '',
                                            gender: '',
                                            address: '',
                                            phone: '',
                                            email: ''
                                        });
                                        setErrors({});
                                    }}
                                    className="btn btn-secondary"
                                >
                                    Cancel Edit
                                </button>
                            )}
                        </div>
                    </form>
                </div>
            );
        };

        // Vitals Form Component
        const VitalsForm = ({ patients, vitals, setVitals }) => {
            const [formData, setFormData] = useState({
                usn: '',
                weight: '',
                height: '',
                bloodPressureSystolic: '',
                bloodPressureDiastolic: '',
                heartRate: '',
                temperature: '',
                respiratoryRate: '',
                oxygenSaturation: '',
                notes: ''
            });
            const [errors, setErrors] = useState({});
            const [selectedPatientDetails, setSelectedPatientDetails] = useState(null);

            const validateForm = () => {
                const newErrors = {};
                if (!formData.usn) newErrors.usn = 'Please select a patient';
                if (!formData.weight || formData.weight <= 0) newErrors.weight = 'Valid weight is required';
                if (!formData.height || formData.height <= 0) newErrors.height = 'Valid height is required';
                if (!formData.bloodPressureSystolic || formData.bloodPressureSystolic <= 0) newErrors.bloodPressureSystolic = 'Valid systolic BP is required';
                if (!formData.bloodPressureDiastolic || formData.bloodPressureDiastolic <= 0) newErrors.bloodPressureDiastolic = 'Valid diastolic BP is required';
                if (!formData.heartRate || formData.heartRate <= 0) newErrors.heartRate = 'Valid heart rate is required';
                if (!formData.temperature || formData.temperature <= 0) newErrors.temperature = 'Valid temperature is required';
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const calculateBMI = (weight, height) => {
                const heightInMeters = height / 100;
                return (weight / (heightInMeters * heightInMeters)).toFixed(1);
            };

            const getBMICategory = (bmi) => {
                if (bmi < 18.5) return { category: 'Underweight', color: 'text-blue-600' };
                if (bmi < 25) return { category: 'Normal', color: 'text-green-600' };
                if (bmi < 30) return { category: 'Overweight', color: 'text-yellow-600' };
                return { category: 'Obese', color: 'text-red-600' };
            };

            const getBloodPressureCategory = (systolic, diastolic) => {
                if (systolic < 120 && diastolic < 80) return { category: 'Normal', color: 'text-green-600' };
                if (systolic < 130 && diastolic < 80) return { category: 'Elevated', color: 'text-yellow-600' };
                if (systolic < 140 || diastolic < 90) return { category: 'Stage 1 Hypertension', color: 'text-orange-600' };
                return { category: 'Stage 2 Hypertension', color: 'text-red-600' };
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!validateForm()) return;

                const vitalRecord = {
                    id: Date.now().toString(),
                    usn: formData.usn,
                    patientName: selectedPatientDetails?.fullName || '',
                    weight: parseFloat(formData.weight),
                    height: parseFloat(formData.height),
                    bmi: calculateBMI(parseFloat(formData.weight), parseFloat(formData.height)),
                    bloodPressureSystolic: parseInt(formData.bloodPressureSystolic),
                    bloodPressureDiastolic: parseInt(formData.bloodPressureDiastolic),
                    heartRate: parseInt(formData.heartRate),
                    temperature: parseFloat(formData.temperature),
                    respiratoryRate: formData.respiratoryRate ? parseInt(formData.respiratoryRate) : null,
                    oxygenSaturation: formData.oxygenSaturation ? parseInt(formData.oxygenSaturation) : null,
                    notes: formData.notes,
                    recordedAt: new Date().toISOString(),
                    recordedBy: 'System User'
                };

                const newVitals = [...vitals, vitalRecord];
                setVitals(newVitals);
                saveToStorage('vitals', newVitals);

                // Sync with database
                const dbVitalData = {
                    usn: formData.usn,
                    weight: parseFloat(formData.weight),
                    height: parseFloat(formData.height),
                    bloodPressureSystolic: parseInt(formData.bloodPressureSystolic),
                    bloodPressureDiastolic: parseInt(formData.bloodPressureDiastolic),
                    heartRate: parseInt(formData.heartRate),
                    temperature: parseFloat(formData.temperature),
                    respiratoryRate: formData.respiratoryRate ? parseInt(formData.respiratoryRate) : null,
                    oxygenSaturation: formData.oxygenSaturation ? parseInt(formData.oxygenSaturation) : null,
                    notes: formData.notes
                };
                syncWithDatabase('vitals', dbVitalData);

                // Reset form
                setFormData({
                    usn: '',
                    weight: '',
                    height: '',
                    bloodPressureSystolic: '',
                    bloodPressureDiastolic: '',
                    heartRate: '',
                    temperature: '',
                    respiratoryRate: '',
                    oxygenSaturation: '',
                    notes: ''
                });
                setSelectedPatientDetails(null);
                setErrors({});
                alert('Vitals recorded successfully!');
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (errors[name]) {
                    setErrors(prev => ({ ...prev, [name]: '' }));
                }
            };

            const handlePatientSelect = (e) => {
                const usn = e.target.value;
                setFormData(prev => ({ ...prev, usn }));
                const patient = patients.find(p => p.usn === usn);
                setSelectedPatientDetails(patient);
                if (errors.usn) {
                    setErrors(prev => ({ ...prev, usn: '' }));
                }
            };

            const currentBMI = formData.weight && formData.height ? calculateBMI(parseFloat(formData.weight), parseFloat(formData.height)) : null;
            const bmiInfo = currentBMI ? getBMICategory(parseFloat(currentBMI)) : null;
            const bpInfo = formData.bloodPressureSystolic && formData.bloodPressureDiastolic ? 
                getBloodPressureCategory(parseInt(formData.bloodPressureSystolic), parseInt(formData.bloodPressureDiastolic)) : null;

            const patientVitals = selectedPatientDetails ? vitals.filter(v => v.usn === selectedPatientDetails.usn).slice(-5) : [];

            return (
                <div className="space-y-6">
                    <div className="card">
                        <h2 className="text-xl font-semibold mb-4">Record Patient Vitals</h2>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium mb-1">Select Patient *</label>
                                    <select
                                        name="usn"
                                        value={formData.usn}
                                        onChange={handlePatientSelect}
                                        className="form-input"
                                    >
                                        <option value="">Choose a patient...</option>
                                        {patients.map(patient => (
                                            <option key={patient.usn} value={patient.usn}>
                                                {patient.usn} - {patient.fullName} ({patient.age} years, {patient.gender})
                                            </option>
                                        ))}
                                    </select>
                                    {errors.usn && <p className="text-red-500 text-sm">{errors.usn}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Weight (kg) *</label>
                                    <input
                                        type="number"
                                        name="weight"
                                        value={formData.weight}
                                        onChange={handleChange}
                                        step="0.1"
                                        className="form-input"
                                        placeholder="70.5"
                                    />
                                    {errors.weight && <p className="text-red-500 text-sm">{errors.weight}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Height (cm) *</label>
                                    <input
                                        type="number"
                                        name="height"
                                        value={formData.height}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="175"
                                    />
                                    {errors.height && <p className="text-red-500 text-sm">{errors.height}</p>}
                                </div>

                                {currentBMI && (
                                    <div className="md:col-span-2 p-3 bg-gray-50 rounded">
                                        <div className="flex items-center justify-between">
                                            <span className="font-medium">BMI: {currentBMI}</span>
                                            <span className={`font-medium ${bmiInfo.color}`}>{bmiInfo.category}</span>
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium mb-1">Blood Pressure - Systolic (mmHg) *</label>
                                    <input
                                        type="number"
                                        name="bloodPressureSystolic"
                                        value={formData.bloodPressureSystolic}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="120"
                                    />
                                    {errors.bloodPressureSystolic && <p className="text-red-500 text-sm">{errors.bloodPressureSystolic}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Blood Pressure - Diastolic (mmHg) *</label>
                                    <input
                                        type="number"
                                        name="bloodPressureDiastolic"
                                        value={formData.bloodPressureDiastolic}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="80"
                                    />
                                    {errors.bloodPressureDiastolic && <p className="text-red-500 text-sm">{errors.bloodPressureDiastolic}</p>}
                                </div>

                                {bpInfo && (
                                    <div className="md:col-span-2 p-3 bg-gray-50 rounded">
                                        <div className="flex items-center justify-between">
                                            <span className="font-medium">Blood Pressure: {formData.bloodPressureSystolic}/{formData.bloodPressureDiastolic}</span>
                                            <span className={`font-medium ${bpInfo.color}`}>{bpInfo.category}</span>
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium mb-1">Heart Rate (bpm) *</label>
                                    <input
                                        type="number"
                                        name="heartRate"
                                        value={formData.heartRate}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="72"
                                    />
                                    {errors.heartRate && <p className="text-red-500 text-sm">{errors.heartRate}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Temperature (°C) *</label>
                                    <input
                                        type="number"
                                        name="temperature"
                                        value={formData.temperature}
                                        onChange={handleChange}
                                        step="0.1"
                                        className="form-input"
                                        placeholder="37.0"
                                    />
                                    {errors.temperature && <p className="text-red-500 text-sm">{errors.temperature}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Respiratory Rate (breaths/min)</label>
                                    <input
                                        type="number"
                                        name="respiratoryRate"
                                        value={formData.respiratoryRate}
                                        onChange={handleChange}
                                        className="form-input"
                                        placeholder="16"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Oxygen Saturation (%)</label>
                                    <input
                                        type="number"
                                        name="oxygenSaturation"
                                        value={formData.oxygenSaturation}
                                        onChange={handleChange}
                                        min="70"
                                        max="100"
                                        className="form-input"
                                        placeholder="98"
                                    />
                                </div>

                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium mb-1">Clinical Notes</label>
                                    <textarea
                                        name="notes"
                                        value={formData.notes}
                                        onChange={handleChange}
                                        rows="3"
                                        className="form-input"
                                        placeholder="Additional observations or notes..."
                                    />
                                </div>
                            </div>

                            <div className="mt-6">
                                <button type="submit" className="btn btn-primary">
                                    Record Vitals
                                </button>
                            </div>
                        </form>
                    </div>

                    {selectedPatientDetails && patientVitals.length > 0 && (
                        <div className="card">
                            <h3 className="text-lg font-semibold mb-4">Recent Vitals History for {selectedPatientDetails.fullName}</h3>
                            <div className="overflow-x-auto">
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Weight</th>
                                            <th>BMI</th>
                                            <th>BP</th>
                                            <th>Heart Rate</th>
                                            <th>Temperature</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {patientVitals.map((vital) => (
                                            <tr key={vital.id}>
                                                <td>{new Date(vital.recordedAt).toLocaleDateString()}</td>
                                                <td>{vital.weight} kg</td>
                                                <td>{vital.bmi}</td>
                                                <td>{vital.bloodPressureSystolic}/{vital.bloodPressureDiastolic}</td>
                                                <td>{vital.heartRate} bpm</td>
                                                <td>{vital.temperature}°C</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Prescription Form Component
        const PrescriptionForm = ({ patients, prescriptions, setPrescriptions }) => {
            const [formData, setFormData] = useState({
                usn: '',
                medications: [{ 
                    name: '', 
                    dosage: '', 
                    frequency: '', 
                    duration: '', 
                    instructions: '' 
                }],
                diagnosis: '',
                notes: '',
                followUpDate: ''
            });
            const [errors, setErrors] = useState({});
            const [selectedPatientDetails, setSelectedPatientDetails] = useState(null);

            const commonMedications = [
                'Paracetamol 500mg', 'Ibuprofen 400mg', 'Amoxicillin 500mg', 'Azithromycin 250mg',
                'Omeprazole 20mg', 'Metformin 500mg', 'Amlodipine 5mg', 'Atorvastatin 20mg',
                'Levothyroxine 50mcg', 'Aspirin 75mg', 'Ciprofloxacin 500mg', 'Prednisolone 5mg',
                'Salbutamol Inhaler', 'Insulin Glargine', 'Vitamin D3 1000IU', 'Iron Tablet',
                'Calcium Carbonate', 'Multivitamin', 'Cough Syrup', 'Antacid Tablet'
            ];

            const frequencies = ['Once daily', 'Twice daily', 'Three times daily', 'Four times daily', 'As needed', 'Before meals', 'After meals'];
            const durations = ['3 days', '5 days', '7 days', '10 days', '14 days', '1 month', '3 months', 'Ongoing'];

            const validateForm = () => {
                const newErrors = {};
                if (!formData.usn) newErrors.usn = 'Please select a patient';
                if (!formData.diagnosis.trim()) newErrors.diagnosis = 'Diagnosis is required';
                
                const hasValidMedication = formData.medications.some(med => 
                    med.name.trim() && med.dosage.trim() && med.frequency.trim()
                );
                if (!hasValidMedication) {
                    newErrors.medications = 'At least one complete medication is required';
                }

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!validateForm()) return;

                const prescriptionRecord = {
                    id: Date.now().toString(),
                    usn: formData.usn,
                    patientName: selectedPatientDetails?.fullName || '',
                    patientAge: selectedPatientDetails?.age || '',
                    patientGender: selectedPatientDetails?.gender || '',
                    diagnosis: formData.diagnosis,
                    medications: formData.medications.filter(med => 
                        med.name.trim() && med.dosage.trim() && med.frequency.trim()
                    ),
                    notes: formData.notes,
                    followUpDate: formData.followUpDate,
                    prescribedAt: new Date().toISOString(),
                    prescribedBy: 'Dr. System User',
                    status: 'Active'
                };

                const newPrescriptions = [...prescriptions, prescriptionRecord];
                setPrescriptions(newPrescriptions);
                saveToStorage('prescriptions', newPrescriptions);

                // Sync with database
                const dbPrescriptionData = {
                    usn: formData.usn,
                    diagnosis: formData.diagnosis,
                    medications: prescriptionRecord.medications,
                    notes: formData.notes,
                    followUpDate: formData.followUpDate
                };
                syncWithDatabase('prescriptions', dbPrescriptionData);

                // Reset form
                setFormData({
                    usn: '',
                    medications: [{ name: '', dosage: '', frequency: '', duration: '', instructions: '' }],
                    diagnosis: '',
                    notes: '',
                    followUpDate: ''
                });
                setSelectedPatientDetails(null);
                setErrors({});
                alert('Prescription created successfully!');
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (errors[name]) {
                    setErrors(prev => ({ ...prev, [name]: '' }));
                }
            };

            const handlePatientSelect = (e) => {
                const usn = e.target.value;
                setFormData(prev => ({ ...prev, usn }));
                const patient = patients.find(p => p.usn === usn);
                setSelectedPatientDetails(patient);
                if (errors.usn) {
                    setErrors(prev => ({ ...prev, usn: '' }));
                }
            };

            const handleMedicationChange = (index, field, value) => {
                const newMedications = [...formData.medications];
                newMedications[index][field] = value;
                setFormData(prev => ({ ...prev, medications: newMedications }));
                if (errors.medications) {
                    setErrors(prev => ({ ...prev, medications: '' }));
                }
            };

            const addMedication = () => {
                setFormData(prev => ({
                    ...prev,
                    medications: [...prev.medications, { name: '', dosage: '', frequency: '', duration: '', instructions: '' }]
                }));
            };

            const removeMedication = (index) => {
                setFormData(prev => ({
                    ...prev,
                    medications: prev.medications.filter((_, i) => i !== index)
                }));
            };

            const patientPrescriptions = selectedPatientDetails ? 
                prescriptions.filter(p => p.usn === selectedPatientDetails.usn).slice(-3) : [];

            return (
                <div className="space-y-6">
                    <div className="card">
                        <h2 className="text-xl font-semibold mb-4">Create Prescription</h2>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium mb-1">Select Patient *</label>
                                    <select
                                        name="usn"
                                        value={formData.usn}
                                        onChange={handlePatientSelect}
                                        className="form-input"
                                    >
                                        <option value="">Choose a patient...</option>
                                        {patients.map(patient => (
                                            <option key={patient.usn} value={patient.usn}>
                                                {patient.usn} - {patient.fullName} ({patient.age} years, {patient.gender})
                                            </option>
                                        ))}
                                    </select>
                                    {errors.usn && <p className="text-red-500 text-sm">{errors.usn}</p>}
                                </div>

                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium mb-1">Diagnosis *</label>
                                    <textarea
                                        name="diagnosis"
                                        value={formData.diagnosis}
                                        onChange={handleChange}
                                        rows="2"
                                        className="form-input"
                                        placeholder="Primary diagnosis or chief complaint..."
                                    />
                                    {errors.diagnosis && <p className="text-red-500 text-sm">{errors.diagnosis}</p>}
                                </div>
                            </div>

                            <div className="mt-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-medium">Medications</h3>
                                    <button
                                        type="button"
                                        onClick={addMedication}
                                        className="btn btn-secondary text-sm"
                                    >
                                        + Add Medication
                                    </button>
                                </div>
                                {errors.medications && <p className="text-red-500 text-sm mb-3">{errors.medications}</p>}

                                {formData.medications.map((medication, index) => (
                                    <div key={index} className="border rounded-lg p-4 mb-4 bg-gray-50">
                                        <div className="flex justify-between items-center mb-3">
                                            <h4 className="font-medium">Medication {index + 1}</h4>
                                            {formData.medications.length > 1 && (
                                                <button
                                                    type="button"
                                                    onClick={() => removeMedication(index)}
                                                    className="text-red-500 hover:text-red-700 text-sm"
                                                >
                                                    Remove
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Medication *</label>
                                                <select
                                                    value={medication.name}
                                                    onChange={(e) => handleMedicationChange(index, 'name', e.target.value)}
                                                    className="form-input"
                                                >
                                                    <option value="">Select medication...</option>
                                                    {commonMedications.map(med => (
                                                        <option key={med} value={med}>{med}</option>
                                                    ))}
                                                    <option value="custom">Custom (type below)</option>
                                                </select>
                                                {medication.name === 'custom' && (
                                                    <input
                                                        type="text"
                                                        placeholder="Enter custom medication..."
                                                        onChange={(e) => handleMedicationChange(index, 'name', e.target.value)}
                                                        className="form-input mt-1"
                                                    />
                                                )}
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium mb-1">Dosage *</label>
                                                <input
                                                    type="text"
                                                    value={medication.dosage}
                                                    onChange={(e) => handleMedicationChange(index, 'dosage', e.target.value)}
                                                    className="form-input"
                                                    placeholder="e.g., 1 tablet, 5ml"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium mb-1">Frequency *</label>
                                                <select
                                                    value={medication.frequency}
                                                    onChange={(e) => handleMedicationChange(index, 'frequency', e.target.value)}
                                                    className="form-input"
                                                >
                                                    <option value="">Select frequency...</option>
                                                    {frequencies.map(freq => (
                                                        <option key={freq} value={freq}>{freq}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium mb-1">Duration</label>
                                                <select
                                                    value={medication.duration}
                                                    onChange={(e) => handleMedicationChange(index, 'duration', e.target.value)}
                                                    className="form-input"
                                                >
                                                    <option value="">Select duration...</option>
                                                    {durations.map(dur => (
                                                        <option key={dur} value={dur}>{dur}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium mb-1">Instructions</label>
                                                <input
                                                    type="text"
                                                    value={medication.instructions}
                                                    onChange={(e) => handleMedicationChange(index, 'instructions', e.target.value)}
                                                    className="form-input"
                                                    placeholder="e.g., Take with food, Avoid alcohol"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Follow-up Date</label>
                                    <input
                                        type="date"
                                        name="followUpDate"
                                        value={formData.followUpDate}
                                        onChange={handleChange}
                                        className="form-input"
                                        min={new Date().toISOString().split('T')[0]}
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Additional Notes</label>
                                    <textarea
                                        name="notes"
                                        value={formData.notes}
                                        onChange={handleChange}
                                        rows="2"
                                        className="form-input"
                                        placeholder="Additional instructions or notes..."
                                    />
                                </div>
                            </div>

                            <div className="mt-6">
                                <button type="submit" className="btn btn-primary">
                                    Create Prescription
                                </button>
                            </div>
                        </form>
                    </div>

                    {selectedPatientDetails && patientPrescriptions.length > 0 && (
                        <div className="card">
                            <h3 className="text-lg font-semibold mb-4">Recent Prescriptions for {selectedPatientDetails.fullName}</h3>
                            <div className="space-y-4">
                                {patientPrescriptions.map((prescription) => (
                                    <div key={prescription.id} className="border rounded-lg p-4 bg-gray-50">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <div className="font-medium">{prescription.diagnosis}</div>
                                                <div className="text-sm text-gray-600">
                                                    {new Date(prescription.prescribedAt).toLocaleDateString()} - {prescription.prescribedBy}
                                                </div>
                                            </div>
                                            <span className={`badge ${prescription.status === 'Active' ? 'badge-green' : 'badge-blue'}`}>
                                                {prescription.status}
                                            </span>
                                        </div>
                                        <div className="text-sm">
                                            <strong>Medications:</strong> {prescription.medications.map(m => m.name).join(', ')}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Prescription Management Component
        const PrescriptionManagement = ({ patients, prescriptions, setPrescriptions }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [selectedPrescription, setSelectedPrescription] = useState(null);

            const filteredPrescriptions = prescriptions.filter(prescription => {
                const matchesSearch = prescription.patientName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    prescription.usn.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    prescription.diagnosis.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesStatus = statusFilter === 'all' || prescription.status.toLowerCase() === statusFilter.toLowerCase();
                return matchesSearch && matchesStatus;
            });

            const printPrescription = (prescription) => {
                const printWindow = window.open('', '_blank');
                const currentDate = new Date().toLocaleDateString();
                const currentTime = new Date().toLocaleTimeString();
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Prescription - ${prescription.patientName}</title>
                        <style>
                            @media print {
                                @page {
                                    margin: 1in;
                                    size: A4;
                                }
                                body { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.4; color: #000; }
                                .no-print { display: none; }
                            }
                            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                            .clinic-name { font-size: 24px; font-weight: bold; color: #2563eb; margin-bottom: 5px; }
                            .clinic-subtitle { font-size: 14px; color: #666; }
                            .prescription-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
                            .patient-info, .prescription-info { flex: 1; }
                            .patient-info { margin-right: 20px; }
                            .info-row { margin-bottom: 8px; }
                            .label { font-weight: bold; display: inline-block; width: 100px; }
                            .diagnosis { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; }
                            .medications { margin: 20px 0; }
                            .medication-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
                            .medication-name { font-weight: bold; font-size: 14px; color: #1e40af; }
                            .medication-details { margin-top: 5px; color: #555; }
                            .notes { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107; }
                            .footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center; font-size: 10px; color: #666; }
                            .signature-section { margin-top: 40px; text-align: right; }
                            .signature-line { border-bottom: 1px solid #333; width: 200px; display: inline-block; margin-bottom: 5px; }
                            .btn { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 10px 5px; }
                            .btn:hover { background: #0056b3; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="clinic-name">New Horizon Sanjeevani Clinic</div>
                            <div class="clinic-subtitle">Comprehensive Healthcare Services</div>
                        </div>

                        <div class="prescription-header">
                            <div class="patient-info">
                                <h3 style="margin-top: 0; color: #333;">Patient Information</h3>
                                <div class="info-row"><span class="label">Name:</span> ${prescription.patientName}</div>
                                <div class="info-row"><span class="label">USN:</span> ${prescription.usn}</div>
                                <div class="info-row"><span class="label">Age:</span> ${prescription.patientAge} years</div>
                                <div class="info-row"><span class="label">Gender:</span> ${prescription.patientGender}</div>
                            </div>
                            <div class="prescription-info">
                                <h3 style="margin-top: 0; color: #333;">Prescription Details</h3>
                                <div class="info-row"><span class="label">Date:</span> ${new Date(prescription.prescribedAt).toLocaleDateString()}</div>
                                <div class="info-row"><span class="label">Time:</span> ${new Date(prescription.prescribedAt).toLocaleTimeString()}</div>
                                <div class="info-row"><span class="label">Doctor:</span> ${prescription.prescribedBy}</div>
                                <div class="info-row"><span class="label">Rx ID:</span> RX-${prescription.id}</div>
                            </div>
                        </div>

                        <div class="diagnosis">
                            <strong>Diagnosis:</strong> ${prescription.diagnosis}
                        </div>

                        <div class="medications">
                            <h3 style="color: #333; margin-bottom: 15px;">Prescribed Medications</h3>
                            ${prescription.medications.map((med, index) => `
                                <div class="medication-item">
                                    <div class="medication-name">${index + 1}. ${med.name}</div>
                                    <div class="medication-details">
                                        <strong>Dosage:</strong> ${med.dosage} | 
                                        <strong>Frequency:</strong> ${med.frequency}
                                        ${med.duration ? ` | <strong>Duration:</strong> ${med.duration}` : ''}
                                    </div>
                                    ${med.instructions ? `<div style="margin-top: 5px; font-style: italic;">Instructions: ${med.instructions}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>

                        ${prescription.notes ? `
                            <div class="notes">
                                <strong>Additional Notes:</strong><br>
                                ${prescription.notes}
                            </div>
                        ` : ''}

                        ${prescription.followUpDate ? `
                            <div style="margin: 15px 0; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                                <strong>Follow-up Date:</strong> ${new Date(prescription.followUpDate).toLocaleDateString()}
                            </div>
                        ` : ''}

                        <div class="signature-section">
                            <div class="signature-line"></div><br>
                            <strong>${prescription.prescribedBy}</strong><br>
                            <small>Authorized Prescriber</small>
                        </div>

                        <div class="footer">
                            <p><strong>New Horizon Sanjeevani Clinic</strong></p>
                            <p>This prescription is computer generated and valid for the medications listed above.</p>
                            <p>Printed on: ${currentDate} at ${currentTime}</p>
                            <p style="margin-top: 10px;">© 2025 Hospital Management Information System - LeadOnyxApex LLP</p>
                        </div>

                        <div class="no-print" style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="window.print()">🖨️ Print Prescription</button>
                            <button class="btn" onclick="window.close()" style="background: #6c757d;">✕ Close</button>
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                // Auto-print after a short delay
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };

            const updatePrescriptionStatus = (prescriptionId, newStatus) => {
                const updatedPrescriptions = prescriptions.map(p => 
                    p.id === prescriptionId ? { ...p, status: newStatus } : p
                );
                setPrescriptions(updatedPrescriptions);
                saveToStorage('prescriptions', updatedPrescriptions);
            };

            return (
                <div className="card">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-semibold">Prescription Management</h2>
                        <div className="flex gap-4">
                            <select
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                className="form-input w-32"
                            >
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <input
                                type="text"
                                placeholder="Search prescriptions..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="form-input w-64"
                            />
                        </div>
                    </div>

                    {filteredPrescriptions.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">
                            {searchTerm || statusFilter !== 'all' ? 'No prescriptions found matching your criteria.' : 'No prescriptions created yet.'}
                        </p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Patient</th>
                                        <th>USN</th>
                                        <th>Diagnosis</th>
                                        <th>Medications</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredPrescriptions.map((prescription) => (
                                        <tr key={prescription.id}>
                                            <td>{new Date(prescription.prescribedAt).toLocaleDateString()}</td>
                                            <td>{prescription.patientName}</td>
                                            <td>{prescription.usn}</td>
                                            <td>{prescription.diagnosis}</td>
                                            <td>
                                                <div className="text-sm">
                                                    {prescription.medications.slice(0, 2).map(med => med.name).join(', ')}
                                                    {prescription.medications.length > 2 && `... (+${prescription.medications.length - 2} more)`}
                                                </div>
                                            </td>
                                            <td>
                                                <span className={`badge ${
                                                    prescription.status === 'Active' ? 'badge-green' : 
                                                    prescription.status === 'Completed' ? 'badge-blue' : 'badge-red'
                                                }`}>
                                                    {prescription.status}
                                                </span>
                                            </td>
                                            <td>
                                                <div className="flex gap-1">
                                                    <button
                                                        onClick={() => printPrescription(prescription)}
                                                        className="btn btn-primary text-xs"
                                                        title="Print Prescription"
                                                    >
                                                        🖨️ Print
                                                    </button>
                                                    {prescription.status === 'Active' && (
                                                        <button
                                                            onClick={() => updatePrescriptionStatus(prescription.id, 'Completed')}
                                                            className="btn btn-secondary text-xs"
                                                            title="Mark as Completed"
                                                        >
                                                            ✓ Complete
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // CSV Export Component
        const ExportData = ({ patients, vitals, prescriptions }) => {
            const downloadCSV = (data, filename) => {
                if (data.length === 0) {
                    alert('No data to export');
                    return;
                }

                const csvContent = [
                    Object.keys(data[0]).join(','),
                    ...data.map(row => Object.values(row).map(val => 
                        typeof val === 'string' && val.includes(',') ? `"${val}"` : val
                    ).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            const tryDatabaseExport = async (endpoint, fallbackData, filename) => {
                try {
                    const response = await fetch(`http://localhost:5000/api/export/${endpoint}`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        return true;
                    }
                } catch (error) {
                    console.warn('Database export failed, using local data:', error);
                }
                // Fallback to local data
                downloadCSV(fallbackData, filename);
                return false;
            };

            const exportPatients = () => {
                tryDatabaseExport('patients', patients, 'patients.csv');
            };

            const exportVitals = () => {
                tryDatabaseExport('vitals', vitals, 'vitals.csv');
            };

            const exportPrescriptions = () => {
                tryDatabaseExport('prescriptions', prescriptions, 'prescriptions.csv');
            };

            const exportAllData = () => {
                tryDatabaseExport('complete', getAllDataForExport(), 'complete_patient_data.csv');
            };

            const getAllDataForExport = () => {
                return patients.map(patient => {
                    const patientVitals = vitals.filter(v => v.usn === patient.usn);
                    const patientPrescriptions = prescriptions.filter(p => p.usn === patient.usn);
                    
                    return {
                        // Patient Info
                        usn: patient.usn,
                        fullName: patient.fullName,
                        age: patient.age,
                        gender: patient.gender,
                        address: patient.address || '',
                        phone: patient.phone || '',
                        email: patient.email || '',
                        
                        // Latest Vitals
                        latestWeight: patientVitals.length > 0 ? patientVitals[patientVitals.length - 1].weight : '',
                        latestHeight: patientVitals.length > 0 ? patientVitals[patientVitals.length - 1].height : '',
                        latestBMI: patientVitals.length > 0 ? patientVitals[patientVitals.length - 1].bmi : '',
                        latestBloodPressure: patientVitals.length > 0 ? `${patientVitals[patientVitals.length - 1].bloodPressureSystolic}/${patientVitals[patientVitals.length - 1].bloodPressureDiastolic}` : '',
                        latestHeartRate: patientVitals.length > 0 ? patientVitals[patientVitals.length - 1].heartRate : '',
                        latestTemperature: patientVitals.length > 0 ? patientVitals[patientVitals.length - 1].temperature : '',
                        
                        // Counts
                        totalVitalsRecords: patientVitals.length,
                        totalPrescriptions: patientPrescriptions.length,
                        activePrescriptions: patientPrescriptions.filter(p => p.status !== 'Completed').length
                    };
                });
            };

            return (
                <div className="card">
                    <h2 className="text-xl font-semibold mb-4">Export Data</h2>
                    
                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                        <div className="p-4 border rounded-lg">
                            <h3 className="font-medium mb-2">Patients</h3>
                            <p className="text-sm text-gray-600 mb-3">{patients.length} records</p>
                            <button 
                                onClick={exportPatients}
                                className="btn btn-primary w-full text-sm"
                                disabled={patients.length === 0}
                            >
                                Export Patients CSV
                            </button>
                        </div>

                        <div className="p-4 border rounded-lg">
                            <h3 className="font-medium mb-2">Vitals</h3>
                            <p className="text-sm text-gray-600 mb-3">{vitals.length} records</p>
                            <button 
                                onClick={exportVitals}
                                className="btn btn-primary w-full text-sm"
                                disabled={vitals.length === 0}
                            >
                                Export Vitals CSV
                            </button>
                        </div>

                        <div className="p-4 border rounded-lg">
                            <h3 className="font-medium mb-2">Prescriptions</h3>
                            <p className="text-sm text-gray-600 mb-3">{prescriptions.length} records</p>
                            <button 
                                onClick={exportPrescriptions}
                                className="btn btn-primary w-full text-sm"
                                disabled={prescriptions.length === 0}
                            >
                                Export Prescriptions CSV
                            </button>
                        </div>

                        <div className="p-4 border rounded-lg bg-blue-50">
                            <h3 className="font-medium mb-2">Complete Data</h3>
                            <p className="text-sm text-gray-600 mb-3">All patient info with latest vitals</p>
                            <button 
                                onClick={exportAllData}
                                className="btn btn-primary w-full text-sm"
                                disabled={patients.length === 0}
                            >
                                Export All Data CSV
                            </button>
                        </div>
                    </div>

                    <div className="mt-6 p-4 bg-gray-50 rounded">
                        <h4 className="font-medium mb-2">Export Information:</h4>
                        <ul className="text-sm text-gray-600 space-y-1">
                            <li>• <strong>Patients CSV:</strong> Basic patient information</li>
                            <li>• <strong>Vitals CSV:</strong> All recorded vital signs</li>
                            <li>• <strong>Prescriptions CSV:</strong> All prescription records</li>
                            <li>• <strong>Complete Data CSV:</strong> Comprehensive report with patient info + latest vitals + prescription counts</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // Patient List Component
        const PatientList = ({ patients, onEdit, onDelete }) => {
            const [searchTerm, setSearchTerm] = useState('');

            const filteredPatients = patients.filter(patient =>
                patient.fullName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                patient.usn.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="card">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-semibold">Patient List</h2>
                        <input
                            type="text"
                            placeholder="Search patients..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="form-input w-64"
                        />
                    </div>

                    {filteredPatients.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">
                            {searchTerm ? 'No patients found matching your search.' : 'No patients added yet.'}
                        </p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>USN</th>
                                        <th>Full Name</th>
                                        <th>Age</th>
                                        <th>Gender</th>
                                        <th>Phone</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredPatients.map((patient) => (
                                        <tr key={patient.usn}>
                                            <td>{patient.usn}</td>
                                            <td>{patient.fullName}</td>
                                            <td>{patient.age}</td>
                                            <td>
                                                <span className={`badge ${
                                                    patient.gender === 'Male' ? 'badge-blue' : 
                                                    patient.gender === 'Female' ? 'badge-red' : 'badge-green'
                                                }`}>
                                                    {patient.gender}
                                                </span>
                                            </td>
                                            <td>{patient.phone || 'N/A'}</td>
                                            <td>
                                                <button
                                                    onClick={() => onEdit(patient)}
                                                    className="btn btn-primary mr-2 text-sm"
                                                >
                                                    Edit
                                                </button>
                                                <button
                                                    onClick={() => onDelete(patient.usn)}
                                                    className="btn btn-secondary text-sm"
                                                >
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [patients, setPatients] = useState(() => loadFromStorage('patients', []));
            const [vitals, setVitals] = useState(() => loadFromStorage('vitals', []));
            const [prescriptions, setPrescriptions] = useState(() => loadFromStorage('prescriptions', []));
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [dbConnected, setDbConnected] = useState(false);

            // Check database connection
            useEffect(() => {
                const checkDatabase = async () => {
                    try {
                        await apiRequest('/api/health');
                        setDbConnected(true);
                    } catch {
                        setDbConnected(false);
                    }
                };
                
                checkDatabase();
                const interval = setInterval(checkDatabase, 30000); // Check every 30 seconds
                return () => clearInterval(interval);
            }, []);

            // Save to localStorage whenever data changes
            useEffect(() => {
                saveToStorage('patients', patients);
            }, [patients]);

            useEffect(() => {
                saveToStorage('vitals', vitals);
            }, [vitals]);

            useEffect(() => {
                saveToStorage('prescriptions', prescriptions);
            }, [prescriptions]);

            const handleDeletePatient = (usn) => {
                if (confirm('Are you sure you want to delete this patient? This will also remove all associated vitals and prescriptions.')) {
                    setPatients(prev => prev.filter(p => p.usn !== usn));
                    setVitals(prev => prev.filter(v => v.usn !== usn));
                    setPrescriptions(prev => prev.filter(r => r.usn !== usn));
                    
                    if (selectedPatient?.usn === usn) {
                        setSelectedPatient(null);
                    }
                }
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="gradient-bg text-white py-8 px-4">
                        <div className="container mx-auto max-w-6xl">
                            <h1 className="text-3xl md:text-4xl font-bold mb-2">
                                New Horizon Sanjeevani Clinic
                            </h1>
                            <p className="text-xl opacity-90">
                                Hospital Management Information System - Comprehensive Healthcare Services
                            </p>
                        </div>
                    </header>

                    {/* Navigation */}
                    <nav className="bg-white border-b px-4">
                        <div className="container mx-auto max-w-6xl">
                            <div className="flex space-x-0 overflow-x-auto">
                                <button
                                    className={`tab ${activeTab === 'dashboard' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('dashboard')}
                                >
                                    Dashboard
                                </button>
                                <button
                                    className={`tab ${activeTab === 'patients' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('patients')}
                                >
                                    Patients
                                </button>
                                <button
                                    className={`tab ${activeTab === 'vitals' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('vitals')}
                                >
                                    Vitals
                                </button>
                                <button
                                    className={`tab ${activeTab === 'prescriptions' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('prescriptions')}
                                >
                                    Prescriptions
                                </button>
                                <button
                                    className={`tab ${activeTab === 'prescription-mgmt' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('prescription-mgmt')}
                                >
                                    Rx Management
                                </button>
                                <button
                                    className={`tab ${activeTab === 'list' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('list')}
                                >
                                    Patient List
                                </button>
                                <button
                                    className={`tab ${activeTab === 'export' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('export')}
                                >
                                    Export Data
                                </button>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="container mx-auto max-w-6xl px-4 py-6">
                        <div className={`alert ${dbConnected ? 'alert-info' : 'alert-info'}`}>
                            <strong>{dbConnected ? 'Database Connected:' : 'Offline Mode:'}</strong> 
                            {dbConnected ? 
                                ' Data is being saved to the Flask database backend and locally.' :
                                ' Working with local data only. Start the Flask server for database integration.'
                            }
                        </div>

                        {activeTab === 'dashboard' && (
                            <Dashboard 
                                patients={patients} 
                                vitals={vitals} 
                                prescriptions={prescriptions} 
                            />
                        )}

                        {activeTab === 'patients' && (
                            <PatientForm
                                patients={patients}
                                setPatients={setPatients}
                                selectedPatient={selectedPatient}
                                setSelectedPatient={setSelectedPatient}
                            />
                        )}

                        {activeTab === 'vitals' && (
                            <VitalsForm
                                patients={patients}
                                vitals={vitals}
                                setVitals={setVitals}
                            />
                        )}

                        {activeTab === 'prescriptions' && (
                            <PrescriptionForm
                                patients={patients}
                                prescriptions={prescriptions}
                                setPrescriptions={setPrescriptions}
                            />
                        )}

                        {activeTab === 'prescription-mgmt' && (
                            <PrescriptionManagement
                                patients={patients}
                                prescriptions={prescriptions}
                                setPrescriptions={setPrescriptions}
                            />
                        )}

                        {activeTab === 'list' && (
                            <PatientList
                                patients={patients}
                                onEdit={setSelectedPatient}
                                onDelete={handleDeletePatient}
                            />
                        )}

                        {activeTab === 'export' && (
                            <ExportData
                                patients={patients}
                                vitals={vitals}
                                prescriptions={prescriptions}
                            />
                        )}
                    </main>

                    {/* Footer */}
                    <footer className="bg-gray-800 text-white py-6 px-4 mt-12">
                        <div className="container mx-auto max-w-6xl">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">New Horizon Sanjeevani Clinic</h3>
                                    <p className="text-gray-300 text-sm">
                                        Comprehensive Healthcare Services<br />
                                        Advanced Medical Management System
                                    </p>
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">System Features</h3>
                                    <ul className="text-gray-300 text-sm space-y-1">
                                        <li>• Patient Management</li>
                                        <li>• Vitals Monitoring</li>
                                        <li>• Prescription Management</li>
                                        <li>• Data Export & Analytics</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">Contact Information</h3>
                                    <p className="text-gray-300 text-sm">
                                        For technical support or<br />
                                        system customization requests,<br />
                                        please contact the administrator.
                                    </p>
                                </div>
                            </div>
                            <div className="border-t border-gray-700 mt-6 pt-6 text-center">
                                <p className="text-gray-400 text-sm">
                                    © 2025 <strong>Hospital Management Information System (HMIS)</strong> - LeadOnyx Apex LLP
                                </p>
                                <p className="text-gray-500 text-xs mt-1">
                                    All rights reserved. This system is designed for medical practice management.
                                </p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
